<style>
    :root{
        --row-fade-duration:.35s;
        --row-stagger-step:40ms;
        --row-stagger-group-size:8;
        --row-delay: 0ms;
        --donation-gift: #10b981;
    }
    @keyframes fadeInBoard{
        from{opacity:0; transform:translateY(10px)}
        to{opacity:1; transform:translateY(0)}
    }
    .fade-in-board{ animation: fadeInBoard .6s ease-in-out both; }
    .row-appear{
        opacity:0;
        transform:translateY(8px);
    }
    .row-appear.is-visible{
        opacity:1;
        transform:translateY(0);
        transition:
                opacity var(--row-fade-duration) ease,
                transform var(--row-fade-duration) ease;
        transition-delay: var(--row-delay, 0ms);
    }
    @media (prefers-reduced-motion: reduce){
        .fade-in-board{ animation:none !important }
        .row-appear,
        .row-appear.is-visible{ opacity:1; transform:none; transition:none !important }
    }
    .events-board {
        display: flex;
        align-items: stretch;
        background-color: var(--card-bg);
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        flex-grow: 1;
        margin: 0 auto;
    }
    .events-board table {
        flex-grow: 1;
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        align-self: flex-start;
        padding-bottom:5px;
    }
    .events-board thead th {
        background: rgba(0, 188, 212, 0.12);
        color: var(--primary-color);
        text-transform: uppercase;
        font-weight: 800;
        font-size: 0.95rem;
        letter-spacing: 1px;
        text-align: left;
        padding: 15px 20px;
    }
    .events-board td.col-avatar { padding-right: 8px; }
    .events-board td.event-message { padding-left: 0px; }
    .header-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
    }
    .view-all {
        text-decoration: none;
        color: var(--primary-color);
        opacity: 0.8;
        font-weight: 400;
        font-size: 0.85rem;
    }
    .view-all:hover { opacity: 1; text-decoration: underline; }
    .events-board tbody td {
        vertical-align: middle;
        padding: 0 20px;
        height: 40px;
        line-height: 30px;
    }
    .events-board table tr:nth-child(even) { background-color: rgba(240, 244, 248, 0.5); }
    .events-board table tbody tr {
        height: 30px;
        transition: transform 0.25s ease, box-shadow 0.25s ease, background-color 0.25s ease;
        cursor: default;
    }
    .events-board table tbody tr:hover {
        transform: scale(1.01);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        background-color: rgba(240, 244, 248, 0.8);
    }
    .col-avatar { width: 36px; }
    .avatar,.avatar-fallback {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        overflow: hidden;
        border: 2px solid var(--secondary-color, #ff4f87);
        box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        background: none;
    }
    .avatar { object-fit: cover; display: block; }
    .avatar-fallback {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #5a6b7b;
        font-weight: 800;
        font-size: 0.7rem;
        text-transform: uppercase;
        line-height: 24px;
    }
    .avatar-link { display: inline-flex; align-items: center; justify-content: center; cursor: pointer; }
    .athlete-td { display: flex; align-items: center; gap: 0.6rem; text-align: left; }
    .event-message a { color: var(--primary-color); text-decoration: underline; cursor: pointer; }
    .event-message { color: var(--dark-text-color); }
    .col-date { text-align: right; white-space: nowrap; color: #7a8a99; font-weight: 400; font-size: 0.8rem; opacity: 50% }
    .event-message{display:flex;align-items:center;gap:.35rem;flex-wrap:wrap}
    .event-message .athlete-name-text{
        color: var(--primary-color);
        text-decoration: none;
        cursor: default;
    }
    .name-and-rank{display:inline-flex;align-items:baseline}
    .event-message a.placement-link{ text-decoration:none }
    .event-message a.placement-link:hover,
    .event-message a.placement-link:focus{ text-decoration:none }
    .placement-link{margin-left:2px}
    @media (max-width:600px){
        .events-board thead th{font-size:.85rem;padding:10px 12px}
        .view-all{font-size:.75rem}
        .events-board tbody td{padding:6px 12px;height:auto;line-height:1.25}
        .events-board table tbody tr{height:auto}
        .col-avatar{width:28px}
        .avatar,.avatar-fallback{width:22px;height:22px;border-width:2px}
        .event-message{font-size:.95rem}
        .col-date{font-size:.72rem;opacity:.6;padding-left:6px}
    }
    @media (max-width:360px){
        .col-date{display:none}
    }
    .event-message a:hover,
    .event-message a:focus {
        color: var(--secondary-color, #ff4f87);
        text-decoration-color: var(--secondary-color, #ff4f87);
    }
    .avatar,
    .avatar-fallback {
        transition: transform .15s ease, box-shadow .15s ease;
        will-change: transform;
    }
    .avatar-link:hover .avatar,
    .avatar-link:focus .avatar,
    .avatar-link:hover .avatar-fallback,
    .avatar-link:focus .avatar-fallback {
        transform: scale(1.15);
        box-shadow: 0 2px 6px rgba(0,0,0,.16);
    }
    .event-message .rank-icon{ margin-left:.25rem; }
    .event-message .rank-badge{ display:inline-flex; align-items:baseline; gap:.15rem; }
    .event-message .rank-badge .rank-icon{ margin:0; }

    .avatar-disabled{display:inline-flex;align-items:center;justify-content:center;cursor:default}
    .avatar-disabled .avatar,.avatar-disabled .avatar-fallback{transition:none;transform:none;box-shadow:0 1px 3px rgba(0,0,0,.12)}
    .avatar-disabled:hover .avatar,.avatar-disabled:focus .avatar,
    .avatar-disabled:hover .avatar-fallback,.avatar-disabled:focus .avatar-fallback{transform:none;box-shadow:0 1px 3px rgba(0,0,0,.12)}

    .donation-amount{ color: var(--secondary-color, #ff4f87); }
    .donation-gift-avatar{
        --gift: var(--donation-gift, #10b981);
        width: 24px; height: 24px;
        border-radius: 50%;
        background: var(--gift);
        border: 2px solid var(--gift) !important;
        box-shadow: 0 1px 2px rgba(0,0,0,.06);
        display: grid;                 /* perfectly center contents */
        place-items: center;
        line-height: 0;                /* kill baseline alignment */
        box-sizing: content-box;
    }

    .donation-gift-avatar i{    
        color: #fff !important;
        display: block;                /* avoids inline font metrics */
        font-size: .95rem;
        line-height: 1;
    }
</style>

<div id="events-root" class="events-board fade-in-board">
    <table id="eventsTable">
        <thead>
        <tr>
            <th colspan="3">
                <div class="header-bar">
                    <span>Highlights</span>
                    <a class="view-all" id="eventsViewAll" href="/event-board/event-board.html" target="_top">View All</a>
                </div>
            </th>
        </tr>
        </thead>
        <tbody>
        <tr><td colspan="3">Loading…</td></tr>
        </tbody>
    </table>
</div>

<script>
    (function(){
        const EVENT_TYPE = { General: 0, Joined: 1, NewRank: 2, DonationReceived: 3 };

        function lowerKeyMap(o){const m={};Object.keys(o||{}).forEach(k=>m[k.toLowerCase()]=k);return m;}
        function slugifyLocal(s){return(s||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"").replace(/-+/g,"-");}
        function normalizeLinkId(id){return String(id||"").replace(/_/g,"-");}
        function esc(s){return String(s).replace(/[&<>"']/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));}
        function initialsFromName(n){const parts=String(n||"").trim().split(/[\s_-]+/).slice(0,2);return parts.map(p=>p.charAt(0)).join("").toUpperCase()||"?";}

        function startOfLocalDay(d){return new Date(d.getFullYear(),d.getMonth(),d.getDate());}
        function relativeDayLabel(iso){
            const dt=new Date(iso); if(isNaN(dt)) return "";
            const today=startOfLocalDay(new Date());
            const thatDay=startOfLocalDay(dt);
            if(thatDay>today) return 'Today <i class="fa fa-rocket"></i>';
            const years=today.getFullYear()-thatDay.getFullYear()-((today.getMonth()<thatDay.getMonth()||(today.getMonth()===thatDay.getMonth()&&today.getDate()<thatDay.getDate()))?1:0);
            if(years>=1) return years===1?'1 year ago <i class="fa fa-rocket"></i>':`${years} years ago <i class="fa fa-rocket"></i>`;
            const months=(today.getFullYear()*12+today.getMonth())-(thatDay.getFullYear()*12+thatDay.getMonth())-(today.getDate()<thatDay.getDate()?1:0);
            if(months>=1) return months===1?'1 month ago <i class="fa fa-rocket"></i>':`${months} months ago <i class="fa fa-rocket"></i>`;
            const diffDays=Math.round((today-thatDay)/86400000);
            if(diffDays<=0) return 'Today <i class="fa fa-rocket"></i>';
            if(diffDays===1) return 'Yesterday <i class="fa fa-rocket"></i>';
            return `${diffDays} days ago <i class="fa fa-rocket"></i>`;
        }
        function relativeDayLabelNoIcon(iso,{emptyIfToday=true}={}) {
            const dt=new Date(iso); if(isNaN(dt)) return "";
            const today=startOfLocalDay(new Date());
            const thatDay=startOfLocalDay(dt);
            if(thatDay>=today) return emptyIfToday?"" :"Today";
            const years=today.getFullYear()-thatDay.getFullYear()-((today.getMonth()<thatDay.getMonth()||(today.getMonth()===thatDay.getMonth()&&today.getDate()<thatDay.getDate()))?1:0);
            if(years>=1) return years===1?'1 year ago':`${years} years ago`;
            const months=(today.getFullYear()*12+today.getMonth())-(thatDay.getFullYear()*12+thatDay.getMonth())-(today.getDate()<thatDay.getDate()?1:0);
            if(months>=1) return months===1?'1 month ago':`${months} months ago`;
            const diffDays=Math.round((today-thatDay)/86400000);
            if(diffDays===1) return 'Yesterday';
            return `${diffDays} days ago`;
        }
        function formatListDate(iso,{separator=', '}={}){
            const d=new Date(iso); if(isNaN(d)) return '';
            const nowYear=new Date().getFullYear();
            const base=d.toLocaleDateString(undefined,{month:'short',day:'numeric'}).replace(/,/g,'');
            return d.getFullYear()===nowYear?base:`${base}${separator}${d.getFullYear()}`;
        }
        function ordinal(n){const s=["th","st","nd","rd"],v=n%100;return `${n}${s[(v-20)%10]||s[v]||s[0]}`;}
        function podiumIcon(n){
            if(n===1) return '<i class="fa-solid fa-crown rank-icon" style="color: gold;" title="1st place" aria-label="1st place"></i>';
            if(n===2) return '<i class="fa-solid fa-medal rank-icon" style="color: silver;" title="2nd place" aria-label="2nd place"></i>';
            if(n===3) return '<i class="fa-solid fa-award rank-icon" style="color: #cd7f32;" title="3rd place" aria-label="3rd place"></i>';
            return '';
        }
        function setViewAllVisible(show){const link=document.getElementById("eventsViewAll"); if(link) link.style.display=show?"":"none";}
        function parseLimit(val){ if(val===undefined||val===null||val==="")return null; const n=typeof val==="string"?parseInt(val,10):Number(val); return Number.isFinite(n)&&n>0?Math.floor(n):null; }
        function parseTimeVar(varName, fallbackMs){
            const v=getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
            if(!v) return fallbackMs;
            if(v.endsWith('ms')) return parseFloat(v);
            if(v.endsWith('s')) return parseFloat(v)*1000;
            const n=parseFloat(v); return Number.isFinite(n)?n:fallbackMs;
        }

        function buildAthleteIndex(athletes){
            const index=new Map();
            (athletes||[]).forEach(a=>{
                const map=lowerKeyMap(a||{});
                const slugKey=map["athleteslug"]||map["slug"]||map["key"]||map["id"];
                const rawSlug=slugKey?String(a[slugKey]).trim():"";
                if(!rawSlug) return;
                const canon=slugifyLocal(normalizeLinkId(rawSlug));
                index.set(canon, a);
            });
            return index;
        }
        function makeAthleteUrlFromSlug(slug){
            if(!slug) return "";
            return `/athlete/${encodeURIComponent(normalizeLinkId(slugifyLocal(slug)))}`;
        }
        function leaderboardUrl(rank){
            const base="/leaderboard/leaderboard.html";
            return Number.isFinite(rank)&&rank>0?`${base}#rank-${Math.floor(rank)}`:base;
        }
        function athleteName(a){
            if(!a) return "";
            const map=lowerKeyMap(a);
            const k=map["name"]||map["athletename"]||map["fullname"]||map["displayname"];
            return k?String(a[k]).trim():"";
        }
        function athletePic(a){
            if(!a) return "";
            const map=lowerKeyMap(a);
            const keys=["profilepic","profilepicture","profilepictureurl","image","avatar","photo","picture","profileimage","img","imageurl"];
            for(const k of keys){ if(map[k]){ const v=String(a[map[k]]).trim(); if(v) return v; } }
            return "";
        }
        function getCurrentPlacement(a){
            if(!a) return null;
            const map=lowerKeyMap(a);
            const k=map["currentplacement"];
            if(!k) return null;
            const v=Number(a[k]);
            if(!Number.isFinite(v)) return null;
            return Math.max(1,Math.floor(v));
        }

        function extractSlugs(text){
            const rx=/slug\[(.+?)\]/g;
            const out=[]; let m;
            while((m=rx.exec(String(text)))!==null){ out.push(m[1]); }
            return out;
        }
        function extractPrevSlug(text){
            const m=/prev\[(.+?)\]/.exec(String(text||""));
            return m?m[1]:null;
        }
        function extractRank(text){
            const m=/rank\[(\d+)\]/.exec(String(text||""));
            if(!m) return null;
            const n=parseInt(m[1],10);
            return Number.isFinite(n)&&n>0?n:null;
        }

        function renderTextWithSlugLinks(text, linkNames, athletesIndex, afterSlug){
            const s=String(text||"");
            const rx=/slug\[(.+?)\]/g;
            let out="", last=0, m;
            while((m=rx.exec(s))!==null){
                out += esc(s.slice(last, m.index));
                const raw=m[1];
                const key=slugifyLocal(normalizeLinkId(raw));
                const a=athletesIndex.get(key);
                const name=a?(athleteName(a)||raw):raw;
                const href=a?makeAthleteUrlFromSlug(raw):"";
                const piece=linkNames&&href?`<a href="${href}">${esc(name)}</a>`:`<span class="athlete-name-text">${esc(name)}</span>`;
                const extra=typeof afterSlug==="function"?afterSlug(key,a):"";
                out += `<span class="name-and-rank">${piece}${extra}</span>`;
                last=rx.lastIndex;
            }
            out += esc(s.slice(last));
            return out;
        }

        function toRows(rawEvents){
            return (rawEvents||[]).map(e=>{
                const map=lowerKeyMap(e||{});
                const type=Number(e[map["type"]]??0);
                const text=String(e[map["text"]]??"");
                const occurredAt=e[map["occurredat"]]??e[map["occurredAt"]]??e["OccurredAt"]??null;

                const slugTokens=extractSlugs(text).map(s=>slugifyLocal(normalizeLinkId(s)));
                const primarySlug=slugTokens[0]||null;

                const prevRaw=extractPrevSlug(text);
                const prevSlug=prevRaw?slugifyLocal(normalizeLinkId(prevRaw)):null;
                if(prevSlug) slugTokens.push(prevSlug);

                const rank = extractRank(text);
                const sats = (() => { const m = /sats\[(\d+)\]/.exec(text); return m ? parseInt(m[1], 10) : 0; })();
                return { type, text, occurredAt, slugs: slugTokens, primarySlug, prevSlug, rank, sats };
            });
        }

        // ---- NEW: helper to gate NewRank items to top-10 in the normal list
        function isTop10Rank(row, athletesIndex){
            if(row.type !== EVENT_TYPE.NewRank) return true;
            if (Number.isFinite(row.rank)) return row.rank <= 10;
            const a = row.primarySlug ? athletesIndex.get(row.primarySlug) : null;
            const placement = getCurrentPlacement(a);
            return Number.isFinite(placement) && placement <= 10;
        }
        // ----

        function applyVisibleNow(el){
            const prefersReduced=window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            const rect=el.getBoundingClientRect();
            const vw=window.innerWidth||document.documentElement.clientWidth;
            const vh=window.innerHeight||document.documentElement.clientHeight;
            const inView = rect.bottom>=0 && rect.right>=0 && rect.top<=vh && rect.left<=vw;
            if(inView){
                if(!prefersReduced){
                    const idx=Number(el.dataset.rowIndex||0);
                    const groupSize=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--row-stagger-group-size'))||8;
                    const stepMs=parseTimeVar('--row-stagger-step',40);
                    el.style.setProperty('--row-delay',`${(idx%groupSize)*stepMs}ms`);
                }
                el.classList.add('is-visible');
                if(rowObserver) rowObserver.unobserve(el);
            }
        }

        let rowObserver=null;
        function ensureRowObserver(){
            if(rowObserver) return rowObserver;
            const prefersReduced=window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            rowObserver=new IntersectionObserver((entries,io)=>{
                entries.forEach(entry=>{
                    const el=entry.target;
                    if(entry.isIntersecting){
                        if(!prefersReduced){
                            const idx=Number(el.dataset.rowIndex||0);
                            const groupSize=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--row-stagger-group-size'))||8;
                            const stepMs=parseTimeVar('--row-stagger-step',40);
                            el.style.setProperty('--row-delay',`${(idx%groupSize)*stepMs}ms`);
                        }
                        el.classList.add('is-visible');
                        io.unobserve(el);
                    }
                });
            },{
                root:null,
                rootMargin:'0px',
                threshold:0
            });
            return rowObserver;
        }

        function revealVisibleRowsImmediately(container){
            container.querySelectorAll('.row-appear:not(.is-visible)').forEach(applyVisibleNow);
        }

        function renderRows(rows, athletesIndex, linkNames){
            const tbody = document.querySelector("#eventsTable tbody");
            tbody.innerHTML = "";

            if (!Array.isArray(rows) || rows.length === 0){
                tbody.innerHTML = `<tr><td colspan="3">No events yet</td></tr>`;
                return;
            }

            const frag = document.createDocumentFragment();
            const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

            const afterNameWithCurrentRankFor = () => (slug, aObj) => {
                if (!aObj) return "";
                const placement = getCurrentPlacement(aObj);
                if (!placement) return "";
                const label = `(#${placement})`;
                return linkNames
                    ? `<a href="${leaderboardUrl(placement)}" class="placement-link" target="_top">${esc(label)}</a>`
                    : `<span class="placement-link">${esc(label)}</span>`;
            };

            rows.forEach((r, idx) => {
                const dateLabel = r.occurredAt ? formatListDate(r.occurredAt) : "";
                const rel = (r.type === EVENT_TYPE.Joined && r.occurredAt)
                    ? relativeDayLabel(r.occurredAt)
                    : "";

                const a = r.primarySlug ? athletesIndex.get(r.primarySlug) : null;
                const name = a ? (athleteName(a) || r.primarySlug) : (r.primarySlug || "");
                const url = r.primarySlug ? makeAthleteUrlFromSlug(r.primarySlug) : "";
                const img = a ? athletePic(a) : "";

                let avatarHtml = "";
                const clickableNewRankOrJoined = (r.type === EVENT_TYPE.Joined || r.type === EVENT_TYPE.NewRank) && r.primarySlug && linkNames;
                if (r.type === EVENT_TYPE.Joined || r.type === EVENT_TYPE.NewRank) {
                    if (img) {
                        avatarHtml = clickableNewRankOrJoined
                            ? `<a href="${url}" class="avatar-link" title="${esc(name)}" aria-label="${esc(name)}"><img class="avatar" src="${esc(img)}" alt="${esc(name)}" loading="lazy"></a>`
                            : `<span class="avatar-disabled" aria-label="${esc(name)}"><img class="avatar" src="${esc(img)}" alt="${esc(name)}" loading="lazy"></span>`;
                    } else {
                        const fallback = `<div class="avatar-fallback">${initialsFromName(name)}</div>`;
                        avatarHtml = clickableNewRankOrJoined
                            ? `<a href="${url}" class="avatar-link" title="${esc(name)}" aria-label="${esc(name)}">${fallback}</a>`
                            : `<span class="avatar-disabled" aria-label="${esc(name)}">${fallback}</span>`;
                    }
                } else if (r.type === EVENT_TYPE.DonationReceived) {
                    avatarHtml = `<div class="avatar-fallback donation-gift-avatar" title="Donation" aria-label="Donation"><i class="fa-solid fa-gift" aria-hidden="true"></i></div>`
                } else {
                    avatarHtml = `<div class="avatar-fallback" title="Event">★</div>`;
                }

                let msgHtml = "";
                if (r.type === EVENT_TYPE.NewRank && r.primarySlug) {
                    const taken = Number.isFinite(r.rank) ? r.rank : getCurrentPlacement(a);
                    const nameWithCurrentRank = renderTextWithSlugLinks(
                        `slug[${r.primarySlug}]`,
                        linkNames,
                        athletesIndex,
                        afterNameWithCurrentRankFor()
                    );

                    const takenText = Number.isFinite(taken) ? ordinal(taken) : "?";
                    const iconHtml  = Number.isFinite(taken) ? podiumIcon(taken) : "";
                    const takenHtml = Number.isFinite(taken)
                        ? `<span class="rank-badge"><strong style="color: var(--secondary-color, #ff4f87)">${esc(takenText)}</strong>${iconHtml}</span>`
                        : esc(takenText);

                    let prevHtml = "";
                    if (r.prevSlug) {
                        prevHtml = renderTextWithSlugLinks(
                            `slug[${r.prevSlug}]`,
                            linkNames,
                            athletesIndex,
                            afterNameWithCurrentRankFor()
                        );
                    }

                    msgHtml = prevHtml
                        ? `${nameWithCurrentRank} took the ${takenHtml} place from ${prevHtml}`
                        : `${nameWithCurrentRank} took the ${takenHtml} place`;
                } else if (r.type === EVENT_TYPE.DonationReceived) {
                    const amount = Number.isFinite(r.sats) ? r.sats : 0;
                    const btc = amount / 100000000;
                    const amountFormatted = new Intl.NumberFormat(undefined, { maximumFractionDigits: 8 }).format(btc);
                    msgHtml = `Donation of <strong class="donation-amount">${esc(amountFormatted)} BTC</strong> added to the prize pool`;
                } else {
                    const tokenHtml = renderTextWithSlugLinks(
                        r.text,
                        linkNames,
                        athletesIndex,
                        r.type === EVENT_TYPE.Joined ? afterNameWithCurrentRankFor() : null
                    );
                    msgHtml = r.type === EVENT_TYPE.Joined ? `${tokenHtml} joined ${rel}` : `${tokenHtml}`;
                }

                const tr = document.createElement("tr");
                tr.className = "row-appear";
                tr.dataset.rowIndex = String(idx);
                tr.innerHTML =
                    `<td class="col-avatar"><div class="athlete-td">${avatarHtml}</div></td>
             <td class="athlete-td event-message">${msgHtml}</td>
             <td class="col-date">${dateLabel}</td>`;
                frag.appendChild(tr);
            });

            tbody.appendChild(frag);

            if (!prefersReduced && rows.length){
                const io = ensureRowObserver();
                tbody.querySelectorAll(".row-appear").forEach(r => io.observe(r));
                requestAnimationFrame(() => revealVisibleRowsImmediately(tbody));
                window.addEventListener("resize", () => revealVisibleRowsImmediately(tbody), { passive: true });
            } else {
                tbody.querySelectorAll(".row-appear").forEach(r => r.classList.add("is-visible"));
            }
        }

        function normalizeIncomingAthleteId(id){
            if(id==null) return '';
            let s=String(id).trim();
            if(!s) return '';
            s=s.split('#')[0].split('?')[0];
            if(s.includes('/')) s=s.split('/').filter(Boolean).pop();
            return normalizeLinkId(slugifyLocal(s));
        }

        // call signature: loadEventsTable(maxRows=null, showViewAll=true, athleteId=null, linkNames=true)
        window.loadEventsTable=function(maxRows=null,showViewAll=true,athleteId=null,linkNames=true){
            setViewAllVisible(!!showViewAll);

            const eventsReq=fetch("/api/events",{headers:{accept:"application/json"}}).then(r=>r.ok?r.json():Promise.reject(r.status));
            const athletesReq=fetch("/api/data/athletes",{headers:{accept:"application/json"}}).then(r=>r.ok?r.json():Promise.reject(r.status));

            Promise.all([eventsReq,athletesReq]).then(([events,athletes])=>{
                const athletesIndex=buildAthleteIndex(athletes);
                let rows=toRows(Array.isArray(events)?events:[]);

                // Are we in athlete modal context?
                const target=normalizeIncomingAthleteId(athleteId);
                if(target){
                    // Athlete modal: keep only events related to this athlete (already done),
                    // and DO NOT gate NewRank by top-10.
                    rows=rows.filter(r=>r.slugs.includes(target));
                }else{
                    // Normal list: show all Joined, but gate NewRank to top-10 only.
                    rows=rows.filter(r=> r.type!==EVENT_TYPE.NewRank || isTop10Rank(r, athletesIndex));
                }

                // apply optional limit after filtering
                const n=parseLimit(maxRows);
                if(n!==null) rows=rows.slice(0,n);

                renderRows(rows,athletesIndex,!!linkNames);
            }).catch(()=>{
                const tbody=document.querySelector("#eventsTable tbody");
                if(tbody) tbody.innerHTML=`<tr><td colspan="3">Failed to load events</td></tr>`;
            });
        };

        document.addEventListener('DOMContentLoaded',()=>{
            const root=document.getElementById('events-root');
            if(root) root.classList.add('fade-in-board');
        });
    })();
</script>
