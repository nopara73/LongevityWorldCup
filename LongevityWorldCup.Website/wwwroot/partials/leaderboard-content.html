<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
<style>
    /* =========================
   1) Design tokens
   ========================= */
    :root{
        --portrait-size: 60px;          /* table portrait size */
        --portrait-hover-scale: 1.1;    /* table hover scale */
        --arrow-left: -15px;            /* base arrow position */
        --arrow-hover-shift: calc((var(--portrait-size) * (var(--portrait-hover-scale) - 1)) / 2);
        --arrow-cover-extra: 24px;      /* arrow width (20) + ~4px safety */
        /* Amateur (Pheno Age) tier styling only */
        --tier-amateur-bg: rgba(59, 130, 246, 0.06);
        --tier-amateur-bg-even: rgba(59, 130, 246, 0.11);
        --tier-amateur-border: 4px solid rgba(37, 99, 235, 0.45);
        --tier-amateur-hover: rgba(59, 130, 246, 0.12);
    }

    /* =========================
       2) Utilities / helpers
       ========================= */
    .visually-hidden{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
    .highlight{ background-color: rgba(255,255,0,.5); color:#000; }
    .fade-out{ opacity:0; transition:opacity .4s ease; }
    .no-results{ color:var(--primary-color); font-weight:bold; text-align:center; padding:1rem; font-size:1.2rem; }
    #comingSoon{ font-size:.5rem; font-weight:normal; }

    /* Common transition for table rows and podium items */
    .leaderboard table tbody tr, .podium-item{ transition:opacity .3s ease, transform .3s ease; }

    /* =========================
       3) Global layout / shell
       ========================= */
    .main-container{ display:flex; align-items:flex-start; }
    .content{ flex-grow:1; transition:margin-left .3s ease; }

    .leaderboard{
        display:flex; align-items:stretch; background-color:var(--card-bg);
        border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,.1); overflow:hidden; flex-grow:1;
    }

    /* Scope table styles to the leaderboard table only */
    .leaderboard > table{ flex-grow:1; width:auto; border-collapse:separate; border-spacing:0; align-self:flex-start; }

    .leaderboard td{ text-align:center; }

    /* Scoped header styles – do NOT affect the modal info table */
    .leaderboard table th{
        padding:1rem 1rem; text-align:center; background-color:rgba(0,188,212,.1);
        color:var(--primary-color); font-weight:700; text-transform:uppercase; font-size:.9rem; letter-spacing:1px;
    }
    .leaderboard table th:nth-child(2){ text-align:left; }
    .leaderboard table tr:nth-child(even){ background-color:rgba(240,244,248,.5); }

    /* Amateur (Pheno Age) tier – blueish hue; pro (Bortz) rows use default table styling */
    .leaderboard table tbody tr.tier-amateur{
        background-color: var(--tier-amateur-bg);
        border-left: var(--tier-amateur-border);
    }
    .leaderboard table tbody tr.tier-amateur:nth-child(even){
        background-color: var(--tier-amateur-bg-even);
    }
    .leaderboard table tbody tr.tier-amateur:hover{
        background-color: var(--tier-amateur-hover);
        box-shadow: 0 4px 10px rgba(37, 99, 235, 0.15);
    }
    .leaderboard table tbody tr.tier-separator{
        background: linear-gradient(90deg, rgba(240, 244, 248, 0.6), rgba(59, 130, 246, 0.12));
        border-left: none;
        cursor: default;
        pointer-events: none;
    }
    .leaderboard table tbody tr.tier-separator .tier-separator-link{ pointer-events: auto; }
    .leaderboard table tbody tr.tier-separator:hover{ transform: none; box-shadow: none; }
    .leaderboard table tbody tr.tier-separator .tier-separator-cell{
        padding: 0.5rem 1rem;
        text-align: left;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--primary-color);
        border-top: 1px solid rgba(0, 0, 0, 0.06);
        border-bottom: 1px solid rgba(0, 0, 0, 0.06);
    }
    .tier-separator-label{ display: inline-flex; align-items: center; gap: 0.35rem; }
    .tier-separator-cell .tier-separator-link{
        color: var(--primary-color);
        text-decoration: underline;
        cursor: pointer;
    }
    .tier-separator-cell .tier-separator-link:hover{ color: var(--secondary-color); }

    .leaderboard table tbody tr{ cursor:pointer; }
    .leaderboard table tbody tr:hover{ transform: scale(1.02); box-shadow:0 4px 10px rgba(0,0,0,.1); }

    /* Let the Rank column auto-size (override old 15px rule) */
    .leaderboard table th:nth-child(1){ width:auto; }

    /* Inner spacing: 17px left/right on all Rank cells while keeping text centered */
    .leaderboard table td.rank-td,
    .leaderboard table th:nth-child(1){
        padding-left:17px;
        padding-right:17px;
        text-align:center;
        white-space:nowrap;
    }

    /* =========================
       4) Sidebar & filters
       ========================= */
    .sidebar{
        position:relative; width:50px; padding:0; background:var(--card-bg); border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,.1);
        margin-right:.2rem; display:flex; flex-direction:column; align-items:center; transition:width .3s ease, padding .3s ease;
        overflow:hidden; flex-shrink:0;
    }
    .sidebar:hover:not(.button-collapsed), .sidebar.expanded{ width:auto; padding:1rem; align-items:flex-start; }
    .sidebar .filter-section{ display:none; }
    .sidebar:hover .filter-section, .sidebar.expanded .filter-section{ display:block; }

    .sidebar.partially-expanded{ width:80px; }
    .sidebar-toggle{
        background:var(--card-bg); border:2px solid var(--primary-color); border-radius:50%; width:40px; height:40px;
        display:flex; align-items:center; justify-content:center; cursor:pointer; transition:background-color .3s ease, transform .3s ease; margin-right:1rem;
    }
    .sidebar-toggle.active{ background:var(--primary-color); transform:scale(1); }
    .sidebar-toggle.active i{ color:var(--card-bg); }
    .sidebar-toggle:hover{ background:var(--primary-color); transform:scale(1.05); }
    .sidebar-toggle i{ color:var(--primary-color); font-size:1.5rem; transition:color .3s ease; }
    .sidebar-toggle:hover i{ color:var(--card-bg); }

    .sidebar-close{
        display:none; background:none; border:none; font-size:1.5rem; color:var(--primary-color); cursor:pointer;
        position:absolute; top:3px; right:3px; z-index:10; transition:background-color .3s ease, color .3s ease;
        width:40px; height:40px; border-radius:50%;
    }
    .sidebar.expanded .sidebar-close{ display:block; }
    .sidebar-close:hover{ background:var(--primary-color); color:var(--card-bg); transform:scale(1.1); }

    .collapsed-title{
        display:block; writing-mode:vertical-rl; transform:rotate(180deg); text-align:center; font-size:1.8rem; color:var(--primary-color);
        padding:15px 0; letter-spacing:1px; word-spacing:10px; font-family:'Orbitron', sans-serif;
        background:linear-gradient(45deg, var(--primary-color), var(--secondary-color)); background-size:200%;
        -webkit-background-clip:text; -webkit-text-fill-color:transparent; text-shadow:none; border-radius:5px;
    }
    .sidebar:hover .collapsed-title, .sidebar.expanded .collapsed-title{ display:none; }
    .sidebar:hover .sidebar-title, .sidebar.expanded .sidebar-title{ width:100%; }

    .sidebar-title{
        margin:0; padding:1rem 0; text-align:center; font-size:1.2rem; color:var(--primary-color);
        display:flex; align-items:center; justify-content:left; border-bottom:2px solid var(--primary-color);
    }
    .sidebar .sidebar-title .sidebar-icon{ display:inline-block; font-size:2rem; }
    .sidebar .sidebar-title .sidebar-title-text{ display:none; margin-left:.5rem; font-size:2rem; }
    .sidebar:hover .sidebar-title .sidebar-title-text,
    .sidebar.expanded .sidebar-title .sidebar-title-text{ display:inline-block; }

    .sidebar:hover ~ .content, .sidebar.expanded ~ .content{ margin-left:200px; }

    .filter-section{ margin-bottom:1.5rem; }
    .filter-section h3{ margin-bottom:.5rem; color:var(--secondary-color); font-size:1.2rem; }
    .filter-section ul{ list-style:none; padding:0; }
    .filter-section li{ margin-bottom:.5rem; }
    .filter-section label{ display:flex; align-items:center; cursor:pointer; color:#555; transition:color .2s; }
    .filter-section input[type="checkbox"]{ margin-right:.5rem; accent-color:var(--primary-color); }
    .filter-section label:hover{ color:var(--primary-color); }
    .filter-section input[type="checkbox"]:checked + label{ font-weight:bold; color:var(--secondary-color); }

    /* =========================
       5) Search & toolbar (search + view badges on one line on desktop)
       ========================= */
    .leaderboard-toolbar{
        display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between; gap:1rem; margin-bottom:1rem;
    }
    .leaderboard-toolbar .search-wrapper{ margin-bottom:0; }
    .leaderboard-toolbar .leaderboard-view-switcher{ margin-bottom:0; }
    @media (min-width: 769px){
        .leaderboard-toolbar{ flex-wrap:nowrap; }
    }
    .search-wrapper{ display:flex; justify-content:flex-end; margin-bottom:1rem; }
    .search-container{ position:relative; max-width:250px; width:100%; margin-right:.5rem; }
    #athleteSearch{
        width:100%; padding:.5rem 2.5rem .5rem 1rem; border:2px solid var(--primary-color); border-radius:25px; font-size:1rem;
        transition:border-color .3s ease; outline:none; box-sizing:border-box;
    }
    #athleteSearch:focus{ border-color:var(--secondary-color); }
    .search-icon{ position:absolute; right:1rem; top:50%; transform:translateY(-50%); color:var(--primary-color); font-size:1.2rem; pointer-events:none; z-index:2; }
    .clear-icon{
        position:absolute; right:3rem; top:50%; transform:translateY(-50%); color:var(--primary-color); font-size:1.2rem; cursor:pointer; z-index:2;
        opacity:0; visibility:hidden; transition:opacity .3s ease, visibility .3s ease;
    }
    .clear-icon.visible{ opacity:1; visibility:visible; }
    .clear-icon:hover{ color:var(--secondary-color); }

    /* =========================
       5b) Leaderboard view switcher (Bortz / Pheno) – optional toggles
       ========================= */
    .leaderboard-view-switcher{
        display:flex; align-items:center; gap:.5rem; margin-bottom:1rem; flex-wrap:wrap; margin-left:.5rem;
    }
    .leaderboard-view-switcher[role="tablist"]{ margin-left:.5rem; }
    .leaderboard-view-switcher .view-switcher-label{
        font-size:.8rem; font-weight:600; text-transform:uppercase; letter-spacing:.05em; color:#666; margin-right:.25rem;
    }
    .leaderboard-view-switcher .view-switcher-chips{
        display:inline-flex; align-items:stretch; background:rgba(0,0,0,.04); border:1px solid rgba(0,0,0,.08); border-radius:999px; padding:3px; gap:2px;
    }
    .leaderboard-view-switcher .view-badge{
        display:inline-flex; align-items:center; padding:.35rem .75rem; border-radius:999px;
        border:none; background:transparent; color:#555;
        font-size:.85rem; font-weight:600; cursor:pointer; transition:background .2s ease, color .2s ease, box-shadow .2s ease;
    }
    .leaderboard-view-switcher .view-badge:hover{
        background:rgba(0,188,212,.06); color:var(--primary-color);
    }
    .leaderboard-view-switcher input[name="leaderboardView"]{ position:absolute; width:1px; height:1px; margin:-1px; padding:0; overflow:hidden; clip:rect(0,0,0,0); border:0; }
    .leaderboard-view-switcher input[name="leaderboardView"]:checked + .view-badge{
        background:var(--card-bg); color:var(--primary-color); box-shadow:0 1px 3px rgba(0,0,0,.12);
        padding-right:.5rem;
    }
    .leaderboard-view-switcher input[name="leaderboardView"]:checked + .view-badge::after{
        content:'×'; margin-left:.35rem; font-size:1rem; line-height:1; opacity:.7; font-weight:400;
    }
    .leaderboard-view-switcher input[name="leaderboardView"]:checked + .view-badge:hover::after{
        opacity:1;
    }
    .leaderboard-view-switcher input[name="leaderboardView"]:focus-visible + .view-badge{ outline:2px solid var(--secondary-color); outline-offset:2px; }

    /* =========================
       6) Portraits & rank indicators
       ========================= */
    /* TABLE portrait (fixed 60x60) */
    .portrait{
        width: var(--portrait-size);
        height: var(--portrait-size);
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid var(--secondary-color);
        margin: .5rem 0;
        cursor: pointer;
        transition: transform .3s ease;
    }
    .portrait:hover{ transform: scale(var(--portrait-hover-scale)); }

    /* PODIUM portrait (bounded even if not wrapped) */
    .podium-item .podium-portrait{
        width:auto; height:40%; aspect-ratio:1 / 1; border-radius:50%; object-fit:cover;
        border:3px solid var(--secondary-color); margin:1rem 0; cursor:pointer; transition:transform .3s ease; will-change:transform;
        box-sizing:border-box; /* include border in the height */
    }
    .podium-item .podium-portrait:hover{ transform: scale(1.1); }

    /* When wrapped on podium: wrapper defines circle, img fills it */
    .podium-item .rank-change{ display:block; height:40%; aspect-ratio:1 / 1; margin:1rem 0; }
    .podium-item .rank-change img.podium-portrait{
        width:100%; height:100%; border-radius:50%; object-fit:cover; transition:transform .3s ease; box-sizing:border-box;
    }
    .podium-item .rank-change img.podium-portrait:hover{ transform: scale(1.1); }

    .podium .name-row {
        display: flex;
        align-items: center;
        gap: .25rem;
        max-width: 100%
    }
    .podium .name-row .athlete-name {
        flex: 1;
        min-width: 0;
        white-space: nowrap;
        line-height: 1.1
    }

    /* Rank-change wrapper */
    .rank-change{ position: relative; display: inline-block; z-index: 0; }
    .rank-change img{ display:block; position:relative; z-index:1; }

    /* Rings (green = rank-up only in table, blue = new athlete) */
    .rank-change.rank-up img.portrait{ border-color:#2ecc71; }     /* no green ring on podium */
    img.portrait.is-new,
    .rank-change img.portrait.is-new,
    img.podium-portrait.is-new{ border-color:#3B82F6; }

    /* Arrow + Star bubbles share the same geometry — GLOBAL */
    .rank-change .rank-arrow,
    .rank-change .new-bubble{
        position:absolute; z-index:-1; left:var(--arrow-left); top:50%; transform:translateY(-50%);
        width:20px; height:20px; border-radius:50% 0 0 50%;
        color: rgb(255 255 255 / 80%); display:flex; align-items:center; justify-content:center;
        font-size:12px; pointer-events:none; transition:left .3s ease;
    }
    /* Star icon size only (bubble size unchanged) */
    .rank-change .new-bubble { font-size: 10px; line-height: 1; }
    /* Individual colors */
    .rank-change .rank-arrow{ background:#2ecc71; }  /* green up arrow */
    .rank-change .new-bubble{ background:#3B82F6; }  /* blue star */
    /* Hover shift for both bubbles */
    .rank-change:hover .rank-arrow,
    .rank-change:hover .new-bubble,
    .rank-change img:hover + .rank-arrow,
    .rank-change img:hover + .new-bubble{
        left: calc(var(--arrow-left) + var(--arrow-cover-extra) + var(--arrow-hover-shift));
    }
    /* Never show bubbles on the podium */
    .podium .rank-arrow, .podium-item .rank-arrow{ display:none !important; }
    .podium .new-bubble, .podium-item .new-bubble{ display:none !important; }

    /* PRO badge overlay – table only (not on podium); white text, black frame */
    .portrait-wrapper{ position:relative; display:inline-block; }
    .pro-badge{
        display:none;
        position:absolute;
        right:2px; bottom:2px;
        padding:2px 6px;
        font-size:9px; font-weight:800; letter-spacing:.08em; text-transform:uppercase;
        color:#fff;
        text-shadow: 0 0 1px #000, 0 0 2px #000, 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
        background:linear-gradient(145deg, rgba(0,0,0,.78), rgba(0,0,0,.92));
        border:1px solid #000;
        border-radius:2px;
        box-shadow: 0 1px 3px rgba(0,0,0,.35);
        align-items:center; justify-content:center;
        pointer-events:none;
        z-index:2;
        line-height:1.2;
        transform:rotate(-8deg);
    }
    tr.tier-pro .pro-badge{ display:flex; }
    /* Hide PRO ribbon on leaderboard/podium; show only in modal when profile is opened */
    .leaderboard .pro-badge{ display:none !important; }
    .podium .pro-badge{ display:none !important; }
    @media (min-width: 768px){
        .pro-badge{ right:2px; bottom:8px; font-size:11px; padding:3px 8px; }
    }
    /* Modal: PRO ribbon on profile picture – on-image, scaled, premium look */
    #athlete-profile .pro-badge{ display:none; }
    /* Badge scales with portrait size (container); desktop cap at 2.25rem */
    #athlete-profile.is-pro .pro-badge{
        display:inline-flex;
        right:6%; bottom:-8%;
        font-size:2.25rem;
        font-size:min(2.25rem, 11cqw);
        font-weight:800;
        letter-spacing:0.12em;
        padding:0.4em 0.85em;
        color:#fff;
        text-shadow:0 1px 2px rgba(0,0,0,.6);
        background:linear-gradient(160deg, rgba(0,0,0,.85) 0%, rgba(0,0,0,.75) 100%);
        border:2px solid rgba(255,255,255,.2);
        border-radius:0.5em;
        box-shadow:0 2px 8px rgba(0,0,0,.4), inset 0 1px 0 rgba(255,255,255,.08);
        transform:rotate(-12deg);
        line-height:1.2;
        z-index:2;
        pointer-events:auto;
        user-select:none;
    }
    @media (min-width: 768px){
        #athlete-profile.is-pro .pro-badge{ bottom:-7%; }
    }

    /* =========================
       7) Podium cards
       ========================= */
    .podium{ display:flex; justify-content:center; align-items:flex-end; margin-bottom:2rem; }
    .podium-item{
        position:relative; text-align:center; padding:1rem; background:var(--card-bg); border-radius:15px;
        box-shadow:0 10px 30px rgba(0,0,0,.1); margin:0 1rem; display:flex; flex-direction:column; align-items:center;
        justify-content:flex-start; width:200px; min-height:230px; transition:opacity .3s ease, transform .3s ease; cursor:pointer;
    }
    .podium .podium-item:hover{
        transform: scale(1.05) !important; will-change: transform;
        transition: transform .3s ease-in-out, box-shadow .3s ease-in-out; box-shadow:0 10px 20px rgba(0,0,0,.2);
    }
    .podium-item.blurred{ filter: blur(5px); pointer-events:none; }
    .podium-item.first{ order:2; height:340px; }
    .podium-item.second{ order:1; height:320px; }
    .podium-item.third{ order:3; height:300px; }

    .podium-item-lower{
        position:absolute; bottom:0; width:100%; padding:10px 0; border-radius:0 0 15px 15px;
        display:flex; flex-direction:column; align-items:center; clip-path:polygon(0 30%, 100% 0, 100% 100%, 0% 100%);
        transition:clip-path .3s ease-in-out; pointer-events:auto; cursor:pointer;
    }
    .podium-item-lower:hover{ clip-path:polygon(0 0, 100% 0, 100% 100%, 0% 100%); }
    .podium-item.first .podium-item-lower{ background:#FFF9C4; }
    .podium-item.second .podium-item-lower{ background:#E0E0E0; }
    .podium-item.third .podium-item-lower{ background:#D9C3A3; }
    .prize-money{ font-weight:bold; font-size:2rem; color:#4caf50; margin-top:2px; }
    .btc-amount{ margin-top:1rem; font-weight:normal; font-size:.8rem; color:var(--dark-text-color); }

    .podium-rank{
        position:absolute; top:-6px; left:10%; transform:translateX(-50%); background:#fff;
        padding:2px; border-radius:50%; width:60px; height:60px; display:flex; justify-content:center; align-items:center;
        font-size:2rem; box-shadow:0 4px 8px rgba(0,0,0,.1);
    }

    /* =========================
       8) Table row bits
       ========================= */
    .rank{ font-weight:700; font-size:1.2rem; color:var(--primary-color); }
    .age-reduction{ font-weight:700; color:#4caf50; text-align:left; }
    .athlete-td{ display:flex; align-items:center; text-align:left; gap:.5rem; }

    .athlete-name{
        color:var(--primary-color); text-decoration:underline; text-align:left; cursor:pointer; transition:color .2s ease-in-out;
        display:inline-block; padding:.5rem .2rem .5rem .5rem; white-space:pre-wrap;
    }
    .athlete-name:hover{ color:var(--secondary-color); background-color:rgba(0,0,0,.05); border-radius:8px; font-size:1.1em; }
    .podium .athlete-name{ font-size:1.1rem; padding-bottom:.2rem; }

    .media-contact{
        color:rgba(255,64,129,.7); text-decoration:none; transition:color .2s ease-in-out; font-size:1.5rem; padding:.5rem; margin:10px 0;
    }
    .media-contact:hover{ color:var(--primary-color); }
    .media-contact i{ font-size:2rem; width:2rem; height:2rem; line-height:2rem; display:inline-block; text-align:center; vertical-align:middle; }

    .personal-link-icon{ color:var(--primary-color); font-size:1rem; text-decoration:none; transition:color .2s ease-in-out; margin-left:.2rem; }
    .personal-link-icon:first-of-type{ margin-left:0; }
    .personal-link-icon:hover{ color:var(--secondary-color); }

    .leaderboard table tbody tr{ scroll-margin-top:0; }
    .leaderboard table tbody tr:target{ background:rgba(255,255,0,.35); transition:background-color 1.2s ease; }

    /* =========================
       10) Modal
       ========================= */
    .modal{
        display:none; position:fixed; z-index:3; left:0; top:0; width:100%; height:100%;
        overflow:hidden; background-color:rgba(0,0,0,.4); backdrop-filter:blur(4px); -webkit-backdrop-filter:blur(4px);
    }
    .modal-content{
        background:#fefefe; margin:1% auto; padding:20px; border:none; width:80%; height:88%; max-width:900px;
        border-radius:15px; box-shadow:0 4px 6px rgba(0,0,0,.1); overflow-y:auto; max-height:90vh; animation:fadeIn .5s ease-out;
        -webkit-overflow-scrolling:touch; scroll-behavior:smooth; overscroll-behavior:contain;
        position:relative;
    }
    /* Remove border-radius on mobile immediately (before animation) */
    @media (max-width: 768px) {
        .modal-content{
            border-radius:0 !important;
        }
        .modal-content.guess-mode{
            border-radius:0 !important;
        }
    }
    @media (prefers-reduced-motion: reduce) {
        .modal-content{ scroll-behavior:auto; animation:none; }
    }
    
    /* Sticky header with athlete name */
    .modal-sticky-header{
        position:sticky; top:0; left:0; right:0; z-index:5;
        background:#fefefe; padding:0.75rem 1rem; margin:-20px -20px 1rem -20px;
        border-bottom:1px solid rgba(0,0,0,0.1); box-shadow:0 2px 4px rgba(0,0,0,0.05);
        display:none; align-items:center; justify-content:space-between;
        transition:opacity 0.2s ease, transform 0.2s ease;
    }
    .modal-sticky-header.visible{ display:flex; }
    /* Blur overlay above sticky header */
    .modal-sticky-header.visible::before{
        content:''; position:absolute; top:-40px; left:0; right:0; height:40px;
        background:linear-gradient(to bottom, rgba(254,254,254,0.8), rgba(254,254,254,0.95));
        backdrop-filter:blur(3px); -webkit-backdrop-filter:blur(3px);
        pointer-events:none; z-index:-1;
    }
    .modal-sticky-header .sticky-header-left{
        display:flex; align-items:center; gap:0.5rem; min-width:0; flex:1;
    }
    .modal-sticky-header .sticky-athlete-name{
        font-size:1.1rem; font-weight:600; color:var(--dark-text-color);
        white-space:nowrap; overflow:hidden; text-overflow:ellipsis; min-width:0;
    }
    .modal-sticky-header .sticky-pro-badge{
        display:none;
        flex-shrink:0;
        font-size:0.7rem; font-weight:800; letter-spacing:0.1em; text-transform:uppercase;
        padding:0.25em 0.5em;
        color:#fff;
        background:linear-gradient(160deg, rgba(0,0,0,.85) 0%, rgba(0,0,0,.75) 100%);
        border:1px solid rgba(255,255,255,.2);
        border-radius:4px;
        box-shadow:0 1px 3px rgba(0,0,0,.3);
        user-select:none;
    }
    .modal-sticky-header.is-pro .sticky-pro-badge{ display:inline-flex; }
    .modal-sticky-header .sticky-close-btn{
        background:none; border:none; font-size:1.5rem; color:#999;
        cursor:pointer; padding:0.5rem; margin-left:1rem; flex-shrink:0;
        line-height:1; min-width:44px; min-height:44px;
        border-radius:50%; transition:all 0.2s ease;
        display:flex; align-items:center; justify-content:center;
    }
    .modal-sticky-header .sticky-close-btn:hover{
        color:var(--dark-text-color);
        background:rgba(0,0,0,0.05);
        transform:scale(1.1);
    }
    .modal-sticky-header .sticky-close-btn:active{
        transform:scale(0.95);
        background:rgba(0,0,0,0.1);
    }
    .athlete-profile{ display:flex; flex-direction:column; align-items:center; text-align:center; }

    /* Modal portrait: wrapper defines picture bounds so PRO badge sits on the image */
    #athlete-profile .portrait-wrapper{
        position:relative;
        display:block;
        width:70%;
        aspect-ratio:1/1;
        max-width:320px;
        margin:0 auto;
        container-type:inline-size;
        container-name:portrait;
    }
    #modalProfilePic{
        position:absolute;
        inset:0;
        width:100%; height:100%;
        border-radius:50%;
        object-fit:cover;
        cursor:pointer;
        transition:transform .3s ease, border-color .3s ease;
    }
    #modalProfilePic:hover{ transform: scale(1.05); }

    .athlete-info {
        text-align: left;
        width: 100%;
        max-width: 600px;
        margin: 1.5rem auto;
        min-width: 0; /* allow shrinking inside flex so content doesn't overflow */
    }
    .athlete-info p{ margin:.3rem 0; }

    /* Athlete info — clean two-column table (labels right, values left); uniform row spacing */
    .athlete-info-table {
        width: 100%;
        max-width: 100%;
        margin: 0 auto;
        border-collapse: separate;
        border-spacing: 0.3rem 0;
        table-layout: fixed; /* prevents table from overflowing; columns share space */
    }
    .athlete-info-table th,
    .athlete-info-table td{
        text-align:left;
        padding: 0.35rem 0 0.35rem 0.5rem;
        min-width:0;
        overflow-wrap:break-word;
        word-break:break-word;
        background:none !important;
        border:0;
        font-weight:400;
        color: inherit !important;
        opacity: 1 !important;
        line-height: 1.25;
    }

    .athlete-info-table th{
        width: 38%; /* leaves room for values; long labels wrap */
        text-align:left;
        white-space:normal; /* wrap long labels so they never get cut off */
        padding: 0.35rem 0.5rem 0.35rem 0;
        font-weight:700;
        color:inherit !important;
        background:none !important;
        text-transform:none !important;
        letter-spacing:normal !important;
        border:0 !important;
        box-shadow:none !important;
    }
    .athlete-info-table td{
        text-align:left;
        padding: 0.35rem 0 0.35rem 0.5rem;
        min-width:0;
        overflow-wrap:break-word;
        word-break:break-word;
        background:none !important;
        border:0;
        font-weight:400;
        color: inherit !important;
        opacity: 1 !important;
        line-height: 1.25;
    }


    .athlete-info-table .unit{
        opacity: 1 !important;
        white-space: nowrap;
        margin-left: .25ch;
    }

    /* Visual break (horizontal line) — same row spacing as other rows */
    .athlete-info-divider-row td {
        padding: 0.35rem 0 0.35rem 0.5rem !important;
        vertical-align: middle;
        border: 0;
        line-height: 0;
    }
    .athlete-info-divider {
        display: block;
        height: 1px;
        min-width: 12rem;
        max-width: 100%;
        background: var(--border-color, rgba(0,0,0,.14));
        border: 0;
    }

    /* === FIX: Pace of Aging sor biztosan egy sorban === */
    #bortzPaceOfAgingContainer td{ white-space: nowrap; }
    #paceOfAgingContainer td{ white-space: nowrap; }


    #ageReduction,
    #ageReductionPercent,
    #lowestBortzAge,
    #bortzAgeReduction,
    #bortzAgeReductionPercent{ white-space: nowrap; }

    .athlete-links{ display:flex; align-items:center; flex-direction:column; gap:.5rem; }
    .athlete-links a{ display:flex; align-items:center; text-decoration:none; color:var(--primary-color); transition:color .2s ease-in-out; }
    .athlete-links a:hover{ color:var(--secondary-color); }

    /* Scroll progress indicator */
    .modal-scroll-progress{
        position:sticky; top:0; left:0; width:0%; height:3px; background:var(--primary-color);
        z-index:10; transition:width 0.1s ease-out; opacity:0; pointer-events:none;
        border-radius:0 2px 2px 0;
    }
    .modal-scroll-progress.visible{ opacity:1; }
    .modal-content{ position:relative; }

    /* =========================
       11) Proofs & enlarged overlay
       ========================= */
    .proofs-gallery{ display:flex; flex-direction:column; align-items:center; flex-wrap:wrap; gap:1rem; justify-content:center; padding:0; }
    .proof-item{ width:100%; height:auto; border-radius:10px; overflow:hidden; cursor:pointer; transition:transform .3s ease; }
    .proof-item:hover{ transform: scale(1.05); }
    .proof-item img{ width:100%; height:100%; object-fit:cover; }

    .enlarged-portrait{
        position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.85);
        display:flex; justify-content:center; align-items:center; z-index:1000; cursor:pointer;
        opacity:0; transform:scale(.95); transition:opacity .5s ease, transform .5s ease;
    }
    .enlarged-portrait.show{ opacity:1; transform:scale(1); filter:blur(0); }
    .enlarged-portrait .close-btn{
        position:absolute; top:20px; left:20px; font-size:1.8rem; color:rgba(255,255,255,.85); background:rgba(0,0,0,.6);
        width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:50%; cursor:pointer;
        transition:color .3s, background-color .3s, transform .2s; padding:0;
    }
    .enlarged-portrait .close-btn:hover{ color:var(--light-text-color); background:rgba(0,0,0,.9); transform:scale(1.1); }
    .enlarged-portrait img{ max-width:90%; max-height:90%; object-fit:contain; cursor:default; }

    /* =========================
       12) Links & animations / stamps
       ========================= */
    .league-link{ color:var(--primary-color); text-decoration:underline; transition:color .2s ease; }
    .league-link:hover{ color:var(--secondary-color); }

    .modal-link{ display:flex; align-items:center; gap:.5rem; font-size:1.2rem; color:var(--primary-color); text-decoration:none; transition:color .3s ease; }
    .modal-link:hover{ color:var(--secondary-color); }
    .modal-link i{ font-size:1.8rem; line-height:1; }

    .fade-in-element{ animation:fadeIn .6s ease-in-out; }

    /* Guess-My-Age stamps */
    .first-guess-stamp{
        display:inline-block; padding:.3rem .6rem; border:1px solid currentColor; border-radius:4px; background:transparent;
        letter-spacing:.5px; margin:.25rem 0; box-shadow:0 1px 2px rgba(0,0,0,.1); transition:transform .2s ease;
    }
    .primary-stamp{
        display:inline-block; padding:.3rem .6rem; border:1px solid var(--primary-color); border-radius:4px; background:transparent;
        letter-spacing:.5px; margin:.25rem 0; box-shadow:0 1px 2px rgba(0,0,0,.1); transition:transform .2s ease; color:var(--primary-color);
    }
    .golden-stamp{
        display:inline-block; padding:.3rem .6rem; border:1px solid #FFD700; border-radius:4px; background:#FFD700;
        letter-spacing:.5px; margin:.25rem 0; box-shadow:0 1px 2px rgba(0,0,0,.1); transition:transform .2s ease; color:#000;
    }

    @keyframes fadeIn{ from{ opacity:0; transform:translateY(10px);} to{ opacity:1; transform:translateY(0);} }
    @keyframes expandCircle{ from{ transform:scale(.5); opacity:0;} to{ transform:scale(1); opacity:1;} }
    @keyframes pop{ 0%{ transform:scale(0); opacity:0;} 100%{ transform:scale(1); opacity:1;} }

    /* Fail-safe: if AOS doesn't initialize, don't hide critical UI */
    .leaderboard [data-aos]:not(.aos-animate),
    .podium [data-aos]:not(.aos-animate),
    .search-wrapper [data-aos]:not(.aos-animate),
    .sidebar [data-aos]:not(.aos-animate) {
        opacity: 1 !important;
        transform: none !important;
    }

    /* =========================
       13) Mobile
       ========================= */
    @media (max-width: 768px){
        .content{
            padding-left:max(1rem, env(safe-area-inset-left));
            padding-right:max(1rem, env(safe-area-inset-right));
        }
        .leaderboard-toolbar{
            flex-direction:column; align-items:stretch; gap:.75rem; margin-top:1.25rem;
        }
        .leaderboard-view-switcher{
            margin-left:0; order:1;
        }
        .search-container{ max-width:100%; margin-top:0; }
        #athleteSearch{ padding:.5rem 2.5rem .5rem 1rem; font-size:1rem; }
        .search-icon{ right:1rem; }
        .clear-icon{ right:3rem; }
        .search-wrapper{ display:flex; align-items:center; flex:1; min-width:0; width:100%; order:2; }

        .sidebar-toggle{ align-self:center; height:40px; flex-shrink:0; }

        .main-container{ flex-direction:column; }
        .sidebar{
            width:100%; margin-right:0; margin-bottom:1rem; position:fixed; top:0; left:0; width:70%; max-width:300px; height:100%;
            background:var(--card-bg); z-index:999; box-shadow:0 2px 10px rgba(0,0,0,.2); overflow-y:auto; transform:translateX(-100%);
            transition:transform .3s ease-in-out;
        }
        .sidebar.expanded{ display:block; transform:translateX(0); }
        .content{ margin-left:0; }

        .podium{
            display:flex; flex-direction:row; justify-content:center; align-items:flex-end; gap:3rem; margin:0; padding:0; flex-wrap:wrap; width:100%;
        }
        .podium .athlete-name{ font-size:1.5rem; }
        .podium-item{ width:100%; }
        .podium-item.first{ order:1; }
        .podium-item.second{ order:2; }
        .podium-item.third{ order:3; }
        .podium-rank{ left:5%; }

        .leaderboard table{ width:100%; table-layout:fixed; }
        .leaderboard table th:last-child,
        .leaderboard table td:last-child{ padding-right:0.5rem; }
        .leaderboard table td .badge-section{ display:none; }
        .leaderboard table th{ font-size:.6rem; }
        .leaderboard table td{ font-size:.8rem; }

        /* table portraits smaller on mobile */
        .leaderboard .portrait{ width:40px; height:40px; }

        /* =========================
           Athlete info table — stacked layout so nothing is cut off
           ========================= */
        .athlete-info-table {
            font-size: 0.9rem;
            border-spacing: 0;
            table-layout: auto;
            display: block;
        }
        .athlete-info-table tbody {
            display: block;
        }
        .athlete-info-table tr {
            display: block;
            padding: 0.25rem 0;
        }
        .athlete-info-table tr.athlete-info-divider-row {
            padding: 0.25rem 0;
        }
        .athlete-info-table tr.athlete-info-divider-row td {
            padding: 0 !important;
        }
        .athlete-info-table th,
        .athlete-info-table td {
            display: block;
            width: 100%;
            padding: 0.08rem 0 0.12rem 0;
            white-space: normal;
            overflow-wrap: break-word;
            word-break: break-word;
            line-height: 1.25;
        }
        .athlete-info-table th {
            padding-bottom: 0.04rem;
            font-size: 0.85em;
            color: var(--secondary-color, #555);
        }
        .athlete-info-table td {
            padding-top: 0;
            padding-left: 0;
            margin: 0;
        }
        /* Keep label-to-content gap consistent: no extra space from links or inline content */
        .athlete-info-table td * {
            margin-top: 0;
            margin-bottom: 0;
        }
        .athlete-info-table td .league-link {
            display: inline;
            vertical-align: baseline;
        }
        /* Pace/age rows: allow wrapping on mobile instead of nowrap */
        #bortzPaceOfAgingContainer td,
        #paceOfAgingContainer td,
        #ageReduction,
        #ageReductionPercent,
        #lowestBortzAge,
        #bortzAgeReduction,
        #bortzAgeReductionPercent {
            white-space: normal;
        }

        /* Mobile modal improvements */
        .modal-content{
            width:95%; padding:15px; margin:0; max-height:100vh; height:100vh;
            border-radius:0 !important; /* Remove rounded corners on mobile immediately */
            padding-top:max(15px, env(safe-area-inset-top));
            padding-bottom:max(15px, env(safe-area-inset-bottom));
            padding-left:max(15px, env(safe-area-inset-left));
            padding-right:max(15px, env(safe-area-inset-right));
        }
        .modal-content.guess-mode{
            border-radius:0 !important; /* Also remove rounded corners in guess-mode on mobile */
        }
        #athlete-profile .portrait-wrapper{ width:50%; }
        .modal-scroll-progress{ height:2px; }
        
        /* Ensure minimum touch target sizes */
        .modal-content a, .modal-content button, .close{
            min-height:44px; min-width:44px;
            display:inline-flex; align-items:center; justify-content:center;
        }
        
        /* Sticky header adjustments for mobile */
        .modal-sticky-header{
            margin:-15px -15px 1rem -15px; padding:0.75rem 1rem;
        }
        .modal-sticky-header.visible::before{
            top:-30px; height:30px;
        }
    }

    .athlete-info-table th > strong{
        display:inline-block;
        text-align:left;
    }

</style>

<div class="main-container">

    <div class="content">
        <div class="podium">
            <!-- Podium items will be dynamically inserted here -->
        </div>

        <div class="leaderboard-toolbar">
            <div class="leaderboard-view-switcher" role="tablist" aria-label="Leaderboard view">
                <span class="view-switcher-label">View</span>
                <div class="view-switcher-chips">
                    <input type="radio" name="leaderboardView" id="view-ultimate" value="ultimate" checked aria-label="Default view">
                    <input type="radio" name="leaderboardView" id="view-bortz" value="bortz">
                    <label for="view-bortz" class="view-badge" title="Rank by Bortz Age (biological age). Click again to show default ranking.">Bortz Age</label>
                    <input type="radio" name="leaderboardView" id="view-pheno" value="pheno">
                    <label for="view-pheno" class="view-badge" title="Rank by Pheno Age. Click again to show default ranking.">Pheno Age</label>
                </div>
            </div>
            <div class="search-wrapper">
                <div class="search-container" data-aos="fade" data-aos-duration="700" data-aos-delay="700">
                    <label for="athleteSearch" class="visually-hidden">Search athletes</label>
                    <input type="text" id="athleteSearch" placeholder="Search athlete..." aria-label="Search athletes">
                    <span class="search-icon"><i class="fa fa-search"></i></span>
                    <span class="clear-icon" tabindex="0" role="button" aria-label="Clear search">
                        <i class="fa fa-times"></i>
                    </span>
                </div>
                <button class="sidebar-toggle" aria-label="Toggle sidebar" title="Show leagues" data-aos="fade" data-aos-duration="700" data-aos-delay="650">
                    <i class="fa fa-sliders-h"></i>
                </button>
            </div>
        </div>

        <div class="leaderboard">
            <div class="sidebar">
                <button class="sidebar-close" aria-label="Hide leagues" title="Hide leagues"><i class="fa fa-chevron-left" style="font-size: 12px;"></i></button>
                <h2 class="sidebar-title" data-aos="fade" data-aos-duration="700" data-aos-delay="200">
                    <span class="sidebar-icon"><i class="fa fa-trophy"></i></span>
                    <span class="sidebar-title-text">Leagues</span>
                </h2>
                <div class="collapsed-title" data-aos="fade" data-aos-duration="700" data-aos-delay="200">ULTIMATE LEAGUE</div>
                <div class="filter-section" data-aos="fade" data-aos-duration="700" data-aos-delay="200">
                    <h3>Divisions</h3>
                    <ul></ul> <!-- This will be populated dynamically -->
                </div>

                <div class="filter-section" id="generation-filter-section">
                    <h3>Generations</h3>
                    <ul></ul> <!-- This will be populated dynamically -->
                </div>
                <div class="filter-section" id="exclusive-filter-section">
                    <h3>Exclusive</h3>
                    <ul></ul> <!-- This will be populated dynamically -->
                </div>
                <div class="filter-section" id="league-track-filter-section">
                    <h3>League</h3>
                    <ul></ul> <!-- This will be populated dynamically -->
                </div>
            </div>
            <table>
                <thead>
                <tr>
                    <th>Rank</th>
                    <th>Athlete</th>
                    <th>
                        Sponsor<br />
                        <a href="https://github.com/nopara73/LongevityWorldCup/issues/74" target="_blank" rel="noopener" style="color: #999; text-decoration: underline; cursor: pointer;"
                           onmouseover="this.style.color='var(--secondary-color)';"
                           onmouseout="this.style.color='#999';">
                                <span id="comingSoon">
                                    coming soon
                                </span>
                        </a>
                    </th>
                    <th>
                        <a href="https://github.com/nopara73/LongevityWorldCup/blob/master/LongevityWorldCup.Documentation/Ruleset.md#point-system" target="_blank" rel="noopener" style="color: var(--primary-color); text-decoration: underline; cursor: pointer;"
                           onmouseover="this.style.color='var(--secondary-color)';"
                           onmouseout="this.style.color='var(--primary-color)';">
                            Age reduction
                        </a>
                    </th>
                    <th>Media contact</th>
                </tr>
                </thead>
                <tbody>
                <!-- Table rows will be dynamically inserted here -->
                </tbody>
            </table>
        </div>

        <div id="detailsModal" class="modal">
            <div class="modal-content">
                <div class="modal-scroll-progress" id="modalScrollProgress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-label="Scroll progress"></div>
                <div class="modal-sticky-header" id="modalStickyHeader">
                    <div class="sticky-header-left">
                        <span class="sticky-athlete-name" id="stickyAthleteName"></span>
                        <span class="sticky-pro-badge" id="stickyProBadge" aria-label="Pro division" title="Professional longevity athlete">PRO</span>
                    </div>
                    <button class="sticky-close-btn" id="stickyCloseBtn" aria-label="Close athlete details">&times;</button>
                </div>
                <span id="closeAthleteDetailsModal" class="close">&times;</span>

                <div class="athlete-profile" id="athlete-profile">
                    <span class="portrait-wrapper">
                        <img id="modalProfilePic"
                             src=""
                             alt="Athlete profile picture"
                             class="illustration"
                             loading="lazy" />
                        <span class="pro-badge" aria-label="Pro division" title="Professional longevity athlete">PRO</span>
                    </span>
                    <h2 id="athleteName"></h2>

                    <!--GUESS-MY-AGE-->

                    <div id="modalBadgeStrip" class="modal-badge-strip"></div>
                    <p id="athleteBio"></p>
                    <!--AGE-VISUALIZATION-->
                    <div class="athlete-info" id="athlete-stats">
                        <table class="athlete-info-table">
                            <tbody>
                            <tr>
                                <th scope="row"><strong>Best rank:</strong></th>
                                <td><span id="athleteRank"></span></td>
                            </tr>
                            <tr>
                                <th scope="row"><strong>Division:</strong></th>
                                <td><span id="athleteDivision"></span></td>
                            </tr>
                            <tr>
                                <th scope="row"><strong>Generation:</strong></th>
                                <td><span id="athleteGeneration"></span></td>
                            </tr>
                            <tr>
                                <th scope="row"><strong>Flag:</strong></th>
                                <td><span id="athleteFlag"></span></td>
                            </tr>
                            <tr>
                                <th scope="row"><strong>Chronological age:</strong></th>
                                <td><span id="chronologicalAge"></span> <span class="unit">years old</span></td>
                            </tr>
                            <tr class="athlete-info-divider-row" role="presentation" aria-hidden="true">
                                <td colspan="2"><span class="athlete-info-divider"></span></td>
                            </tr>
                            <tr id="crowdAgeContainer">
                                <th scope="row"><strong>Crowd age:</strong></th>
                                <td>
                                    <span id="emptyCrowdAgeContainer">Crickets...</span>
                                    <span id="notEmptyCrowdAgeContainer" style="display:none;">
            <span id="crowdAge">0</span> <span class="unit">years</span>,
            <span id="crowdCount">0</span> guesses
          </span>
                                </td>
                            </tr>


                            <tr id="yourGuessContainer" style="display:none;">
                                <th scope="row"><strong>Your guess:</strong></th>
                                <td><span id="yourGuess"></span></td>
                            </tr>

                            <tr id="lowestBortzAgeContainer" style="display:none;">
                                <th scope="row"><strong>Lowest Bortz age:</strong></th>
                                <td><span id="lowestBortzAge"></span> <span class="unit">years</span></td>
                            </tr>

                            <tr>
                                <th scope="row"><strong>Lowest Pheno age:</strong></th>
                                <td><span id="lowestPhenoAge"></span> <span class="unit">years</span></td>
                            </tr>


                            <tr id="bortzPaceOfAgingContainer" title="Derived from the lowest biological age of the season" style="display:none;">
                                <th scope="row"><strong>Bortz pace of aging:</strong></th>
                                <td><span id="bortzPaceOfAging"></span> <span class="unit">years per year (pace rank: <span id="bortzPaceOfAgingRank"></span>)</span></td>
                            </tr>

                            <tr id="paceOfAgingContainer" title="Derived from the lowest biological age of the season" style="display:none;">
                                <th scope="row"><strong>Pheno pace of aging:</strong></th>
                                <td><span id="paceOfAging"></span> <span class="unit">years per year (pace rank: <span id="paceOfAgingRank"></span>)</span></td>
                            </tr>

                            <tr id="bortzAgeReductionContainer" title="Derived from the lowest biological age of the season" style="display:none;">
                                <th scope="row">
                                    <strong><span id="bortzAgeReductionAccelerationLabel">Bortz age reduction:</span></strong>
                                </th>
                                <td>
                                    <span id="bortzAgeReduction"></span> <span class="unit">years</span>
                                    (<span id="bortzAgeReductionPercent"></span><span class="unit">%</span>)
                                </td>
                            </tr>

                            <tr title="Derived from the lowest biological age of the season">
                                <th scope="row">
                                    <strong><span id="ageReductionAccelerationLabel">Pheno age reduction:</span></strong>
                                </th>
                                <td>
                                    <span id="ageReduction"></span> <span class="unit">years</span>
                                    (<span id="ageReductionPercent"></span><span class="unit">%</span>)
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="athlete-links">
                        <a id="personalLink" href="#" target="_blank" rel="noopener" class="modal-link" aria-label="Visit the athlete's personal page">
                            <i class="fa fa-link"></i> Personal page
                        </a>
                        <a id="mediaContact" href="#" target="_blank" rel="noopener" class="modal-link" aria-label="Contact the athlete">
                            <i class="fa fa-envelope"></i> Media contact
                        </a>
                    </div>
                </div>

                <div class="events-embed" style="margin-top:16px">
                    <iframe id="events-frame" title="Events" loading="lazy" style="width:100%;border:0;display:block;height:1px;"></iframe>
                </div>

                <div class="biomarkers-section" id="athlete-biomarkers">
                    <h3>Biomarkers over time</h3>
                    <canvas id="biomarkerChart" style="width: 100%; height: 300px;"></canvas>
                </div>

                <div class="proofs-section" id="athlete-proofs">
                    <h3>Proofs</h3>
                    <div class="proofs-gallery" id="proofsGallery">
                        <!-- Proof images will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<template id="enlargedPortraitTemplate">
    <div class="enlarged-portrait">
        <img src="" alt="" loading="lazy">
        <span class="close-btn">&times;</span>
    </div>
</template>

<template id="leaderboardRowTemplate">
    <tr>
        <td data-label="Rank" class="rank-td">
            <span class="rank"></span>
        </td>
        <td data-label="Athlete" class="athlete-td">
            <span class="portrait-wrapper">
                <img src="" alt="" class="portrait" loading="lazy">
                <span class="pro-badge" aria-label="Pro division" title="Professional longevity athlete">PRO</span>
            </span>
            <span class="athlete-name" title="View stats"></span>
            <div class="badge-section"></div>
        </td>
        <td data-label="Sponsor" class="sponsor-td"></td>
        <td data-label="Age reduction" class="age-reduction-td">
            <span class="age-reduction"></span>
        </td>
        <td data-label="Media contact" class="media-contact-td"></td>
    </tr>
</template>

<script>
    let athleteResults = [];
    let athletesOrderedByPace;
    let athletesOrderedByBortzPace;

    const currentSeasonStartDate = new Date(new Date().getFullYear(), 0, 1);

    markAthleteSkippedIfInURL();

    function markAthleteSkippedIfInURL() {
        const params = new URLSearchParams(window.location.search);
        let athleteSlug = null;

        if (params.has('athlete')) {
            athleteSlug = params.get('athlete');
        } else if (/^\/athlete\//.test(window.location.pathname)) {
            athleteSlug = window.location.pathname.split('/athlete/')[1].split('/')[0];
        }

        if (athleteSlug !== null) {
            if (params.get('guessmyage') != '1') {
                const allGuesses = JSON.parse(localStorage.getItem('gmaAllGuesses') || '{}');
                allGuesses[athleteSlug] = { value: null, skipped: true, first: false };
                localStorage.setItem('gmaAllGuesses', JSON.stringify(allGuesses));
            }
        }
    }


    // Prevent browser auto-restoring scroll on history nav (harmless if unsupported)
    try { if ('scrollRestoration' in history) history.scrollRestoration = 'manual'; } catch { }

    /* ------- ScrollGuard: block untrusted scrolls during anchor jump ------- */
    (function () {
        if (window.__scrollGuardInstalled) return;
        window.__scrollGuardInstalled = true;

        const ORIG = {
            scrollTo: window.scrollTo.bind(window),
            scrollBy: window.scrollBy.bind(window),
            elSIV: Element.prototype.scrollIntoView,
        };
        let guardUntil = 0;
        let anchorTarget = null;

        function blocked() { return Date.now() <= guardUntil; }

        // Public API
        window.ScrollGuard = {
            block(ms = 1600) { guardUntil = Date.now() + ms; },
            trustedScrollTo(opts) { ORIG.scrollTo(opts); },
            trustedScrollIntoView(el, opts) { ORIG.elSIV.call(el, opts); },
            setAnchorTarget(el) { anchorTarget = el || null; }
        };

        // Patch global scroll fns (no-op while blocked)
        window.scrollTo = function (...args) { if (blocked()) return; return ORIG.scrollTo(...args); };
        window.scrollBy = function (...args) { if (blocked()) return; return ORIG.scrollBy(...args); };
        Element.prototype.scrollIntoView = function (...args) {
            if (blocked()) return;
            return ORIG.elSIV.apply(this, args);
        };

        // If *anything* flips the hash during the guard, re-center the intended target
        window.addEventListener('hashchange', () => {
            if (blocked() && anchorTarget) {
                ORIG.elSIV.call(anchorTarget, { behavior: 'auto', block: 'start' });
            }
        }, true);
    })();

    /* ------- Scroll Performance Optimization ------- */
    (function() {
        if (window.__scrollOptimizerInstalled) return;
        window.__scrollOptimizerInstalled = true;

        // Throttle function using requestAnimationFrame
        function throttleRAF(func) {
            let rafId = null;
            return function(...args) {
                if (rafId === null) {
                    rafId = requestAnimationFrame(() => {
                        func.apply(this, args);
                        rafId = null;
                    });
                }
            };
        }

        // Scroll position memory
        const scrollMemory = {
            store: function(athleteSlug, scrollTop) {
                if (athleteSlug) {
                    sessionStorage.setItem(`modalScroll_${athleteSlug}`, String(scrollTop));
                }
            },
            retrieve: function(athleteSlug) {
                if (athleteSlug) {
                    const stored = sessionStorage.getItem(`modalScroll_${athleteSlug}`);
                    return stored ? parseInt(stored, 10) : null;
                }
                return null;
            },
            clear: function(athleteSlug) {
                if (athleteSlug) {
                    sessionStorage.removeItem(`modalScroll_${athleteSlug}`);
                }
            }
        };

        window.ModalScrollOptimizer = {
            throttleRAF: throttleRAF,
            memory: scrollMemory
        };
    })();

    function canAutoScroll() {
        if (window.ScrollGuard?.isBlocked?.()) return false;
        if (document.body.classList.contains('no-scroll')) return false;
        if (window.matchMedia?.('(prefers-reduced-motion: reduce)').matches) return false;
        return true;
    }

    let includePodiumGlobal = true
    let maxAthletesGlobal = Infinity;

    function isCompleteBiomarkerSet(set) {
        const values = [
            set.Wbc1000cellsuL,
            set.LymPc,
            set.McvFL,
            set.RdwPc,
            set.AlbGL,
            set.AlpUL,
            set.CreatUmolL,
            set.GluMmolL,
            set.CrpMgL
        ];
        return values.every(Number.isFinite) && set.CrpMgL > 0;
    }

    function isCompleteBortzBiomarkerSet(entry) {
        if (!entry || !entry.Date) return false;
        const values = [
            entry.AlbGL,
            entry.AlpUL,
            entry.UreaMmolL,
            entry.CholesterolMmolL,
            entry.CreatUmolL,
            entry.CystatinCMgL,
            entry.Hba1cMmolMol,
            entry.CrpMgL,
            entry.GgtUL,
            entry.Rbc10e12L,
            entry.McvFL,
            entry.RdwPc,
            entry.Wbc1000cellsuL,
            entry.MonocytePc,
            entry.NeutrophilPc,
            entry.LymPc,
            entry.AltUL,
            entry.ShbgNmolL,
            entry.VitaminDNmolL,
            entry.GluMmolL,
            entry.MchPg,
            entry.ApoA1GL
        ];
        return values.every(Number.isFinite) && entry.CrpMgL > 0;
    }

    function ensureRankChangeWrapper(imgEl) {
        let wrapper = imgEl.closest('.rank-change');
        if (!wrapper) {
            wrapper = document.createElement('span');
            wrapper.className = 'rank-change';
            imgEl.replaceWith(wrapper);
            wrapper.appendChild(imgEl);
        }
        return wrapper;
    }

    function applyRankUpUI(imgEl, placesUp) {
        const wrapper = ensureRankChangeWrapper(imgEl);

        // If "new" is active, never show the green arrow
        if (imgEl.classList.contains('is-new') || wrapper.querySelector('.new-bubble')) {
            wrapper.classList.remove('rank-up');
            const existing = wrapper.querySelector('.rank-arrow');
            if (existing) existing.remove();
            return;
        }

        // normalize placesUp → at least 1
        const places = Math.max(1, Number(placesUp || 1));
        const msg = places === 1
            ? 'Ranked up 1 place since last month'
            : `Ranked up ${places} places since last month`;

        wrapper.classList.add('rank-up');

        let arrow = wrapper.querySelector('.rank-arrow');
        if (!arrow) {
            arrow = document.createElement('span');
            arrow.className = 'rank-arrow';
            arrow.innerHTML = '<i class="fa fa-arrow-up" aria-hidden="true"></i>';
            wrapper.appendChild(arrow);
        }

        // Tooltip (on bubble *and* on the portrait for reliable hover)
        arrow.title = msg;
        arrow.setAttribute('aria-label', msg);
        imgEl.title = msg; // hovering the portrait shows the same tooltip
    }

    function applyNewUI(imgEl) {
        const wrapper = ensureRankChangeWrapper(imgEl);

        let bubble = wrapper.querySelector('.new-bubble');
        if (!bubble) {
            bubble = document.createElement('span');
            bubble.className = 'new-bubble';
            bubble.innerHTML = '<i class="fa fa-star" aria-hidden="true"></i>';
            wrapper.appendChild(bubble);
        }
        const msg = 'New athlete';
        bubble.title = msg;
        bubble.setAttribute('aria-label', msg);
        imgEl.title = msg; // show tooltip when hovering the portrait

        // Ensure any green bits are cleared
        wrapper.classList.remove('rank-up');
        const arrow = wrapper.querySelector('.rank-arrow');
        if (arrow) arrow.remove();
    }


    function LoadLeaderboard(includePodium = true, maxAthletes = Infinity) {
        includePodiumGlobal = includePodium;
        maxAthletesGlobal = maxAthletes;

        fetch('/api/data/athletes')
            .then(response => response.json())
            .then(athletes => {
                // Array to store athletes with their lowest PhenoAge and age reduction
                var viewAllAthletesBtn = document.getElementById('viewAllAthletesBtn');
                if (viewAllAthletesBtn) {
                    document.getElementById('viewAllAthletesBtn').textContent = `VIEW ALL ATHLETES (${athletes.length})`;
                }
                athleteResults = athletes.map(athlete => {
                    // Calculate the chronological age from the athlete's DateOfBirth
                    const dob = new Date(
                        athlete.DateOfBirth.Year,
                        athlete.DateOfBirth.Month - 1, // Months are zero-indexed in JavaScript Date
                        athlete.DateOfBirth.Day
                    );
                    const chronologicalAgeNow = window.calculateAgeAtDate(dob, new Date());

                    const crowdAge = athlete.CrowdAge;
                    const crowdCount = athlete.CrowdCount;
                    const completeBiomarkerSets = athlete.Biomarkers.filter(isCompleteBiomarkerSet);

                    // Get birth year and generation
                    const birthYear = athlete.DateOfBirth.Year;
                    const generation = window.getGeneration(birthYear);
                    const displayName = (athlete.DisplayName && athlete.DisplayName.trim()) ? athlete.DisplayName.trim() : athlete.Name;


                    // Create an object to store the best biomarker values from all sets
                    let bestBiomarkers = {
                        Wbc1000cellsuL: null, // White blood cell count (lower is better)
                        LymPc: null,          // Lymphocytes (higher is better)
                        McvFL: null,          // Mean corpuscular volume (lower is better)
                        RdwPc: null,          // Red cell distribution width (lower is better)
                        AlbGL: null,          // Albumin (higher is better)
                        AlpUL: null,          // Alkaline phosphatase (lower is better)
                        CreatUmolL: null,     // Creatinine (lower is better)
                        GluMmolL: null,       // Glucose (lower is better)
                        CrpMgL: null          // CRP (lower is better)
                    };

                    completeBiomarkerSets.forEach(biomarkerSet => {
                        // White blood cell count: positive coefficient means lower is better
                        if (bestBiomarkers.Wbc1000cellsuL === null || biomarkerSet.Wbc1000cellsuL < bestBiomarkers.Wbc1000cellsuL) {
                            bestBiomarkers.Wbc1000cellsuL = biomarkerSet.Wbc1000cellsuL;
                        }
                        // Lymphocytes: negative coefficient means higher is better
                        if (bestBiomarkers.LymPc === null || biomarkerSet.LymPc > bestBiomarkers.LymPc) {
                            bestBiomarkers.LymPc = biomarkerSet.LymPc;
                        }
                        // Mean corpuscular volume: positive coefficient means lower is better
                        if (bestBiomarkers.McvFL === null || biomarkerSet.McvFL < bestBiomarkers.McvFL) {
                            bestBiomarkers.McvFL = biomarkerSet.McvFL;
                        }
                        // Red cell distribution width: positive coefficient means lower is better
                        if (bestBiomarkers.RdwPc === null || biomarkerSet.RdwPc < bestBiomarkers.RdwPc) {
                            bestBiomarkers.RdwPc = biomarkerSet.RdwPc;
                        }
                        // Albumin: negative coefficient means higher is better
                        if (bestBiomarkers.AlbGL === null || biomarkerSet.AlbGL > bestBiomarkers.AlbGL) {
                            bestBiomarkers.AlbGL = biomarkerSet.AlbGL;
                        }
                        // Alkaline phosphatase: positive coefficient means lower is better
                        if (bestBiomarkers.AlpUL === null || biomarkerSet.AlpUL < bestBiomarkers.AlpUL) {
                            bestBiomarkers.AlpUL = biomarkerSet.AlpUL;
                        }
                        // Creatinine: positive coefficient means lower is better
                        if (bestBiomarkers.CreatUmolL === null || biomarkerSet.CreatUmolL < bestBiomarkers.CreatUmolL) {
                            bestBiomarkers.CreatUmolL = biomarkerSet.CreatUmolL;
                        }
                        // Glucose: positive coefficient means lower is better
                        if (bestBiomarkers.GluMmolL === null || biomarkerSet.GluMmolL < bestBiomarkers.GluMmolL) {
                            bestBiomarkers.GluMmolL = biomarkerSet.GluMmolL;
                        }
                        // CRP: positive coefficient means lower is better
                        if (bestBiomarkers.CrpMgL === null || biomarkerSet.CrpMgL < bestBiomarkers.CrpMgL) {
                            bestBiomarkers.CrpMgL = biomarkerSet.CrpMgL;
                        }
                    });

                    let phenoAgeDifference = 0;
                    // Only proceed if there are submissions.
                    if (completeBiomarkerSets.length > 0) {
                        const firstSubmission = completeBiomarkerSets[0];
                        const lastSubmission  = completeBiomarkerSets[completeBiomarkerSets.length - 1];

                        const ageAtFirst = window.calculateAgeAtDate(dob, new Date(firstSubmission.Date));
                        const ageAtLast  = window.calculateAgeAtDate(dob, new Date(lastSubmission.Date));

                        const firstSubmissionValues = [
                            ageAtFirst,
                            firstSubmission.AlbGL,
                            firstSubmission.CreatUmolL,
                            firstSubmission.GluMmolL,
                            Math.log(firstSubmission.CrpMgL / 10),
                            firstSubmission.Wbc1000cellsuL,
                            firstSubmission.LymPc,
                            firstSubmission.McvFL,
                            firstSubmission.RdwPc,
                            firstSubmission.AlpUL
                        ];

                        const lastSubmissionValues = [
                            ageAtLast,
                            lastSubmission.AlbGL,
                            lastSubmission.CreatUmolL,
                            lastSubmission.GluMmolL,
                            Math.log(lastSubmission.CrpMgL / 10),
                            lastSubmission.Wbc1000cellsuL,
                            lastSubmission.LymPc,
                            lastSubmission.McvFL,
                            lastSubmission.RdwPc,
                            lastSubmission.AlpUL
                        ];

                        const firstPhenoAge = window.PhenoAge.calculatePhenoAge(firstSubmissionValues);
                        const lastPhenoAge = window.PhenoAge.calculatePhenoAge(lastSubmissionValues);

                        phenoAgeDifference = lastPhenoAge - firstPhenoAge;
                    }

                    const submissionCount = completeBiomarkerSets.length;
                    // Prepare the biomarker values array in the order required for the PhenoAge calculation
                    const bestBiomarkerValues = [
                        bestBiomarkers.AlbGL, bestBiomarkers.CreatUmolL, bestBiomarkers.GluMmolL,
                        bestBiomarkers.CrpMgL, bestBiomarkers.Wbc1000cellsuL, bestBiomarkers.LymPc,
                        bestBiomarkers.McvFL, bestBiomarkers.RdwPc, bestBiomarkers.AlpUL
                    ].every(Number.isFinite) && bestBiomarkers.CrpMgL > 0
                        ? [
                            chronologicalAgeNow,
                            bestBiomarkers.AlbGL,
                            bestBiomarkers.CreatUmolL,
                            bestBiomarkers.GluMmolL,
                            Math.log(bestBiomarkers.CrpMgL / 10),
                            bestBiomarkers.Wbc1000cellsuL,
                            bestBiomarkers.LymPc,
                            bestBiomarkers.McvFL,
                            bestBiomarkers.RdwPc,
                            bestBiomarkers.AlpUL
                        ]
                        : null;

                    // Compute the actually lowest PhenoAge across real submissions
                    let lowestPhenoAge = Infinity;
                    let valuesForLowestPhenoAge = null;

                    athlete.Biomarkers.forEach(entry => {
                        const entryDate = new Date(entry.Date);
                        const ageAtEntry = window.calculateAgeAtDate(dob, entryDate);

                        const candidateValues = [
                            ageAtEntry,
                            entry.AlbGL,
                            entry.CreatUmolL,
                            entry.GluMmolL,
                            Math.log(entry.CrpMgL / 10),
                            entry.Wbc1000cellsuL,
                            entry.LymPc,
                            entry.McvFL,
                            entry.RdwPc,
                            entry.AlpUL
                        ];

                        // Only consider submissions with complete numeric data
                        if (candidateValues.every(Number.isFinite)) {
                            const ph = window.PhenoAge.calculatePhenoAge(candidateValues);
                            if (ph < lowestPhenoAge) {
                                lowestPhenoAge = ph;
                                valuesForLowestPhenoAge = candidateValues;
                            }
                        }
                    });

                    const chronoAtLowestPhenoAge =
                        Number.isFinite(lowestPhenoAge) && valuesForLowestPhenoAge
                            ? valuesForLowestPhenoAge[0]
                            : chronologicalAgeNow;

                    // Fallback: if nothing valid (should be rare), use the last submission
                    if (!Number.isFinite(lowestPhenoAge)) {
                        if (completeBiomarkerSets.length > 0) {
                            const last = completeBiomarkerSets[completeBiomarkerSets.length - 1];
                            const ageAtLast = window.calculateAgeAtDate(dob, new Date(last.Date));
                            valuesForLowestPhenoAge = [
                                ageAtLast,
                                last.AlbGL,
                                last.CreatUmolL,
                                last.GluMmolL,
                                Math.log(last.CrpMgL / 10),
                                last.Wbc1000cellsuL,
                                last.LymPc,
                                last.McvFL,
                                last.RdwPc,
                                last.AlpUL
                            ];
                            lowestPhenoAge = window.PhenoAge.calculatePhenoAge(valuesForLowestPhenoAge);
                        } else {
                            lowestPhenoAge = chronologicalAgeNow; // no complete data → neutral (no reduction/acceleration)
                        }
                    }

                    // Calculate the age reduction
                    const ageReduction = lowestPhenoAge - chronoAtLowestPhenoAge;
                    const biologicalAgePercent = lowestPhenoAge / chronoAtLowestPhenoAge;
                    const ageReductionPercent = (1 - biologicalAgePercent) * 100;

                    // Lowest Bortz Age and Bortz Age reduction (only when submissions have full Bortz biomarkers)
                    let lowestBortzAge = null;
                    let chronoAtLowestBortzAge = null;
                    let bortzAgeReduction = null;
                    let bortzAgeReductionPercent = null;
                    let bestBortzValues = null;
                    if (window.BortzAge && typeof window.BortzAge.calculateBortzAge === 'function') {
                        let bortzMin = Infinity;
                        let chronoAtBortzMin = null;
                        athlete.Biomarkers.forEach(entry => {
                            if (!isCompleteBortzBiomarkerSet(entry)) return;
                            const entryDate = new Date(entry.Date);
                            const ageAtEntry = window.calculateAgeAtDate(dob, entryDate);
                            const wbc = entry.Wbc1000cellsuL;
                            const monoCount = wbc * entry.MonocytePc / 100;
                            const neutCount = wbc * entry.NeutrophilPc / 100;
                            const bortzValues = [
                                ageAtEntry,
                                entry.AlbGL,
                                entry.AlpUL,
                                entry.UreaMmolL,
                                entry.CholesterolMmolL,
                                entry.CreatUmolL,
                                entry.CystatinCMgL,
                                entry.Hba1cMmolMol,
                                entry.CrpMgL,
                                entry.GgtUL,
                                entry.Rbc10e12L,
                                entry.McvFL,
                                entry.RdwPc,
                                monoCount,
                                neutCount,
                                entry.LymPc,
                                entry.AltUL,
                                entry.ShbgNmolL,
                                entry.VitaminDNmolL,
                                entry.GluMmolL,
                                entry.MchPg,
                                entry.ApoA1GL
                            ];
                            const bortzAge = window.BortzAge.calculateBortzAge(ageAtEntry, bortzValues);
                            if (Number.isFinite(bortzAge) && bortzAge < bortzMin) {
                                bortzMin = bortzAge;
                                chronoAtBortzMin = ageAtEntry;
                                bestBortzValues = bortzValues;
                            }
                        });
                        if (Number.isFinite(bortzMin) && chronoAtBortzMin != null) {
                            lowestBortzAge = bortzMin;
                            chronoAtLowestBortzAge = chronoAtBortzMin;
                            bortzAgeReduction = lowestBortzAge - chronoAtLowestBortzAge;
                            bortzAgeReductionPercent = (1 - lowestBortzAge / chronoAtLowestBortzAge) * 100;
                        }
                    }

                    // Placements: [yesterday, last week, last month, last year]
                    // Store last month's rank (index 2). If missing or not a number, use null.
                    const lastMonthRank =
                        Array.isArray(athlete.Placements) && Number.isFinite(athlete.Placements[2])
                            ? athlete.Placements[2]
                            : null;

                    // “Higher rank” = smaller number than last month
                    const rankImproved =
                        Number.isFinite(lastMonthRank) && typeof lastMonthRank === 'number'
                            ? (/* current rank is set a bit later */ true) // placeholder; we’ll re-evaluate after rank assignment
                            : false;
                                        
                    return {
                        name: athlete.Name,
                        displayName: displayName,
                        mediaContact: athlete.MediaContact,
                        dateOfBirth: dob,
                        chronologicalAge: chronologicalAgeNow,
                        crowdAge: crowdAge,
                        crowdCount: crowdCount,
                        lowestBortzAge: lowestBortzAge,
                        chronoAtLowestBortzAge: chronoAtLowestBortzAge,
                        bortzAgeReduction: bortzAgeReduction,
                        bortzAgeReductionPercent: bortzAgeReductionPercent,
                        lowestPhenoAge: lowestPhenoAge,
                        chronoAtLowestPhenoAge: chronoAtLowestPhenoAge,
                        ageReduction: ageReduction,
                        ageReductionPercent: ageReductionPercent,
                        bestBiomarkerValues: bestBiomarkerValues,
                        bestBortzValues: bestBortzValues,
                        personalLink: athlete.PersonalLink,
                        profilePic: athlete.ProfilePic,
                        division: athlete.Division,
                        generation: generation,
                        exclusiveLeague: athlete.ExclusiveLeague,
                        submissionCount: submissionCount,
                        phenoAgeDifference: phenoAgeDifference,
                        podcastLink: athlete.PodcastLink,
                        lastMonthRank: lastMonthRank,
                        rankImproved: rankImproved,
                        isNew: !!athlete.IsNew,
                        Badges: athlete.Badges || [],
                    };
                });

                generateDivisionFilters(athleteResults);
                generateGenerationFilters(athleteResults);
                generateExclusiveFilters(athleteResults);
                generateLeagueTrackFilters(athleteResults);

                // Sort the athletes by age reduction in ascending order
                athleteResults.sort(window.compareAthleteRank);

                // Assign ranks to each athlete based on the sorted order
                athleteResults.forEach((athlete, index) => { athlete.rank = index + 1; });

                athleteResults.forEach(a => {
                    a.rankImproved =
                        Number.isFinite(a.lastMonthRank) && a.rank < a.lastMonthRank;
                });

                // Initialize a 'ranks' object for each athlete to store ranks based on different criteria
                athleteResults.forEach(athlete => { athlete.ranks = {}; });

                // Assign ranks based on divisions
                const divisions = [...new Set(athleteResults.map(athlete => athlete.division))];
                divisions.forEach(division => {
                    const athletesInDivision = athleteResults.filter(athlete => athlete.division === division);
                    athletesInDivision.sort(window.compareAthleteRank);
                    athletesInDivision.forEach((athlete, index) => {
                        athlete.ranks[division] = index + 1;
                    });
                });

                // Assign ranks based on generations
                const generations = [...new Set(athleteResults.map(athlete => athlete.generation))];
                generations.forEach(generation => {
                    const athletesInGeneration = athleteResults.filter(athlete => athlete.generation === generation);
                    athletesInGeneration.sort(window.compareAthleteRank);
                    athletesInGeneration.forEach((athlete, index) => {
                        athlete.ranks[generation] = index + 1;
                    });
                });

                // Assign ranks based on combinations of division and generation
                divisions.forEach(division => {
                    generations.forEach(generation => {
                        const athletesInCombo = athleteResults.filter(
                            athlete => athlete.division === division && athlete.generation === generation
                        );
                        athletesInCombo.sort(window.compareAthleteRank);
                        athletesInCombo.forEach((athlete, index) => {
                            const key = `${generation}_${division}`;
                            athlete.ranks[key] = index + 1;
                        });
                    });
                });

                athletesOrderedByPace = _.orderBy(athleteResults, 'ageReductionPercent', 'desc');
                athletesOrderedByBortzPace = _.orderBy(
                    athleteResults.filter(a => a.lowestBortzAge != null && a.chronoAtLowestBortzAge != null && Number.isFinite(a.lowestBortzAge / a.chronoAtLowestBortzAge)),
                    a => a.lowestBortzAge / a.chronoAtLowestBortzAge,
                    'asc'
                );

                const podiumCount = includePodium ? 3 : 0;

                if (includePodium) {
                    // Fetch the total prize fund from the backend API and calculate prize money
                    fetch(`/api/bitcoin/total-received?address=${window.bitcoinDonationAddress}`)
                        .then(response => response.json())
                        .then(data => {
                            const totalReceivedSatoshis = data.totalReceivedSatoshis;
                            const totalReceivedBTC = totalReceivedSatoshis / 1e8;
                            const prizeFundBTC = totalReceivedBTC * 0.9; // 90% of total received

                            // Fetch current BTC to USD exchange rate
                            fetch(`/api/bitcoin/btcusd`)
                                .then(response => response.json())
                                .then(tickerData => {
                                    const btcToUsdRate = tickerData.btcToUsdRate;

                                    // Calculate prize moneys
                                    const firstPlaceBTC = prizeFundBTC * 0.6;
                                    const secondPlaceBTC = prizeFundBTC * 0.25;
                                    const thirdPlaceBTC = prizeFundBTC * 0.15;

                                    const firstPlaceUSD = firstPlaceBTC * btcToUsdRate;
                                    const secondPlaceUSD = secondPlaceBTC * btcToUsdRate;
                                    const thirdPlaceUSD = thirdPlaceBTC * btcToUsdRate;

                                    const prizeMoney = {
                                        1: { btc: firstPlaceBTC.toFixed(8) + " BTC", amount: "$" + firstPlaceUSD.toFixed(2) },
                                        2: { btc: secondPlaceBTC.toFixed(8) + " BTC", amount: "$" + secondPlaceUSD.toFixed(2) },
                                        3: { btc: thirdPlaceBTC.toFixed(8) + " BTC", amount: "$" + thirdPlaceUSD.toFixed(2) }
                                    };
                                    // Get the top three athletes from athleteResults
                                    const topThree = athleteResults.slice(0, 3);

                                    // Select the podium container and clear existing items
                                    const podium = document.querySelector('.podium');
                                    podium.innerHTML = ''; // Clear any existing podium items

                                    // Loop through the top three athletes and create podium items
                                    topThree.forEach(athlete => {
                                        let rankClass, rankEmoji;

                                        switch (athlete.rank) {
                                            case 1:
                                                rankClass = 'first';
                                                rankEmoji = '<i class="fa-solid fa-crown" style="color: gold;"></i>';
                                                break;
                                            case 2:
                                                rankClass = 'second';
                                                rankEmoji = '<i class="fa-solid fa-medal" style="color: silver;"></i>';
                                                break;
                                            case 3:
                                                rankClass = 'third';
                                                rankEmoji = '<i class="fa-solid fa-award" style="color: #cd7f32;"></i>';
                                                break;
                                            default:
                                                return; // Only handle top three
                                        }

                                        // Create the podium-item div
                                        const podiumItem = document.createElement('div');
                                        podiumItem.classList.add('podium-item', rankClass);

                                        // Populate the inner HTML of podiumItem
                                        podiumItem.innerHTML = `
                                            <div class="podium-rank" title="${athlete.rank === 1 ? '1st Place' : athlete.rank === 2 ? '2nd Place' : '3rd Place'}">
                                                ${rankEmoji}
                                            </div>
                                            <img src="${athlete.profilePic}" alt="${athlete.displayName} portrait" class="podium-portrait" loading="lazy">
                                            <div class="name-row">
                                                <span class="athlete-name" style="cursor: pointer;" title="View stats of ${athlete.displayName}">${athlete.displayName}</span>
                                            </div>
                                            <div>
                                                ${athlete.personalLink ? `<a href="${athlete.personalLink.startsWith('http') ? athlete.personalLink : 'https://' + athlete.personalLink}" target="_blank" rel="noopener"  class="personal-link-icon" aria-label="Visit athlete's personal page" title="Visit personal page of ${athlete.displayName}">
                                                <i class="fa fa-link"></i>
                                                </a>` : ''}
                                                ${renderMediaContact(athlete.mediaContact, true, athlete.displayName)}
                                            </div>
                                            <div><span class="age-reduction">${Math.abs((athlete.bortzAgeReduction != null && Number.isFinite(athlete.bortzAgeReduction) ? athlete.bortzAgeReduction : athlete.ageReduction).toFixed(1))} years</span> reduced</div>
                                            <div class="podium-item-lower">
                                                <div class="btc-amount">(${prizeMoney[athlete.rank].btc})</div>
                                                <div class="prize-money">${prizeMoney[athlete.rank].amount}</div>
                                            </div>
                                        `;

                                        // Append the podiumItem to the podium container
                                        podium.appendChild(podiumItem);

                                        // After appending the podium item
                                        podiumItem.setAttribute('data-division', athlete.division.toLowerCase());
                                        podiumItem.setAttribute('data-generation', athlete.generation.toLowerCase());
                                        podiumItem.setAttribute('data-athlete-name', athlete.name);
                                        podiumItem.setAttribute('data-aos', 'fade');
                                        podiumItem.setAttribute('data-aos-duration', '700');
                                        podiumItem.setAttribute('data-aos-delay', '50');

                                        subscribeLowerPodiumClick();
                                    });

                                    // Attach click event listeners to athlete names
                                    attachAthleteNameClickListeners();

                                    document.querySelectorAll('.podium-item').forEach(item => {
                                        item.addEventListener('click', function (e) {
                                            // Let links and the prize area do their own thing
                                            if (e.target.closest('a') || e.target.closest('.podium-item-lower')) return;

                                            // Don’t open the modal when clicking badges
                                            const badge = e.target.closest('.badge-class');
                                            if (badge) {
                                                const isPointer = getComputedStyle(badge).cursor === 'pointer';
                                                if (!isPointer) e.preventDefault();
                                                return; // never trigger the modal from a badge click
                                            }

                                            handleAthleteNameClick(e);
                                        });
                                    });

                                    applyCamelCaseNewlines();
                                    autoshrinkPodiumNames();

                                    addClickListenerToImages('.portrait, #modalProfilePic', function () {
                                        openEnlargedView(this);
                                    });
                                })
                                .catch(error => {
                                    console.error('Error fetching BTC exchange rate:', error);
                                });
                        })
                        .catch(error => {
                            console.error('Error fetching total prize fund:', error);
                        });
                } else {
                    // Hide the podium container if not included
                    const podium = document.querySelector('.podium');
                    if (podium) {
                        podium.style.display = 'none';
                    }
                }

                window.computeBadges(athleteResults);

                // Populate the table with athletes ranked >3
                const tableBody = document.querySelector('.leaderboard table tbody');
                const remainingAthletes = athleteResults;

                tableBody.innerHTML = ''; // Clear existing table rows
                let lastTier = null; // 'pro' | 'amateur' for inserting separator between Bortz and Pheno sections
                remainingAthletes.forEach((athlete, index) => {
                    const isPro = athlete.bortzAgeReduction != null && Number.isFinite(athlete.bortzAgeReduction);
                    const tier = isPro ? 'pro' : 'amateur';
                    if (lastTier === 'pro' && tier === 'amateur') {
                        const sep = document.createElement('tr');
                        sep.className = 'tier-separator';
                        sep.setAttribute('aria-label', 'Start of Amateur division (Pheno Age) section');
                        sep.innerHTML = '<td colspan="5" class="tier-separator-cell"><span class="tier-separator-label">Amateur division |<a href="https://github.com/nopara73/LongevityWorldCup/blob/master/LongevityWorldCup.Documentation/pheno-age.pdf" target="_blank" rel="noopener" class="tier-separator-link">Pheno Age</a></span></td>';
                        tableBody.appendChild(sep);
                    }
                    lastTier = tier;

                    const template = document.getElementById('leaderboardRowTemplate');
                    const row = template.content.firstElementChild.cloneNode(true);

                    row.classList.add('tier-' + tier);
                    row.setAttribute('data-tier', tier);

                    row.querySelector('.rank').textContent = athlete.rank;
                    const athleteCell = row.querySelector('.athlete-td');
                    const portraitImg = athleteCell.querySelector('img.portrait');
                    portraitImg.src = athlete.profilePic;
                    portraitImg.alt = `${athlete.displayName} portrait`;
                    if (athlete.isNew) {
                        portraitImg.classList.add('is-new');
                        applyNewUI(portraitImg);
                    }
                    if (athlete.rankImproved) {
                        const placesUp = athlete.lastMonthRank - athlete.rank; // e.g. 12 → 7  => 5 places up
                        applyRankUpUI(portraitImg, placesUp);
                    }

                    const athleteNameSpan = athleteCell.querySelector('.athlete-name');
                    athleteNameSpan.textContent = athlete.displayName;
                    athleteNameSpan.title = `View stats of ${athlete.displayName}`;

                    window.setBadges(athlete, athleteCell);

                    const displayAgeReduction = (athlete.bortzAgeReduction != null && Number.isFinite(athlete.bortzAgeReduction)) ? athlete.bortzAgeReduction : athlete.ageReduction;
                    const ageReductionSpan = row.querySelector('.age-reduction');
                    ageReductionSpan.textContent = (displayAgeReduction > 0 ? '+' : '') + displayAgeReduction.toFixed(1) + ' years';

                    const mediaContactCell = row.querySelector('.media-contact-td');
                    mediaContactCell.innerHTML = renderMediaContact(athlete.mediaContact, false, athlete.displayName);

                    row.setAttribute('data-division', athlete.division.toLowerCase().trim());
                    row.setAttribute('data-generation', athlete.generation.trim());
                    row.setAttribute('data-athlete-name', athlete.name);
                    row.setAttribute('data-aos', 'fade');
                    row.setAttribute('data-aos-duration', '700');
                    row.setAttribute('data-aos-delay', '50');

                    if (includePodium && athlete.rank <= podiumCount) {
                        row.style.display = 'none';
                        row.classList.add('podium-athlete');
                    }

                    if (index >= maxAthletes) {
                        row.style.display = 'none';
                        row.classList.add('extra-athlete');
                    }

                    attachAthleteNameClickListeners();
                    applyCamelCaseNewlines();
                    addClickListenerToImages('#modalProfilePic', function () {
                        openEnlargedView(this);
                    });
                    addClickListenerToImages('.portrait, .podium-portrait', handleAthleteNameClick);

                    row.style.cursor = 'pointer';
                    row.addEventListener('click', function (e) {
                        // Let real links work
                        if (e.target.closest('a')) return;

                        // If the click was on a badge, never open the modal via the row
                        const badge = e.target.closest('.badge-class');
                        if (badge) {
                            // Only disable if it’s a “default” cursor badge (non-navigable)
                            const isPointer = getComputedStyle(badge).cursor === 'pointer';
                            if (!isPointer) e.preventDefault(); // does nothing for spans, but safe for anchors
                            return; // stop the row from opening the modal on any badge click
                        }

                        handleAthleteNameClick(e);
                    });

                    row.id = `rank-${athlete.rank}`;
                    tableBody.appendChild(row);
                });

                const hash = window.location.hash;
                if (hash && /^#rank-\d+$/.test(hash)) {
                    const el = document.querySelector(hash);
                    if (el) {
                        ScrollGuard.setAnchorTarget(el);
                        // Do the trusted scroll *first*…
                        ScrollGuard.trustedScrollIntoView(el, { behavior: 'smooth', block: 'start' });
                        // …then block anything else from hijacking the viewport for ~1.6s
                        ScrollGuard.block(1600);
                    }
                }

                // At the end of the athlete fetch block in LoadLeaderboard, after athleteResults has been populated:
                const urlParams = new URLSearchParams(window.location.search);
                const athleteParam = new URLSearchParams(window.location.search).get('athlete') || '';
                if (athleteParam) {
                    const normalizedAthlete = window.slugifyName(athleteParam, false);
                    const athleteData = getAthleteData(normalizedAthlete);
                    if (athleteData) {
                        fetchFullAthleteData(normalizedAthlete, athleteData);
                    } else {
                        // Redirect to the .NET 404 endpoint
                        window.location.href = '/error/404';
                    }
                } else {
                    let searchOrFilterApplied = false; // Flag to check if filter was applied
                    const searchParam = new URLSearchParams(window.location.search).get('search') || '';
                    if (searchParam) {
                        var query = decodeURIComponent(searchParam);
                        const searchInput = document.getElementById('athleteSearch');
                        searchInput.value = query;
                        searchOrFilterApplied = true;
                    }

                    const filtersParam = new URLSearchParams(window.location.search).get('filters');
                    if (filtersParam) {
                        // Double-decode the parameter in case it was double encoded (e.g. baby%2520boomers becomes "baby boomers")
                        const decodedFilters = decodeURIComponent(decodeURIComponent(filtersParam));
                        const filtersList = decodedFilters.split(',');
                        filtersList.forEach(filterValue => {
                            const normalizedFilter = filterValue.trim().toLowerCase();
                            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                                if (checkbox.value.toLowerCase() === normalizedFilter) {
                                    checkbox.checked = true;
                                }
                            });
                        });
                        searchOrFilterApplied = true;
                    }

                    const viewParam = new URLSearchParams(window.location.search).get('view');
                    if (viewParam && (viewParam.toLowerCase() === 'bortz' || viewParam.toLowerCase() === 'pheno')) {
                        const viewId = 'view-' + viewParam.toLowerCase();
                        const viewRadio = document.getElementById(viewId);
                        if (viewRadio) {
                            viewRadio.checked = true;
                            searchOrFilterApplied = true;
                        }
                    }

                    if (searchOrFilterApplied) {
                        debounceFilterAthletes();

                        // Even here scroll to the search when filter applied because the table kinda starts there conceptually
                        setTimeout(() => {
                            if (canAutoScroll()) {
                                searchInput.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        }, 1000);
                    }
                }

                // Pick up dynamically inserted [data-aos] nodes
                if (window.AOS && typeof AOS.refreshHard === 'function') {
                    AOS.refreshHard();
                } else if (window.AOS && typeof AOS.refresh === 'function') {
                    AOS.refresh();
                }
            })
            .catch(error => {
                console.error('Error fetching athletes:', error);
            });
    };

    function subscribeLowerPodiumClick() {
        const targetElement = document.querySelector("#donation-section");
        if (!targetElement) {
            console.error("Donation section (#donation-section) not found.");
            return;
        }

        document.querySelectorAll('.podium-item-lower').forEach(moneyArea => {
            moneyArea.addEventListener('click', () => {
                targetElement.scrollIntoView({ behavior: 'smooth' });
            });
        });
    }

    // Usage
    addClickListenerToImages('#modalProfilePic', function () {
        openEnlargedView(this);
    });
    addClickListenerToImages('.portrait, .podium-portrait', handleAthleteNameClick);

    // Function to attach click event listener to all athlete-name elements
    function attachAthleteNameClickListeners() {
        const athleteNameElements = document.querySelectorAll('.athlete-name');

        document.querySelectorAll('.athlete-name').forEach(athleteNameElement => {
            athleteNameElement.removeEventListener('click', handleAthleteNameClick); // Remove existing listeners to prevent duplicates
            athleteNameElement.addEventListener('click', handleAthleteNameClick);
        });
    }

    function openEnlargedView(imgElement) {
        // Retrieve and clone the template content
        const template = document.getElementById("enlargedPortraitTemplate");
        const clone = template.content.firstElementChild.cloneNode(true);

        // Set the image source and alt attributes based on the clicked image
        const img = clone.querySelector("img");
        img.src = imgElement.src;
        img.alt = imgElement.alt;

        // Append the cloned element to the document (it will be added where it fits in your DOM structure)
        document.body.appendChild(clone);
        lockBodyScroll();
        history.pushState({ modal: 'enlarged' }, "");

        // Trigger a transition to show the element
        setTimeout(() => clone.classList.add('show'), 10);

        // Add event listener for the close button
        clone.querySelector('.close-btn').addEventListener('click', () => {
            closeEnlargedView(clone);
        });

        // Add event listener to close the view when clicking outside the image
        clone.addEventListener('click', (e) => {
            if (e.target === clone) {
                closeEnlargedView(clone);
            }
        });
    }

    function closeEnlargedView(enlargedElem) {
        enlargedElem.classList.remove('show');
        setTimeout(() => {
            document.body.removeChild(enlargedElem);
            // If no modal is open, restore body scroll
            if (modal.style.display !== "block") {
                restoreBodyScroll();
            }
        }, 300);
    }

    function renderMediaContact(contact, isPodium, athleteName) {
        const isEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(contact);
        const tooltipText = isEmail ? `Email ${athleteName}` : `Contact ${athleteName}`;
        if (isPodium) {
            return `${isEmail
                ? `<a href="mailto:${contact}" aria-label="Email ${contact}" class="personal-link-icon" style="margin-left: 0.2rem;" title="${tooltipText}">
                ${window.getIcon(contact)}
               </a>`
                : `<a href="${contact.startsWith('http') ? contact : 'https://' + contact}" target="_blank" rel="noopener" aria-label="Contact the athlete" class="personal-link-icon" style="margin-left: 0.2rem;" title="${tooltipText}">
                ${window.getIcon(contact)}
               </a>`
            }`;
        }
        return `${isEmail
            ? `<a href="mailto:${contact}" class="media-contact" aria-label="Email ${contact}" title="${tooltipText}">
            ${window.getIcon(contact)}
           </a>`
            : `<a href="${contact.startsWith('http') ? contact : 'https://' + contact}" target="_blank" rel="noopener" class="media-contact" aria-label="Contact the athlete" title="${tooltipText}">
            ${window.getIcon(contact)}
           </a>`
        }`;
    }

    const modal = document.getElementById("detailsModal");
    const closeBtn = document.getElementById("closeAthleteDetailsModal");
    const athleteDetails = document.getElementById("athleteDetails");
    let ageChart;
    let savedBodyScroll = 0;

    // Improved body scroll lock for iOS
    function lockBodyScroll() {
        if (document.body.classList.contains('no-scroll')) return;
        
        savedBodyScroll = window.scrollY || window.pageYOffset || document.documentElement.scrollTop;
        document.body.classList.add('no-scroll');
        
        // Prevent iOS bounce
        const scrollY = savedBodyScroll;
        document.body.style.position = 'fixed';
        document.body.style.top = `-${scrollY}px`;
        document.body.style.width = '100%';
    }

    function restoreBodyScroll() {
        if (!document.body.classList.contains('no-scroll')) return;
        
        document.body.classList.remove('no-scroll');
        document.body.style.position = '';
        document.body.style.top = '';
        document.body.style.width = '';
        
        // Restore scroll position
        if (savedBodyScroll !== undefined) {
            window.scrollTo(0, savedBodyScroll);
            savedBodyScroll = 0;
        }
    }

    // Initialize scroll progress indicator and sticky header
    // Store the scroll listener function reference on the element to allow proper removal
    function initializeScrollProgress(modalContent) {
        const progressBar = document.getElementById('modalScrollProgress');
        const stickyHeader = document.getElementById('modalStickyHeader');
        if (!modalContent) return;

        // Remove previous listener if it exists (using stored reference)
        if (modalContent._scrollProgressListener) {
            modalContent.removeEventListener('scroll', modalContent._scrollProgressListener);
            modalContent._scrollProgressListener = null;
        }

        // Create the update function
        const updateProgress = window.ModalScrollOptimizer?.throttleRAF(function() {
            const scrollTop = modalContent.scrollTop;
            const scrollHeight = modalContent.scrollHeight - modalContent.clientHeight;
            const progress = scrollHeight > 0 ? (scrollTop / scrollHeight) * 100 : 0;
            
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
                progressBar.setAttribute('aria-valuenow', Math.round(progress));
                
                // Show/hide progress bar
                if (scrollHeight > 50) {
                    progressBar.classList.add('visible');
                } else {
                    progressBar.classList.remove('visible');
                }
            }
            
            // Show/hide sticky header (show when athlete name starts scrolling out of view)
            // Don't show in guess-mode
            if (stickyHeader && !modalContent.classList.contains('guess-mode')) {
                const athleteName = document.getElementById('athleteName');
                if (athleteName) {
                    // Get the athlete name's position relative to modal content
                    const nameOffsetTop = athleteName.offsetTop;
                    // Show sticky header when scrolled past the name (with small offset for smooth transition)
                    if (scrollTop > nameOffsetTop - 30) {
                        stickyHeader.classList.add('visible');
                    } else {
                        stickyHeader.classList.remove('visible');
                    }
                }
            } else if (stickyHeader && modalContent.classList.contains('guess-mode')) {
                // Always hide sticky header in guess-mode
                stickyHeader.classList.remove('visible');
            }
        }) || function() {
            // Fallback if optimizer not available
            const scrollTop = modalContent.scrollTop;
            const scrollHeight = modalContent.scrollHeight - modalContent.clientHeight;
            const progress = scrollHeight > 0 ? (scrollTop / scrollHeight) * 100 : 0;
            
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
                progressBar.setAttribute('aria-valuenow', Math.round(progress));
                if (scrollHeight > 50) {
                    progressBar.classList.add('visible');
                } else {
                    progressBar.classList.remove('visible');
                }
            }
            
            // Don't show in guess-mode
            if (stickyHeader && !modalContent.classList.contains('guess-mode')) {
                const athleteName = document.getElementById('athleteName');
                if (athleteName) {
                    // Get the athlete name's position relative to modal content
                    const nameOffsetTop = athleteName.offsetTop;
                    // Show sticky header when scrolled past the name (with small offset for smooth transition)
                    if (scrollTop > nameOffsetTop - 30) {
                        stickyHeader.classList.add('visible');
                    } else {
                        stickyHeader.classList.remove('visible');
                    }
                }
            } else if (stickyHeader && modalContent.classList.contains('guess-mode')) {
                // Always hide sticky header in guess-mode
                stickyHeader.classList.remove('visible');
            }
        };

        // Store the listener reference on the element for future removal
        modalContent._scrollProgressListener = updateProgress;
        
        // Add new listener (passive for performance)
        modalContent.addEventListener('scroll', updateProgress, { passive: true });
        
        // Initial update
        updateProgress();
    }

    // Scroll-to-section navigation
    function setupScrollToSectionNavigation(modalContent) {
        // Optional: Add floating navigation menu for long content
        // This is a lightweight implementation - can be enhanced later
        const sections = [
            { id: 'athlete-profile', label: 'Profile' },
            { id: 'athlete-stats', label: 'Stats' },
            { id: 'athlete-biomarkers', label: 'Biomarkers' },
            { id: 'athlete-proofs', label: 'Proofs' }
        ];

        // Add smooth scroll behavior when clicking section links
        sections.forEach(section => {
            const sectionEl = document.getElementById(section.id);
            if (sectionEl) {
                // Ensure smooth scrolling when programmatically scrolled to
                sectionEl.scrollIntoView = (function(original) {
                    return function(options) {
                        const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
                        const opts = options || { behavior: prefersReducedMotion ? 'auto' : 'smooth', block: 'start' };
                        return original.call(this, opts);
                    };
                })(Element.prototype.scrollIntoView);
            }
        });
    }

    // Keyboard navigation for modal
    function setupModalKeyboardNavigation() {
        document.addEventListener('keydown', function(event) {
            if (modal.style.display !== "block") return;
            
            const modalContent = document.querySelector('.modal-content');
            if (!modalContent) return;
            if (modalContent.classList.contains('guess-mode')) return;

            // Home key - scroll to top
            if (event.key === 'Home' && !event.ctrlKey && !event.metaKey) {
                event.preventDefault();
                const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
                modalContent.scrollTo({
                    top: 0,
                    behavior: prefersReducedMotion ? 'auto' : 'smooth'
                });
                return;
            }

            // End key - scroll to bottom
            if (event.key === 'End' && !event.ctrlKey && !event.metaKey) {
                event.preventDefault();
                const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
                modalContent.scrollTo({
                    top: modalContent.scrollHeight,
                    behavior: prefersReducedMotion ? 'auto' : 'smooth'
                });
                return;
            }

            // Arrow keys for section navigation (when not in input/textarea)
            if ((event.key === 'ArrowDown' || event.key === 'ArrowUp') && 
                !['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement?.tagName)) {
                // Only handle if focus is within modal
                if (modal.contains(document.activeElement)) {
                    // Let default behavior handle focus navigation
                    return;
                }
            }
        });
    }

    // Initialize keyboard navigation
    setupModalKeyboardNavigation();
    
    // Set up sticky header close button
    const stickyCloseBtn = document.getElementById('stickyCloseBtn');
    if (stickyCloseBtn) {
        stickyCloseBtn.onclick = function() {
            const modalContent = document.querySelector('.modal-content');
            if (modalContent && modalContent.classList.contains('guess-mode')) return;
            closeModal();
        };
    }

    closeBtn.onclick = function () {
        // don't let them close mid-game
        const modalContent = document.querySelector('.modal-content');
        if (modalContent && modalContent.classList.contains('guess-mode')) return;
        closeModal();
    };

    window.addEventListener('click', function (event) {
        const modalContent = document.querySelector('.modal-content');
        if (event.target === modal && modalContent && !modalContent.classList.contains('guess-mode')) {
            closeModal();
        }
    });

    function closeModal() {
        const modalContent = document.querySelector('.modal-content');
        if (!modalContent) return;
        
        const athleteSlug = modalContent.dataset.athleteSlug;
        
        // Don't store scroll position - always start from top when reopening
        
        // Hide sticky header
        const stickyHeader = document.getElementById('modalStickyHeader');
        if (stickyHeader) {
            stickyHeader.classList.remove('visible');
        }
        
        // Remove scroll listener to prevent memory leaks
        if (modalContent._scrollProgressListener) {
            modalContent.removeEventListener('scroll', modalContent._scrollProgressListener);
            modalContent._scrollProgressListener = null;
        }
        if (window.biomarkerChartResizeObserver) {
            window.biomarkerChartResizeObserver.disconnect();
            window.biomarkerChartResizeObserver = null;
        }
        if (typeof window.destroyAgeRadarChart === 'function') {
            window.destroyAgeRadarChart();
        }
        
        modal.classList.add('fade-out');
        setTimeout(() => {
            modal.style.display = "none";
            modal.classList.remove('fade-out');
            restoreBodyScroll();
            
            // Reset scroll position for next open
            if (modalContent) {
                modalContent.scrollTop = 0;
            }

            // Clear the athlete parameter from the URL:
            history.replaceState({}, "", originalAthletelessURL);

            resetPageTitle();
        }, 400);
    }

    function debounceFilterAthletes() {
        toggleClearIcon();
        debouncedFilter();
    }

    function toggleClearIcon() {
        const searchInput = document.getElementById('athleteSearch');
        const clearIcon = document.querySelector('.clear-icon');

        if (searchInput.value.trim().length > 0) {
            clearIcon.classList.add('visible');
        } else {
            clearIcon.classList.remove('visible');
        }
    }

    function clearSearch() {
        const searchInput = document.getElementById('athleteSearch');
        const clearIcon = document.querySelector('.clear-icon');
        const podium = document.querySelector('.podium');

        searchInput.value = '';
        clearIcon.classList.remove('visible');
        window.removeAllHighlights();
        performFilter(); // Reapply filters without search terms

        // Ensure the podium is visible after clearing the search
        podium.style.display = 'flex';

        const url = new URL(window.location.href);
        url.searchParams.delete('search');
        history.replaceState({}, "", url.toString());
    }

    // Wrap the filter function with debounce
    const debouncedFilter = debounce(() => {
        performFilter();
    }, 400);

    function debounce(func, delay) {
        let debounceTimer;
        return function (...args) {
            const context = this;
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => func.apply(context, args), delay);
        };
    }

    function performFilter() {
        // Get selected divisions
        const selectedDivisions = Array.from(document.querySelectorAll('input[name="division"]:checked'))
            .map(checkbox => checkbox.value.toLowerCase());

        // Get selected generations
        const selectedGenerations = Array.from(document.querySelectorAll('input[name="generation"]:checked'))
            .map(checkbox => checkbox.value.toLowerCase());

        // Get selected exclusive leagues (e.g. "Prosperan")
        const selectedExclusiveLeagues = Array.from(document.querySelectorAll('input[name="exclusiveLeague"]:checked'))
            .map(checkbox => checkbox.value.toLowerCase());

        // Get selected league track (Amateur League / Professional League); only one selected means filter
        const selectedLeagueTracks = Array.from(document.querySelectorAll('input[name="leagueTrack"]:checked'))
            .map(checkbox => checkbox.value);
        const leagueTrackFilterActive = selectedLeagueTracks.length === 1;

        // Get leaderboard view (ultimate | bortz | pheno)
        const viewRadio = document.querySelector('input[name="leaderboardView"]:checked');
        const currentLeaderboardView = viewRadio ? viewRadio.value : 'ultimate';

        const hasBortz = (a) => a.bortzAgeReduction != null && Number.isFinite(a.bortzAgeReduction);

        // Step 1: Apply view inclusion and order
        let baseList;
        if (currentLeaderboardView === 'bortz') {
            baseList = athleteResults.filter(hasBortz);
            baseList.sort(window.compareAthleteRank);
        } else if (currentLeaderboardView === 'pheno') {
            baseList = athleteResults.slice();
            baseList.sort(window.compareAthleteRankPhenoOnly);
        } else {
            baseList = athleteResults; // ultimate: already in rank order
        }

        const query = window.normalizeString(document.getElementById('athleteSearch').value.trim().toLowerCase());
        const searchTerms = query.split(/\s+/).filter(term => term.length > 0);
        const uniqueSearchTerms = [...new Set(searchTerms)];

        const showAll = uniqueSearchTerms.length === 0;

        let filteredAthletes = [];

        baseList.forEach(athlete => {
            const athleteNameNormalized = window.normalizeString(athlete.name);

            let matches = true;

            // League track: when exactly one selected, keep only that tier
            if (leagueTrackFilterActive) {
                const isPro = hasBortz(athlete);
                const wantAmateur = selectedLeagueTracks[0].toLowerCase() === 'amateur league';
                const wantPro = selectedLeagueTracks[0].toLowerCase() === 'professional league';
                if (wantAmateur && isPro) matches = false;
                if (wantPro && !isPro) matches = false;
            }

            // Check division match
            if (matches && selectedDivisions.length > 0) {
                matches = selectedDivisions.includes(athlete.division.toLowerCase());
            }

            // Check generation match
            if (matches && selectedGenerations.length > 0) {
                matches = selectedGenerations.includes(athlete.generation.toLowerCase());
            }

            // Check exclusive league match
            if (matches && selectedExclusiveLeagues.length > 0) {
                matches = selectedExclusiveLeagues.includes((athlete.exclusiveLeague || "").toLowerCase());
            }

            // Check search terms
            if (matches && !showAll) {
                matches = uniqueSearchTerms.every(term => athleteNameNormalized.includes(term));
            }

            if (matches) {
                filteredAthletes.push(athlete);
            }
        });

        const unslicedFilteredAthletes = filteredAthletes;

        filteredAthletes = filteredAthletes.slice(0, maxAthletesGlobal);

        // Determine if filters are used (league track counts only when exactly one selected)
        const filtersUsed = selectedDivisions.length > 0 || selectedGenerations.length > 0 || selectedExclusiveLeagues.length > 0 ||
            leagueTrackFilterActive || currentLeaderboardView !== 'ultimate';
        const searchUsed = uniqueSearchTerms.length > 0;

        // If filters are used, reassign ranks starting from 1
        if (filtersUsed && !searchUsed) {
            filteredAthletes.forEach((athlete, index) => {
                athlete.filteredRank = index + 1;
            });
        } else {
            // Keep original ranks
            filteredAthletes.forEach(athlete => {
                athlete.filteredRank = athlete.rank;
            });
        }

        // First, hide all rows (including tier separator)
        const tableRows = document.querySelectorAll('.leaderboard table tbody tr');
        tableRows.forEach(row => {
            row.style.display = 'none';
        });
        const tierSeparatorRow = document.querySelector('.leaderboard table tbody tr.tier-separator');

        // Remove 'blurred' class from all podium items
        const podiumItems = document.querySelectorAll('.podium-item');
        podiumItems.forEach(item => {
            item.classList.remove('blurred');
        });

        let anyPodiumVisible = false;

        // Show the rows and podium items for the filtered athletes
        filteredAthletes.forEach(athlete => {
            const athleteName = athlete.name;
            const row = document.querySelector(`.leaderboard table tbody tr[data-athlete-name="${athleteName}"]`);
            if (row) {
                row.style.display = '';
                window.showWithDelay(row);

                // Update the rank cell
                const rankCell = row.querySelector('td[data-label="Rank"] .rank');
                if (rankCell) {
                    rankCell.textContent = athlete.filteredRank;
                }

            }
            const item = document.querySelector(`.podium-item[data-athlete-name="${athleteName}"]`);
            if (item) {
                item.style.display = '';
                anyPodiumVisible = true;
            }
        });

        // Show tier separator when both pro and amateur rows are visible (first amateur after at least one pro); hide for Bortz/Pheno views
        if (tierSeparatorRow) {
            let separatorShouldShow = false;
            if (currentLeaderboardView === 'ultimate') {
                const visibleRows = Array.from(document.querySelectorAll('.leaderboard table tbody tr:not(.tier-separator)')).filter(r => r.style.display !== 'none');
                let sawPro = false;
                for (const r of visibleRows) {
                    if (r.classList.contains('tier-pro')) sawPro = true;
                    else if (r.classList.contains('tier-amateur') && sawPro) {
                        separatorShouldShow = true;
                        break;
                    }
                }
            }
            tierSeparatorRow.style.display = separatorShouldShow ? '' : 'none';
        }

        // Reorder tbody so visible rows match filteredAthletes order (fixes wrong order when switching from Bortz/Pheno back to Ultimate)
        const tableBody = document.querySelector('.leaderboard table tbody');
        const allRows = Array.from(tableBody.querySelectorAll('tr'));
        const visibleOrdered = filteredAthletes.map(a => allRows.find(r => r.getAttribute('data-athlete-name') === a.name)).filter(Boolean);
        const separator = allRows.find(r => r.classList.contains('tier-separator'));
        const hiddenRows = allRows.filter(r => r !== separator && !visibleOrdered.includes(r));
        const fragment = document.createDocumentFragment();
        visibleOrdered.forEach(r => fragment.appendChild(r));
        if (separator) fragment.appendChild(separator);
        hiddenRows.forEach(r => fragment.appendChild(r));
        tableBody.appendChild(fragment);

        // Remove existing highlights
        window.removeAllHighlights();

        // Highlight search terms
        document.querySelectorAll('.athlete-name').forEach(athleteNameElement => {
            const athleteNameText = athleteNameElement.textContent;
            const athleteNameNormalized = window.normalizeString(athleteNameText);

            // Check if the athlete is in filteredAthletes
            const athleteInFiltered = filteredAthletes.some(athlete => athlete.name === athleteNameText);
            if (athleteInFiltered) {
                window.highlightText(athleteNameElement, uniqueSearchTerms);
            }
        });

        // Update the counts in the filter sections
        updateFilterCounts(unslicedFilteredAthletes);

        // Add or remove 'blurred' class from podium items based on filtering
        podiumItems.forEach(item => {
            const athleteName = item.getAttribute('data-athlete-name');
            const athleteInFiltered = filteredAthletes.some(athlete => athlete.name === athleteName);
            if (athleteInFiltered) {
                // Remove 'blurred' class
                item.classList.remove('blurred');
            } else {
                // Add 'blurred' class
                item.classList.add('blurred');
            }
        });

        updateCollapsedTitle(selectedDivisions, selectedGenerations, selectedExclusiveLeagues, selectedLeagueTracks, currentLeaderboardView);

        // Display "No Results Found" if Necessary
        displayNoResults(tableRows, podiumItems, query);

        // Hide podium athletes' rows if no filters/search are applied and includePodiumGlobal is true
        if (includePodiumGlobal && selectedDivisions.length === 0 && selectedGenerations.length === 0 && selectedExclusiveLeagues.length === 0 &&
            !leagueTrackFilterActive && currentLeaderboardView === 'ultimate' && uniqueSearchTerms.length === 0) {
            document.querySelectorAll('.leaderboard table tbody tr.podium-athlete').forEach(row => {
                row.style.display = 'none';
            });
        }

        if (typeof AOS !== 'undefined') {
            AOS.refresh();
            applyCamelCaseNewlines(); // Reapply the camelCase fix AFTER AOS refresh
        }

        const url = new URL(window.location.href);
        url.hash = ""; // <- this line removes #ABCD or any other fragment

        if (query === "") {
            url.searchParams.delete('search');
        } else {
            url.searchParams.set('search', encodeURIComponent(query));
        }

        const filters = [...selectedDivisions, ...selectedGenerations, ...selectedExclusiveLeagues, ...(leagueTrackFilterActive ? selectedLeagueTracks : [])];
        if (filters.length === 1 &&
            ([...url.searchParams].length === 0
                || ([...url.searchParams].length === 1 && url.searchParams.has('filters')))
            && currentLeaderboardView === 'ultimate') {
            url.searchParams.delete('filters');
            const leagueSlug = window.slugifyName(filters[0], true);
            url.pathname = `/league/${leagueSlug}`;
        } else {
            url.pathname = originalLeaguelessURL.pathname;
            if (filters.length === 0) {
                url.searchParams.delete('filters');
            } else {
                const encodedFilters = filters.map(f => encodeURIComponent(f)).join(',');
                url.searchParams.set('filters', encodedFilters);
            }
        }

        if (currentLeaderboardView === 'ultimate') {
            url.searchParams.delete('view');
        } else {
            url.searchParams.set('view', currentLeaderboardView);
        }

        history.replaceState({}, "", url.toString());
    }

    function updateCollapsedTitle(selectedDivisions, selectedGenerations, selectedExclusiveLeagues, selectedLeagueTracks, currentLeaderboardView) {
        selectedLeagueTracks = selectedLeagueTracks || [];
        currentLeaderboardView = currentLeaderboardView || 'ultimate';

        // Update the collapsed-title text based on selected filters
        let leagueText = '';

        if (currentLeaderboardView === 'bortz') {
            leagueText = 'BORTZ AGE LEAGUE';
        } else if (currentLeaderboardView === 'pheno') {
            leagueText = 'PHENO AGE LEAGUE';
        } else {
        // If an exclusive league is selected, override the league text.
        if (selectedExclusiveLeagues.length > 0) {
            // If multiple exclusive leagues are selected, join them with " AND "
            leagueText = selectedExclusiveLeagues.map(league => league.toUpperCase()).join(' AND ') + ' LEAGUE';
        } else {
            // Build generation part of the league text
            if (selectedGenerations.length === 1) {
                leagueText += selectedGenerations[0].toUpperCase();
            } else if (selectedGenerations.length === 2) {
                const [first, second] = selectedGenerations.map(gen => gen.toLowerCase()).sort();

                // Check for specific two-generation combinations
                if (first === "baby boomers" && second === "silent generation") {
                    leagueText += "HERITAGE";
                } else if (first === "baby boomers" && second === "gen x") {
                    leagueText += "SENIOR";
                } else if (first === "gen x" && second === "millennials") {
                    leagueText += "PRIME";
                } else if (first === "gen z" && second === "millennials") {
                    leagueText += "RISING";
                } else if (first === "gen alpha" && second === "gen z") {
                    leagueText += "NEXT-GEN";
                } else {
                    leagueText += selectedGenerations[0].toUpperCase() + ' AND ' + selectedGenerations[1].toUpperCase();
                }
            } else if (selectedGenerations.length === 3) {
                leagueText +=
                    selectedGenerations[0].toUpperCase() + ', ' +
                    selectedGenerations[1].toUpperCase() + ', AND ' +
                    selectedGenerations[2].toUpperCase();
            } else if (selectedGenerations.length === 4) {
                leagueText +=
                    selectedGenerations[0].toUpperCase() + ', ' +
                    selectedGenerations[1].toUpperCase() + ', ' +
                    selectedGenerations[2].toUpperCase() + ', AND ' +
                    selectedGenerations[3].toUpperCase();
            } else if (selectedGenerations.length === 5) {
                leagueText +=
                    selectedGenerations[0].toUpperCase() + ', ' +
                    selectedGenerations[1].toUpperCase() + ', ' +
                    selectedGenerations[2].toUpperCase() + ', ' +
                    selectedGenerations[3].toUpperCase() + ', AND ' +
                    selectedGenerations[4].toUpperCase();

                // Build division part of the league text
            }

            if (selectedDivisions.length === 1) {
                if (leagueText.length > 0) {
                    leagueText += ' ';
                }
                leagueText += selectedDivisions[0].toUpperCase();
            } else if (selectedDivisions.length === 2) {
                if (leagueText.length > 0) {
                    leagueText += ' ';
                }

                // Custom sorting order for divisions
                const order = { "men's": 1, "women's": 2, "open": 3 };
                const [first, second] = selectedDivisions
                    .map(div => div.toLowerCase())
                    .sort((a, b) => order[a] - order[b]);

                if (first === "men's" && second === "women's") {
                    leagueText += 'MIXED';
                } else if (first === "men's" && second === 'open') {
                    leagueText += "INCLUSIVE MEN'S";
                } else if (first === "women's" && second === 'open') {
                    leagueText += "INCLUSIVE WOMEN'S";
                }
            }

            // Default text if no filters are selected (or only league track)
            if (leagueText === '') {
                leagueText = (selectedLeagueTracks.length === 1 ? selectedLeagueTracks[0].toUpperCase() : 'ULTIMATE');
            }

            leagueText += " LEAGUE";
        }
        }

        // Update the text content of the collapsed-title element
        const collapsedTitle = document.querySelector('.collapsed-title');
        if (collapsedTitle) {
            collapsedTitle.textContent = leagueText;

            // Force reflow by toggling opacity
            collapsedTitle.style.opacity = '0';
            requestAnimationFrame(() => {
                collapsedTitle.style.opacity = '1';
            });
        }
    }

    function updateFilterCounts(filteredAthletes) {
        // Update division counts
        const divisionCounts = {};
        filteredAthletes.forEach(athlete => {
            const division = athlete.division;
            divisionCounts[division] = (divisionCounts[division] || 0) + 1;
        });

        document.querySelectorAll('.filter-section label[data-division]').forEach(label => {
            const division = label.getAttribute('data-division');
            const count = divisionCounts[division] || 0;
            const countSpan = label.querySelector('.filter-count');
            if (countSpan) {
                countSpan.textContent = count;
            }
        });

        // Update generation counts
        const generationCounts = {};
        filteredAthletes.forEach(athlete => {
            const generation = athlete.generation;
            generationCounts[generation] = (generationCounts[generation] || 0) + 1;
        });

        document.querySelectorAll('.filter-section label[data-generation]').forEach(label => {
            const generation = label.getAttribute('data-generation');
            const count = generationCounts[generation] || 0;
            const countSpan = label.querySelector('.filter-count');
            if (countSpan) {
                countSpan.textContent = count;
            }
        });

        // Update league track counts (Amateur / Professional by tier)
        const hasBortzForCount = (a) => a.bortzAgeReduction != null && Number.isFinite(a.bortzAgeReduction);
        const amateurCount = filteredAthletes.filter(a => !hasBortzForCount(a)).length;
        const professionalCount = filteredAthletes.filter(a => hasBortzForCount(a)).length;
        document.querySelectorAll('.filter-section label[data-league-track]').forEach(label => {
            const track = label.getAttribute('data-league-track');
            const count = (track === 'Amateur League') ? amateurCount : (track === 'Professional League') ? professionalCount : 0;
            const countSpan = label.querySelector('.filter-count');
            if (countSpan) {
                countSpan.textContent = count;
            }
        });
    }

    function displayNoResults(tableRows, podiumItems, query) {
        // Remove existing no-results message if any
        const existingMessage = document.querySelector('.no-results');
        if (existingMessage) {
            existingMessage.remove();
        }

        // Check if any rows or podium items are visible
        const anyVisible = Array.from(tableRows).some(row => row.style.display !== 'none');

        if (!anyVisible) {
            if (query.trim() !== '') {
                const tableBody = document.querySelector('.leaderboard table tbody');
                const noResults = document.createElement('tr');
                noResults.classList.add('no-results');
                noResults.innerHTML = `<td colspan="6">No results found for "<strong>${window.escapeHTML(query)}</strong>".</td>`;
                tableBody.appendChild(noResults);
            }
            else {
                const tableBody = document.querySelector('.leaderboard table tbody');
                const noResults = document.createElement('tr');
                noResults.classList.add('no-results');
                noResults.innerHTML = `<td colspan="6">It looks like no athletes have joined this league yet.</td>`;
                tableBody.appendChild(noResults);
            }
        }
    }

    let isInitialClick = true; // Track if it’s the first click after focusing

    const searchInput = document.getElementById('athleteSearch');

    // Select all text on the first focus
    searchInput.addEventListener('focus', () => {
        isInitialClick = true;
    });

    // Select all text on the first click, then just place the cursor where clicked on the second click
    searchInput.addEventListener('click', (event) => {
        if (isInitialClick) {
            searchInput.select(); // Select all text
            isInitialClick = false;
        }
    });

    document.addEventListener('keydown', function (event) {
        const searchInput = document.getElementById('athleteSearch');
        if (event.key === 'Escape' && searchInput.value.trim().length > 0) {
            clearSearch();
            searchInput.blur(); // Optionally remove focus
        }
    });

    // Modify the input event listener
    document.getElementById('athleteSearch').addEventListener('input', function () {
        const query = this.value.trim();
        if (query === '') {
            clearSearch(); // Run only when input is cleared
        } else {
            debounceFilterAthletes(); // Run debounce function when input is not empty
        }
    });

    document.querySelector('.clear-icon').addEventListener('click', clearSearch);
    document.querySelector('.clear-icon').addEventListener('keypress', function (event) {
        if (event.key === 'Enter') clearSearch();
    });

    document.querySelectorAll('input[name="leaderboardView"]').forEach(radio => {
        radio.addEventListener('change', function () { performFilter(); });
    });
    // Clicking the active Bortz or Pheno badge again deselects it (none = Ultimate view)
    document.querySelectorAll('.leaderboard-view-switcher .view-badge').forEach(label => {
        label.addEventListener('click', function (e) {
            const radio = document.getElementById(label.getAttribute('for'));
            if (radio && radio.checked) {
                e.preventDefault();
                document.getElementById('view-ultimate').checked = true;
                performFilter();
            }
        });
    });

    function generateDivisionFilters(athletes) {
        const filterSection = document.querySelector('.filter-section ul');
        filterSection.innerHTML = ''; // Clear existing filters if any

        // Count occurrences of each division
        const divisionCounts = athletes.reduce((acc, athlete) => {
            acc[athlete.division] = (acc[athlete.division] || 0) + 1;
            return acc;
        }, {});

        // Generate the filter items with icons and counts
        Object.keys(divisionCounts).forEach(division => {
            const count = divisionCounts[division];
            const icon = window.TryGetDivisionIcon(division);

            const li = document.createElement('li');
            li.innerHTML = `
        <label data-division="${division}">
            <input type="checkbox" name="division" value="${division}">
            ${icon} ${division.charAt(0).toUpperCase() + division.slice(1)} (<span class="filter-count">${count}</span>)
        </label>
    `;
            filterSection.appendChild(li);
            const input = li.querySelector('input[type="checkbox"]');
            input.addEventListener('change', function (event) {
                event.stopPropagation(); // Prevent this event from affecting the sidebar toggle
                performFilter();
            });
        });
    }

    function generateGenerationFilters(athletes) {
        const filterSection = document.querySelector('#generation-filter-section ul');
        filterSection.innerHTML = ''; // Clear existing filters if any

        // Count occurrences of each generation
        const generationCounts = athletes.reduce((acc, athlete) => {
            acc[athlete.generation] = (acc[athlete.generation] || 0) + 1;
            return acc;
        }, {});

        // Order generations from oldest to youngest
        const orderedGenerations = ["Silent Generation", "Baby Boomers", "Gen X", "Millennials", "Gen Z", "Gen Alpha"];

        orderedGenerations.forEach(generation => {
            const count = generationCounts[generation] || 0;
            if (count > 0) { // Only show generations with at least one athlete
                const icon = window.TryGetGenerationIcon(generation);

                const li = document.createElement('li');
                li.innerHTML = `
            <label data-generation="${generation}">
                <input type="checkbox" name="generation" value="${generation}">
                ${icon} ${generation} (<span class="filter-count">${count}</span>)
            </label>
        `;
                filterSection.appendChild(li);
                const input = li.querySelector('input[type="checkbox"]');
                input.addEventListener('change', function (event) {
                    event.stopPropagation(); // Prevent this event from affecting the sidebar toggle
                    performFilter();
                });
            }
        });
    }

    function generateExclusiveFilters(athletes) {
        const filterSection = document.querySelector('#exclusive-filter-section ul');
        filterSection.innerHTML = ''; // Clear existing filters if any

        const prosperanCount = athletes.reduce((count, athlete) => {
            return athlete.exclusiveLeague === "Prosperan" ? count + 1 : count;
        }, 0);

        if (prosperanCount > 0) {
            const li = document.createElement('li');
            li.innerHTML = `
            <label data-exclusive-league="Prosperan">
                <input type="checkbox" name="exclusiveLeague" value="Prosperan">
                🏝️ Prosperan (<span class="filter-count">${prosperanCount}</span>)
            </label>
        `;
            filterSection.appendChild(li);

            const input = li.querySelector('input[type="checkbox"]');
            input.addEventListener('change', function (event) {
                event.stopPropagation(); // Prevent this event from affecting the sidebar toggle
                performFilter();
            });
        }
    }

    function generateLeagueTrackFilters(athletes) {
        const filterSection = document.querySelector('#league-track-filter-section ul');
        filterSection.innerHTML = ''; // Clear existing filters if any

        const isPro = (a) => a.bortzAgeReduction != null && Number.isFinite(a.bortzAgeReduction);
        const amateurCount = athletes.filter(a => !isPro(a)).length;
        const professionalCount = athletes.filter(a => isPro(a)).length;

        const tracks = [
            { value: 'Amateur League', label: 'Amateur League', count: amateurCount },
            { value: 'Professional League', label: 'Professional League', count: professionalCount }
        ];

        tracks.forEach(({ value, label, count }) => {
            const li = document.createElement('li');
            li.innerHTML = `
                <label data-league-track="${value}">
                    <input type="checkbox" name="leagueTrack" value="${value}">
                    ${label} (<span class="filter-count">${count}</span>)
                </label>
            `;
            filterSection.appendChild(li);
            const input = li.querySelector('input[type="checkbox"]');
            input.addEventListener('change', function (event) {
                event.stopPropagation();
                performFilter();
            });
        });
    }

    function addFadeInEffectToElements() {
        document.querySelectorAll('.podium-item, .leaderboard table tbody tr').forEach(element => {
            element.classList.add('fade-in-element');
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        addFadeInEffectToElements();
    });

    function applyCamelCaseNewlines() {
        if (window.innerWidth < 480) {
            document.querySelectorAll('.athlete-name').forEach(el => {
                if (el.closest('.podium')) return;
                const txt = el.textContent;
                el.innerHTML = txt.replace(/([a-z])([A-Z](?=[a-z]))/g, '$1<br>$2');
            });
        }
    }

    function fitTextToWidth(el, minPx = 12, maxPx = null) {
        // reset to CSS default first
        el.style.fontSize = '';
        const max = maxPx || parseFloat(getComputedStyle(el).fontSize) || 18;
        let lo = minPx, hi = Math.round(max), best = minPx;
        // binary search for largest size that fits
        while (lo <= hi) {
            const mid = Math.floor((lo + hi) / 2);
            el.style.fontSize = mid + 'px';
            if (el.scrollWidth <= el.clientWidth) { best = mid; lo = mid + 1; }
            else { hi = mid - 1; }
        }
        el.style.fontSize = best + 'px';
    }

    function autoshrinkPodiumNames() {
        document.querySelectorAll('.podium .athlete-name').forEach(el => fitTextToWidth(el, 12));
    }

    // run after podium render and on resize
    window.addEventListener('resize', debounce(autoshrinkPodiumNames, 150));
    window.addEventListener('load', autoshrinkPodiumNames);
    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape' || event.key === 'Esc') {
            closeOpenComponents();
        }
    });
    function closeOpenComponents() {
        // don't close the details modal mid-guess
        const modalContent = document.querySelector('.modal-content');
        if (modalContent && modalContent.classList.contains('guess-mode')) return;

        const enlargedImg = document.querySelector('.enlarged-portrait.show');
        if (enlargedImg) {
            closeEnlargedView(enlargedImg);
        }
        else if (modal.style.display === "block") {
            closeModal();
        }
    }

    function handleAthleteNameClick(event) {
        // Determine if it's a table row or podium item
        const athleteRow = getAthleteRow(event.target);
        if (!athleteRow) {
            console.error('Athlete row not found');
            return;
        }

        // Get athlete's name from data attribute
        const athleteNameText = athleteRow.getAttribute('data-athlete-name');

        // Find the athlete's data from athleteResults
        const athleteData = getAthleteData(athleteNameText);
        if (!athleteData) {
            console.error('Athlete data not found');
            return;
        }

        // Fetch the full athlete JSON data
        fetchFullAthleteData(athleteNameText, athleteData);
    }

    function getAthleteRow(element) {
        return element.closest('tr') || element.closest('.podium-item');
    }

    function getAthleteData(athleteNameText) {
        return athleteResults.find(athlete => window.slugifyName(athlete.name) === window.slugifyName(athleteNameText));
    }

    function getAthletelessURL() {
        const url = new URL(window.location.href.replace(/\/athlete\/[^/]+\/?$/, ''));
        url.searchParams.delete('athlete');
        url.searchParams.delete('guessmyage');
        return url;
    }

    function getLeaguelessURL() {
        const url = new URL(window.location.href.replace(/\/league\/[^/]+\/?$/, ''));
        return url;
    }

    let originalAthletelessURL = getAthletelessURL();
    let originalLeaguelessURL = getLeaguelessURL();

    function fetchFullAthleteData(athleteNameText, athleteData) {
        fetchWithTimeout('/api/data/athletes', {}, 10000) // 10-second timeout
            .then(response => response.json())
            .then(athletes => {
                const fullAthleteData = athletes.find(a => window.slugifyName(a.Name) === window.slugifyName(athleteNameText));
                if (!fullAthleteData) {
                    console.error('Full athlete data not found');
                    return;
                }

                const { ultimateRank, bestLeagueRank, bestLeagueName, bestLeagueType } = computeBestLeagueRank(athleteData);

                // Populate the modal with athlete data
                populateModal(fullAthleteData, athleteData, ultimateRank, bestLeagueRank, bestLeagueName, bestLeagueType);

                updatePageTitleForAthlete((fullAthleteData.DisplayName && fullAthleteData.DisplayName.trim()) ? fullAthleteData.DisplayName.trim() : fullAthleteData.Name, ultimateRank);

                // Age visualization (radar + center) and biomarker chart are created after modal is shown so canvases have layout dimensions.
                const bioAge = (athleteData.lowestBortzAge != null && Number.isFinite(athleteData.lowestBortzAge))
                    ? athleteData.lowestBortzAge
                    : athleteData.lowestPhenoAge;
                const chronoAge = (athleteData.lowestBortzAge != null && Number.isFinite(athleteData.lowestBortzAge))
                    ? athleteData.chronoAtLowestBortzAge
                    : athleteData.chronoAtLowestPhenoAge;

                // Biomarker chart is created after modal is shown (see below) so the canvas has layout dimensions.

                // Populate proofs gallery
                populateProofsGallery(fullAthleteData);

                // After populating the modal with athlete data but before showing it:
                // Only update originalAthletelessURL when we're not already on an athlete URL, so a second open (e.g. URL sync with ?guessmyage=1) does not overwrite it with "/"
                const pathnameBeforeOpen = window.location.pathname;
                if (!/^\/athlete\/[^/]+\/?$/.test(pathnameBeforeOpen)) {
                    originalAthletelessURL = getAthletelessURL();
                }
                const athleteSlug = window.slugifyName(athleteNameText, true);
                history.pushState({ modal: 'details', athlete: athleteSlug }, "", `/athlete/${athleteSlug}`);

                // Display the modal
                modal.style.display = "block";
                lockBodyScroll();

                const modalContent = document.querySelector('.modal-content');
                // Create biomarker chart after modal is visible so the canvas has non-zero dimensions (fixes chart sizing when created while modal was hidden).
                requestAnimationFrame(function() {
                    generateAgeVisualization(bioAge, chronoAge, athleteData, athleteResults);
                    generateBiomarkerChart(fullAthleteData);
                    // Force Chart.js to re-measure after layout; hover triggers this internally, so do it explicitly (second rAF + ResizeObserver fallback).
                    requestAnimationFrame(function() {
                        if (window.biomarkerChartInstance) window.biomarkerChartInstance.resize();
                    });
                    var chartContainer = document.getElementById('athlete-biomarkers');
                    if (chartContainer && window.biomarkerChartInstance) {
                        if (window.biomarkerChartResizeObserver) window.biomarkerChartResizeObserver.disconnect();
                        window.biomarkerChartResizeObserver = new ResizeObserver(function() {
                            if (window.biomarkerChartInstance) window.biomarkerChartInstance.resize();
                        });
                        window.biomarkerChartResizeObserver.observe(chartContainer);
                    }
                });
                if (!modalContent) {
                    console.error('Modal content element not found');
                    return;
                }
                
                modalContent.dataset.athleteSlug = athleteSlug;
                
                // Always start at top when modal opens
                modalContent.scrollTop = 0;
                
                // Hide sticky header initially
                const stickyHeader = document.getElementById('modalStickyHeader');
                if (stickyHeader) {
                    stickyHeader.classList.remove('visible');
                }
                
                // Initialize scroll progress indicator
                initializeScrollProgress(modalContent);
                
                // Setup scroll-to-section navigation (optional floating menu for long content)
                setupScrollToSectionNavigation(modalContent);

                var frame = document.getElementById('events-frame');
                if (frame) {
                    frame.src = `/event-board-embed.html?athlete=${encodeURIComponent(athleteSlug)}&rows=10&viewAll=false&linkNames=false&embed=1`;
                }

                const gmaCard = document.getElementById('guessAgeContainer');

                // always reset the Guess-My-Age UI first:
                modalContent.classList.remove('guess-mode', 'gma-fast');
                gmaCard.classList.remove('gma-done');
                // read your guesses from localStorage
                const allGuesses = JSON.parse(localStorage.getItem('gmaAllGuesses') || '{}');
                // check if the user has hit “Skip All”
                const skipAll = localStorage.getItem('gmaSkipAll') === 'true';

                const seen = sessionStorage.getItem('gmaSeen');

                if (skipAll) {
                    // user opted out globally
                    modalContent.classList.remove('guess-mode');
                    gmaCard.classList.add('gma-done');
                } else if (allGuesses.hasOwnProperty(athleteSlug)) {
                    // already guessed or skipped this athlete
                    modalContent.classList.remove('guess-mode');
                    gmaCard.classList.add('gma-done');
                } else {
                    // first time on *this* athlete
                    modalContent.classList.add('guess-mode');
                    sessionStorage.setItem('gmaSeen', 'true');
                }

                const gmaSkipAllBtn = document.getElementById('gmaSkipAll');
                if (gmaSkipAllBtn) {
                    // reveal “Skip All” once they've skipped at least one athlete,
                    // but hide it if they already chose skip-all
                    if (!skipAll && Object.values(allGuesses).some(g => g.skipped)) {
                        gmaSkipAllBtn.style.display = 'inline-block';
                    } else {
                        gmaSkipAllBtn.style.display = 'none';
                    }
                }

                // stash the slug for your submit/skip handler
                modalContent.dataset.athleteSlug = athleteSlug;
                updateYourGuess();

                if (seen) {
                    modalContent.classList.add('gma-fast');
                } else {
                    sessionStorage.setItem('gmaSeen', 'true');
                }

                const bortzPaceOfAgingContainer = document.getElementById('bortzPaceOfAgingContainer');
                const bortzPaceOfAgingValue =
                    (athleteData.lowestBortzAge && athleteData.chronoAtLowestBortzAge)
                        ? (athleteData.lowestBortzAge / athleteData.chronoAtLowestBortzAge)
                        : null;
                if (Number.isFinite(bortzPaceOfAgingValue)) {
                    document.getElementById('bortzPaceOfAging').textContent = bortzPaceOfAgingValue.toFixed(2);
                    bortzPaceOfAgingContainer.style.display = '';
                    const bortzPaceOfAgingRank = _.findIndex(athletesOrderedByBortzPace, ['name', athleteData.name]) + 1;
                    if (Number.isFinite(bortzPaceOfAgingRank) && bortzPaceOfAgingRank > 0) {
                        document.getElementById('bortzPaceOfAgingRank').textContent = '#' + bortzPaceOfAgingRank;
                    }
                } else {
                    bortzPaceOfAgingContainer.style.display = 'none';
                }

                const paceOfAgingContainer = document.getElementById('paceOfAgingContainer');
                const paceOfAgingValue =
                    (athleteData.lowestPhenoAge && athleteData.chronoAtLowestPhenoAge)
                        ? (athleteData.lowestPhenoAge / athleteData.chronoAtLowestPhenoAge)
                        : null;
                if (Number.isFinite(paceOfAgingValue)) {
                    document.getElementById('paceOfAging').textContent = paceOfAgingValue.toFixed(2);
                    paceOfAgingContainer.style.display = '';

                    const paceOfAgingRank = _.findIndex(athletesOrderedByPace, ['name', athleteData.name]) + 1;
                    if (Number.isFinite(paceOfAgingRank) && paceOfAgingRank > 0) {
                        document.getElementById('paceOfAgingRank').textContent = '#' + paceOfAgingRank;
                    }
                } else {
                    paceOfAgingContainer.style.display = 'none';
                }

            })
            .catch(error => {
                console.error('Error fetching full athlete data:', error);
            });
    }

    function computeBestLeagueRank(athleteData) {
        // Arrays of divisions and generations for reference
        const divisions = [...new Set(athleteResults.map(athlete => athlete.division))];
        const generations = [...new Set(athleteResults.map(athlete => athlete.generation))];

        let bestLeagueRank = Infinity;
        let bestLeagueName = '';
        let bestLeagueType = '';

        for (const [league, rank] of Object.entries(athleteData.ranks)) {
            if (rank < bestLeagueRank) {
                bestLeagueRank = rank;
                bestLeagueName = league;

                // Determine league type
                if (divisions.includes(league)) {
                    bestLeagueType = 'division';
                } else if (generations.includes(league)) {
                    bestLeagueType = 'generation';
                } else if (league.includes('_')) {
                    bestLeagueType = 'combination';
                } else {
                    bestLeagueType = 'other';
                }
            }
        }
        const ultimateRank = athleteData.rank;

        return { ultimateRank, bestLeagueRank, bestLeagueName, bestLeagueType };
    }

    function populateModal(fullAthleteData, athleteData, ultimateRank, bestLeagueRank, bestLeagueName, bestLeagueType) {
        const modalDisplayName = (fullAthleteData.DisplayName && fullAthleteData.DisplayName.trim()) ? fullAthleteData.DisplayName.trim() : fullAthleteData.Name;
        const athleteNameWithRank = `${modalDisplayName}${window.getRankText(ultimateRank)}`;
        const athleteNameElement = document.getElementById('athleteName');
        athleteNameElement.textContent = athleteNameWithRank;
        
        // Set sticky header name - use the full content including rank badges/emojis
        const stickyAthleteName = document.getElementById('stickyAthleteName');
        if (stickyAthleteName) {
            // Clone the full content including any HTML (like emojis/badges)
            stickyAthleteName.innerHTML = athleteNameElement.innerHTML;
        }
        
        const profilePic = document.getElementById('modalProfilePic');
        profilePic.src = fullAthleteData.ProfilePic;
        profilePic.alt = `${modalDisplayName} Profile Picture`;
        profilePic.loading = 'lazy';

        const athleteProfileEl = document.getElementById('athlete-profile');
        const isPro = athleteData.bortzAgeReduction != null && Number.isFinite(athleteData.bortzAgeReduction);
        if (athleteProfileEl) {
            if (isPro) athleteProfileEl.classList.add('is-pro');
            else athleteProfileEl.classList.remove('is-pro');
        }
        const modalStickyHeader = document.getElementById('modalStickyHeader');
        if (modalStickyHeader) {
            if (isPro) modalStickyHeader.classList.add('is-pro');
            else modalStickyHeader.classList.remove('is-pro');
        }

        document.getElementById('athleteBio').textContent = fullAthleteData.Why;

        let rankText = `#${ultimateRank} in the <a href="/leaderboard" class="league-link" target="_blank" rel="noopener noreferrer">Ultimate League</a>`;
        if (bestLeagueRank !== ultimateRank) {
            const leagueLabel = bestLeagueName.replace('_', ' ');
            if (bestLeagueType === 'division' || bestLeagueType === 'generation') {
                const slug = window.slugifyName(bestLeagueName, true);
                rankText = `#${bestLeagueRank} in the <a href="/league/${slug}" class="league-link">${leagueLabel} League</a>`;
            } else if (bestLeagueType === 'combination') {
                const filters = bestLeagueName.split('_').map(f => encodeURIComponent(f)).join('%2C');
                rankText = `#${bestLeagueRank} in the <a href="/?filters=${filters}" class="league-link">${leagueLabel} League</a>`;
            } else {
                rankText = `#${bestLeagueRank} in the ${leagueLabel} League`;
            }
        }

        document.getElementById('athleteRank').innerHTML = rankText;
        document.getElementById('athleteDivision').innerHTML = `<a href="/league/${window.slugifyName(athleteData.division, true)}" class="league-link">${athleteData.division}</a>${window.getRankText(athleteData.ranks[athleteData.division])}`;
        document.getElementById('athleteGeneration').innerHTML = `<a href="/league/${window.slugifyName(athleteData.generation, true)}" class="league-link">${athleteData.generation}</a>${window.getRankText(athleteData.ranks[athleteData.generation])}`;
        document.getElementById('athleteFlag').textContent = fullAthleteData.Flag;
        document.getElementById('chronologicalAge').textContent = athleteData.chronologicalAge.toFixed(0);
        updateCrowdContainer(athleteData.crowdAge, athleteData.crowdCount);
        updateYourGuess();
        const lowestBortzAgeEl = document.getElementById('lowestBortzAge');
        const lowestBortzAgeContainer = document.getElementById('lowestBortzAgeContainer');
        if (athleteData.lowestBortzAge != null && Number.isFinite(athleteData.lowestBortzAge)) {
            lowestBortzAgeEl.textContent = athleteData.lowestBortzAge.toFixed(1);
            lowestBortzAgeContainer.style.display = '';
        } else {
            lowestBortzAgeContainer.style.display = 'none';
        }
        document.getElementById('lowestPhenoAge').textContent = athleteData.lowestPhenoAge.toFixed(1);
        const bortzAgeReductionContainer = document.getElementById('bortzAgeReductionContainer');
        const bortzAgeReductionLabel = document.getElementById('bortzAgeReductionAccelerationLabel');
        if (athleteData.bortzAgeReduction != null && Number.isFinite(athleteData.bortzAgeReduction)) {
            bortzAgeReductionLabel.textContent = athleteData.bortzAgeReduction < 0 ? "Bortz age reduction:" : "Bortz age acceleration:";
            document.getElementById('bortzAgeReduction').textContent = (athleteData.bortzAgeReduction >= 0 ? "+" : "") + athleteData.bortzAgeReduction.toFixed(1);
            document.getElementById('bortzAgeReductionPercent').textContent = athleteData.bortzAgeReductionPercent.toFixed(1);
            bortzAgeReductionContainer.style.display = '';
        } else {
            bortzAgeReductionContainer.style.display = 'none';
        }
        document.getElementById('ageReductionAccelerationLabel').textContent = athleteData.ageReduction < 0 ? "Pheno age reduction:" : "Pheno age acceleration:";
        document.getElementById('ageReduction').textContent = (athleteData.ageReduction >= 0 ? "+" : "") + athleteData.ageReduction.toFixed(1);
        document.getElementById('ageReductionPercent').textContent = athleteData.ageReductionPercent.toFixed(1);

        // Personal Link
        const personalLinkElement = document.getElementById('personalLink');
        if (athleteData.personalLink) {
            personalLinkElement.href = athleteData.personalLink.startsWith('http') ? athleteData.personalLink : 'https://' + athleteData.personalLink;
            personalLinkElement.style.display = 'flex';
            personalLinkElement.title = `Visit personal page of ${modalDisplayName}`;
        } else {
            personalLinkElement.style.display = 'none';
        }

        // Media Contact
        const mediaContactElement = document.getElementById('mediaContact');
        if (athleteData.mediaContact) {
            const isEmail = athleteData.mediaContact.includes('@');
            mediaContactElement.href = isEmail ? `mailto:${athleteData.mediaContact}` : (athleteData.mediaContact.startsWith('http') ? athleteData.mediaContact : 'https://' + athleteData.mediaContact);
            mediaContactElement.innerHTML = `${window.getIcon(athleteData.mediaContact)} Media contact`;
            mediaContactElement.style.display = 'flex';
            mediaContactElement.title = isEmail ? `Email ${modalDisplayName}` : `Contact ${modalDisplayName}`;
        } else {
            mediaContactElement.style.display = 'none';
        }

        // — Add badge strip into the modal —
        const modalBadgeSection = document.getElementById('modalBadgeStrip');
        modalBadgeSection.innerHTML = '';
        // Clone athleteData but disable personalLink for modal badges
        const athleteForBadges = { ...athleteData, personalLink: null };
        window.setBadges(athleteForBadges, {
            querySelector: () => modalBadgeSection
        });
        Array.from(modalBadgeSection.children).forEach((badge, i) => {
            badge.style.animation = `pop .55s ease-out both ${i * 0.2}s`;
            badge.addEventListener('animationend', function handler() {
                // Clear the animation so CSS hover-transform can take over
                badge.style.animation = '';
                badge.removeEventListener('animationend', handler);
            });
        });

        // wrap each badge in a column with its name
        const badges = Array.from(modalBadgeSection.children);
        modalBadgeSection.innerHTML = '';
        badges.forEach(badge => {
            const fullTitle = badge.getAttribute('title') || '';
            const colonIndex = fullTitle.indexOf(':');
            let titlePart = fullTitle;
            let detailPart = '';
            if (colonIndex !== -1) {
                titlePart = fullTitle.slice(0, colonIndex);       // before the colon
                detailPart = fullTitle.slice(colonIndex + 1).trim(); // after the colon
            }

            const wrapper = document.createElement('div');
            wrapper.classList.add('modal-badge-item');
            wrapper.appendChild(badge);

            const label = document.createElement('div');
            label.classList.add('modal-badge-name');
            if (detailPart) {
                label.innerHTML =
                    `<span class="modal-badge-title">${titlePart}</span>` +
                    `<span class="modal-badge-detail">${detailPart}</span>`;
            } else {
                label.innerHTML = `<span class="modal-badge-title">${titlePart}</span>`;
            }
            wrapper.appendChild(label);

            // enable click/tap to expand full text
            wrapper.addEventListener('click', () => {
                wrapper.classList.toggle('expanded');
            });
            modalBadgeSection.appendChild(wrapper);
        });

    }

    function generateBiomarkerChart(fullAthleteData) {
        const biomarkerChartCtx = document.getElementById('biomarkerChart').getContext('2d');
        const biomarkerData = fullAthleteData.Biomarkers.sort((a, b) => new Date(a.Date) - new Date(b.Date));
        const dob = new Date(
            fullAthleteData.DateOfBirth.Year,
            fullAthleteData.DateOfBirth.Month - 1,
            fullAthleteData.DateOfBirth.Day
        );

        const completeData = biomarkerData.filter(isCompleteBiomarkerSet);
        if (completeData.length === 0) {
            if (window.biomarkerChartInstance) {
                window.biomarkerChartInstance.destroy();
            }
            return;
        }

        const labels = completeData.map(entry => entry.Date);
        const phenoAges = [];
        const bortzAges = [];
        const biomarkersRaw = initializeBiomarkersRaw();

        completeData.forEach((entry, entryIndex) => {
            const entryDate = new Date(entry.Date);
            const chronoAgeAtEntry = window.calculateAgeAtDate(dob, entryDate);

            // Push in same order as bortz-age.html (WBC, Lymphocytes, Neutrophils, …)
            biomarkersRaw['WBC (10^3 cells/µL)'].push(entry.Wbc1000cellsuL);
            biomarkersRaw['Lymphocytes (%)'].push(entry.LymPc);
            biomarkersRaw['Neutrophils (%)'].push(entry.NeutrophilPc != null ? entry.NeutrophilPc : null);
            biomarkersRaw['Monocytes (%)'].push(entry.MonocytePc != null ? entry.MonocytePc : null);
            biomarkersRaw['RBC (10¹²/L)'].push(entry.Rbc10e12L != null ? entry.Rbc10e12L : null);
            biomarkersRaw['MCV (fL)'].push(entry.McvFL);
            biomarkersRaw['MCH (pg)'].push(entry.MchPg != null ? entry.MchPg : null);
            biomarkersRaw['RDW (%)'].push(entry.RdwPc);
            biomarkersRaw['Albumin (g/L)'].push(entry.AlbGL);
            biomarkersRaw['ALT (U/L)'].push(entry.AltUL != null ? entry.AltUL : null);
            biomarkersRaw['ALP (U/L)'].push(entry.AlpUL);
            biomarkersRaw['GGT (U/L)'].push(entry.GgtUL != null ? entry.GgtUL : null);
            biomarkersRaw['Urea (mmol/L)'].push(entry.UreaMmolL != null ? entry.UreaMmolL : null);
            biomarkersRaw['Creatinine (µmol/L)'].push(entry.CreatUmolL);
            biomarkersRaw['Cystatin C (mg/L)'].push(entry.CystatinCMgL != null ? entry.CystatinCMgL : null);
            biomarkersRaw['Glucose (mmol/L)'].push(entry.GluMmolL);
            biomarkersRaw['HbA1c (mmol/mol)'].push(entry.Hba1cMmolMol != null ? entry.Hba1cMmolMol : null);
            biomarkersRaw['Cholesterol (mmol/L)'].push(entry.CholesterolMmolL != null ? entry.CholesterolMmolL : null);
            biomarkersRaw['ApoA1 (g/L)'].push(entry.ApoA1GL != null ? entry.ApoA1GL : null);
            biomarkersRaw['CRP (mg/L)'].push(entry.CrpMgL);
            biomarkersRaw['SHBG (nmol/L)'].push(entry.ShbgNmolL != null ? entry.ShbgNmolL : null);
            biomarkersRaw['Vitamin D (nmol/L)'].push(entry.VitaminDNmolL != null ? entry.VitaminDNmolL : null);

            const biomarkerValues = prepareBiomarkerValues(entry, chronoAgeAtEntry);
            const phenoAge = window.PhenoAge.calculatePhenoAge(biomarkerValues);
            phenoAges.push(phenoAge.toFixed(1));

            // Bortz Age (when full Bortz set available)
            let bortzAge = null;
            if (window.BortzAge && typeof window.BortzAge.calculateBortzAge === 'function' && isCompleteBortzBiomarkerSet(entry)) {
                const wbc = entry.Wbc1000cellsuL;
                const monoCount = wbc * entry.MonocytePc / 100;
                const neutCount = wbc * entry.NeutrophilPc / 100;
                const bortzValues = [
                    chronoAgeAtEntry,
                    entry.AlbGL,
                    entry.AlpUL,
                    entry.UreaMmolL,
                    entry.CholesterolMmolL,
                    entry.CreatUmolL,
                    entry.CystatinCMgL,
                    entry.Hba1cMmolMol,
                    entry.CrpMgL,
                    entry.GgtUL,
                    entry.Rbc10e12L,
                    entry.McvFL,
                    entry.RdwPc,
                    monoCount,
                    neutCount,
                    entry.LymPc,
                    entry.AltUL,
                    entry.ShbgNmolL,
                    entry.VitaminDNmolL,
                    entry.GluMmolL,
                    entry.MchPg,
                    entry.ApoA1GL
                ];
                const computed = window.BortzAge.calculateBortzAge(chronoAgeAtEntry, bortzValues);
                if (Number.isFinite(computed)) bortzAge = computed.toFixed(1);
            }
            bortzAges.push(bortzAge);
        });

        const biomarkersZScores = calculateBiomarkerZScores(biomarkersRaw);
        const datasets = prepareBiomarkerDatasets(labels, phenoAges, bortzAges, biomarkersRaw, biomarkersZScores);

        if (window.biomarkerChartInstance) {
            window.biomarkerChartInstance.destroy();
        }

        window.biomarkerChartInstance = new Chart(biomarkerChartCtx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: getBiomarkerChartOptions()
        });
    }

    // Biomarker key order matches bortz-age.html card order (WBC, Lymphocytes, Neutrophils, …)
    function initializeBiomarkersRaw() {
        return {
            'WBC (10^3 cells/µL)': [],
            'Lymphocytes (%)': [],
            'Neutrophils (%)': [],
            'Monocytes (%)': [],
            'RBC (10¹²/L)': [],
            'MCV (fL)': [],
            'MCH (pg)': [],
            'RDW (%)': [],
            'Albumin (g/L)': [],
            'ALT (U/L)': [],
            'ALP (U/L)': [],
            'GGT (U/L)': [],
            'Urea (mmol/L)': [],
            'Creatinine (µmol/L)': [],
            'Cystatin C (mg/L)': [],
            'Glucose (mmol/L)': [],
            'HbA1c (mmol/mol)': [],
            'Cholesterol (mmol/L)': [],
            'ApoA1 (g/L)': [],
            'CRP (mg/L)': [],
            'SHBG (nmol/L)': [],
            'Vitamin D (nmol/L)': []
        };
    }

    function collectBiomarkerValues(entry, biomarkersRaw) {
        function pushOrInherit(key, newValue) {
            // Retrieve the last known value if available
            const lastValue = biomarkersRaw[key].length > 0 ? biomarkersRaw[key][biomarkersRaw[key].length - 1] : undefined;
            // Use newValue if provided; otherwise, inherit lastValue
            const valueToUse = newValue != null ? newValue : lastValue;
            // Update the persistent storage
            biomarkersRaw[key].push(valueToUse);
            // Return the value used so we can update the entry
            return valueToUse;
        }
        entry.Wbc1000cellsuL = pushOrInherit('WBC (10^3 cells/µL)', entry.Wbc1000cellsuL);
        entry.LymPc = pushOrInherit('Lymphocytes (%)', entry.LymPc);
        entry.McvFL = pushOrInherit('MCV (fL)', entry.McvFL);
        entry.RdwPc = pushOrInherit('RDW (%)', entry.RdwPc);
        entry.AlbGL = pushOrInherit('Albumin (g/L)', entry.AlbGL);
        entry.AlpUL = pushOrInherit('ALP (U/L)', entry.AlpUL);
        entry.CreatUmolL = pushOrInherit('Creatinine (µmol/L)', entry.CreatUmolL);
        entry.GluMmolL = pushOrInherit('Glucose (mmol/L)', entry.GluMmolL);
        entry.CrpMgL = pushOrInherit('CRP (mg/L)', entry.CrpMgL);
    }

    function prepareBiomarkerValues(entry, chronoAgeAtEntry) {
        return [
            chronoAgeAtEntry,
            entry.AlbGL,
            entry.CreatUmolL,
            entry.GluMmolL,
            Math.log(entry.CrpMgL / 10),
            entry.Wbc1000cellsuL,
            entry.LymPc,
            entry.McvFL,
            entry.RdwPc,
            entry.AlpUL
        ];
    }

    function calculateBiomarkerZScores(biomarkersRaw) {
        const biomarkersZScores = {};
        for (const [key, values] of Object.entries(biomarkersRaw)) {
            const hasNulls = values.some(v => v == null);
            if (hasNulls) {
                const valid = values.filter(v => v != null && Number.isFinite(v));
                const n = valid.length;
                if (n === 0) {
                    biomarkersZScores[key] = values.map(() => null);
                } else {
                    const mean = valid.reduce((sum, val) => sum + val, 0) / n;
                    const variance = valid.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / n;
                    const stdDev = Math.sqrt(variance);
                    biomarkersZScores[key] = values.map(val =>
                        val == null || !Number.isFinite(val) ? null : (stdDev === 0 ? 0 : ((val - mean) / stdDev).toFixed(2))
                    );
                }
            } else {
                const mean = values.reduce((sum, val) => sum + val, 0) / values.length;
                const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
                const stdDev = Math.sqrt(variance);
                biomarkersZScores[key] = stdDev === 0
                    ? values.map(() => 0)
                    : values.map(val => ((val - mean) / stdDev).toFixed(2));
            }
        }
        return biomarkersZScores;
    }

    function prepareBiomarkerDatasets(labels, phenoAges, bortzAges, biomarkersRaw, biomarkersZScores) {
        const hasBortzAge = bortzAges.some(v => v != null && Number.isFinite(Number(v)));
        const datasets = [];
        if (hasBortzAge) {
            datasets.push({
                label: 'Bortz Age',
                data: bortzAges,
                borderColor: 'rgba(0, 128, 0, 1)',
                backgroundColor: 'rgba(0, 128, 0, 0.1)',
                fill: false,
                tension: 0.1,
                borderWidth: 3,
                yAxisID: 'y1',
                spanGaps: true
            });
        }
        datasets.push({
            label: 'Pheno Age',
            data: phenoAges,
            borderColor: 'rgba(0, 0, 255, 1)',
            backgroundColor: 'rgba(0, 0, 255, 0.1)',
            fill: false,
            tension: 0.1,
            borderWidth: 3,
            yAxisID: 'y1'
        });

        const biomarkerColors = {
            'WBC (10^3 cells/µL)': 'rgba(34, 139, 34, 1)',
            'Lymphocytes (%)': 'rgba(0, 100, 0, 1)',
            'Neutrophils (%)': 'rgba(100, 149, 237, 1)',
            'Monocytes (%)': 'rgba(148, 0, 211, 1)',
            'RBC (10¹²/L)': 'rgba(178, 34, 34, 1)',
            'MCV (fL)': 'rgba(70, 130, 180, 1)',
            'MCH (pg)': 'rgba(210, 105, 30, 1)',
            'RDW (%)': 'rgba(220, 20, 60, 1)',
            'Albumin (g/L)': 'rgba(0, 128, 255, 1)',
            'ALT (U/L)': 'rgba(85, 107, 47, 1)',
            'ALP (U/L)': 'rgba(218, 165, 32, 1)',
            'GGT (U/L)': 'rgba(139, 90, 43, 1)',
            'Urea (mmol/L)': 'rgba(72, 61, 139, 1)',
            'Creatinine (µmol/L)': 'rgba(128, 0, 128, 1)',
            'Cystatin C (mg/L)': 'rgba(60, 179, 113, 1)',
            'Glucose (mmol/L)': 'rgba(255, 165, 0, 1)',
            'HbA1c (mmol/mol)': 'rgba(255, 99, 71, 1)',
            'Cholesterol (mmol/L)': 'rgba(184, 134, 11, 1)',
            'ApoA1 (g/L)': 'rgba(0, 191, 255, 1)',
            'CRP (mg/L)': 'rgba(255, 69, 0, 1)',
            'SHBG (nmol/L)': 'rgba(199, 21, 133, 1)',
            'Vitamin D (nmol/L)': 'rgba(255, 215, 0, 1)'
        };

        for (const [key, zScores] of Object.entries(biomarkersZScores)) {
            const actualValues = biomarkersRaw[key];
            const hasAtLeastOneValue = actualValues.some(v => v != null && Number.isFinite(v));
            if (!hasAtLeastOneValue) continue;

            const dataPoints = zScores.map((zScore, index) => ({
                x: labels[index],
                y: zScore,
                actualValue: actualValues[index]
            }));

            // Retrieve saved visibility state from localStorage
            let savedState = localStorage.getItem('biomarkerVisibilityState');
            let isHidden = true; // default value

            if (savedState) {
                const state = JSON.parse(savedState);
                // Use the saved state if it exists for this biomarker key
                if (state.hasOwnProperty(key)) {
                    isHidden = state[key];
                }
            }

            datasets.push({
                label: key,
                data: dataPoints,
                borderColor: biomarkerColors[key],
                backgroundColor: 'rgba(0, 0, 0, 0)',
                fill: false,
                tension: 0.1,
                yAxisID: 'y2',
                hidden: isHidden,
                spanGaps: true
            });
        }
        return datasets;
    }

    function getBiomarkerChartOptions() {
        return {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false
            },
            stacked: false,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            const label = context.dataset.label || '';
                            const yValue = context.parsed.y;
                            const actualValue = context.raw.actualValue;
                            if (label === 'Pheno Age' || label === 'Bortz Age') {
                                return yValue != null ? `${label}: ${yValue}` : `${label}: N/A`;
                            }
                            const formattedValue = actualValue !== undefined && actualValue != null && !isNaN(actualValue)
                                ? (actualValue % 1 !== 0 ? actualValue.toFixed(2) : actualValue.toString())
                                : 'N/A';
                            return `${label}: ${formattedValue}`;
                        }
                    }
                },
                legend: {
                    labels: {
                        font: {
                            size: window.innerWidth < 768 ? 10 : 12 // Adjust font size for mobile
                        }
                    },
                    onHover: function (event) {
                        event.native.target.style.cursor = 'pointer';
                    },
                    onLeave: function (event) {
                        event.native.target.style.cursor = 'default';
                    },
                    onClick: function (e, legendItem, legend) {
                        // Execute the default onClick handler
                        Chart.defaults.plugins.legend.onClick.call(this, e, legendItem, legend);
                        // Get the chart instance and dataset metadata
                        const ci = legend.chart;
                        const index = legendItem.datasetIndex;
                        const meta = ci.getDatasetMeta(index);

                        // Store the biomarker's new visibility status
                        // Retrieve the stored state; if none exists, start with an empty object
                        let state = localStorage.getItem('biomarkerVisibilityState');
                        state = state ? JSON.parse(state) : {};

                        // Update the state with the new key-value pair
                        state[meta.label] = meta.hidden;

                        // Save it back to localStorage as a JSON string
                        localStorage.setItem('biomarkerVisibilityState', JSON.stringify(state));
                    }
                }
            },
            scales: {
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Age (years)',
                        font: {
                            size: window.innerWidth < 768 ? 10 : 14 // Adjust font size for mobile
                        }
                    },
                    grid: {
                        drawOnChartArea: true
                    }
                },
                y2: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Biomarkers (Z-scores)',
                        font: {
                            size: window.innerWidth < 768 ? 10 : 14
                        }
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Date',
                        font: {
                            size: window.innerWidth < 768 ? 10 : 14
                        }
                    }
                }
            }
        };
    }

    function populateProofsGallery(fullAthleteData) {
        const proofsGallery = document.getElementById('proofsGallery');
        proofsGallery.innerHTML = '';

        fullAthleteData.Proofs.forEach(proofUrl => {
            const proofItem = document.createElement('div');
            proofItem.classList.add('proof-item');
            proofItem.innerHTML = `<img src="${proofUrl}" alt="Proof Image" loading="lazy">`;
            proofsGallery.appendChild(proofItem);

            proofItem.querySelector('img').addEventListener('click', function () {
                openEnlargedView(this);
            });
        });
    }

    // Ensure modal history cleanup
    window.addEventListener('popstate', function (event) {
        closeOpenComponents();
    });

    const sidebar = document.querySelector('.sidebar');
    const sidebarToggle = document.querySelector('.sidebar-toggle');
    const sidebarClose = document.querySelector('.sidebar-close');

    sidebarToggle.addEventListener('click', () => {
        toggleSidebar();
    });

    sidebarToggle.addEventListener('mouseenter', () => {
        if (sidebar.classList.contains('expanded')) return;
        sidebar.classList.add('partially-expanded');
    });

    sidebarToggle.addEventListener('mouseleave', () => {
        sidebar.classList.remove('partially-expanded');
    });

    sidebarClose.addEventListener('click', () => {
        closeSidebar();
    });

    function toggleSidebar() {
        if (sidebar.classList.contains('expanded')) {
            closeSidebar();
        }
        else {
            openSidebar();
        }
    }

    function openSidebar() {
        sidebar.classList.remove('partially-expanded');
        sidebar.classList.remove('collapsed');

        if (!sidebar.classList.contains('expanded')) {
            sidebar.classList.add('expanded');
        }
        if (!sidebarToggle.classList.contains('active')) {
            sidebarToggle.classList.add('active')
        }

        sidebarToggle.title = "Hide leagues";
        sidebarToggle.setAttribute('aria-label', 'Hide sidebar');

        // Scroll to the leaderboard table
        if (canAutoScroll()) {
            document.querySelector('.search-wrapper .sidebar-toggle').scrollIntoView({
                behavior: 'smooth',
                block: 'start',
            });
        }
    }

    function closeSidebar() {
        sidebar.classList.remove('expanded');
        sidebarToggle.classList.remove('active');
        sidebar.classList.remove('partially-expanded');
        if (!sidebar.classList.contains('button-collapsed')) {
            sidebar.classList.add('button-collapsed');
        }
        sidebarToggle.title = "Show leagues";
        sidebarToggle.setAttribute('aria-label', 'Show sidebar');

        setTimeout(() => {
            sidebar.classList.remove('button-collapsed');
        }, 50);
    }

    // Sidebar swipe gesture
    let startX = 0;
    let endX = 0;
    let startY = 0;
    let endY = 0;
    const SWIPE_THRESHOLD = 50; // Minimum distance to qualify as a swipe
    const TAP_THRESHOLD = 10; // Allowable movement for taps

    document.addEventListener('touchstart', (e) => {
        if (modal.style.display === "block") return;

        startX = e.changedTouches[0].clientX;
        startY = e.changedTouches[0].clientY;
    }, false);

    document.addEventListener('touchend', (e) => {
        if (modal.style.display === "block") return;

        endX = e.changedTouches[0].clientX;
        endY = e.changedTouches[0].clientY;

        const deltaX = endX - startX; // Horizontal movement
        const deltaY = endY - startY; // Vertical movement

        // Check if it's a tap (small movement)
        if (Math.abs(deltaX) < TAP_THRESHOLD && Math.abs(deltaY) < TAP_THRESHOLD) {
            return; // Do nothing, treat as a tap
        }

        // Check for swipe
        if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > SWIPE_THRESHOLD) {
            if (deltaX > 0) {
                // Swiped from left to right => open sidebar
                openSidebar();
            } else {
                // Swiped from right to left => close sidebar
                closeSidebar();
            }
        }
    }, false);

    // Updates the document title for the selected athlete.
    function updatePageTitleForAthlete(athleteName, athleteRank) {
        document.title = `${athleteName} (#${athleteRank}) - Longevity World Cup`;
    }

    // Resets the document title to the default when no athlete is selected.
    const originalDocumentTitle = document.title;
    function resetPageTitle() {
        document.title = originalDocumentTitle;
    }
    function addClickListenerToImages(selector, callback) {
        document.querySelectorAll(selector).forEach(img => {
            if (!img.dataset.listenerAdded) {
                img.addEventListener('click', callback);
                img.dataset.listenerAdded = true; // Mark this element as having a listener added
            }
        });
    }

    function updateCrowdContainer(crowdAge, crowdCount) {
        const crowdContainer = document.getElementById('crowdAgeContainer');
        const emptyCrowdContainer = document.getElementById('emptyCrowdAgeContainer');
        const notEmptyCrowdContainer = document.getElementById('notEmptyCrowdAgeContainer');

        if (crowdCount === 0) {
            notEmptyCrowdContainer.style.display = 'none';
            emptyCrowdContainer.style.display = 'block';
        } else {
            notEmptyCrowdContainer.style.display = 'block';
            emptyCrowdContainer.style.display = 'none';
            document.getElementById('crowdAge').textContent = crowdAge.toFixed(0);
            document.getElementById('crowdCount').textContent = crowdCount.toFixed(0);
        }
    }

    function updateYourGuess() {
        const yourGuessContainer = document.getElementById('yourGuessContainer');
        const yourGuessSpan = document.getElementById('yourGuess');
        const allGuesses = JSON.parse(localStorage.getItem('gmaAllGuesses') || '{}');
        const athleteSlug = document.querySelector('.modal-content').dataset.athleteSlug;
        const guessData = allGuesses[athleteSlug];

        if (guessData && guessData.value != null) {
            // show the container
            yourGuessContainer.style.display = 'inline-block';

            // convert guess to a number
            const guess = Number(guessData.value);

            // grab the displayed chrono & crowd ages
            const chrono = parseInt(document.getElementById('chronologicalAge').textContent, 10);
            const crowd = parseFloat(document.getElementById('crowdAge').textContent);

            // compute how far you and the crowd are from the true age
            const diffYou = Math.abs(guess - chrono);
            const diffCrowd = Math.abs(crowd - chrono);

            // collect any matching icons
            const iconClasses = [];
            if (diffYou === 0) iconClasses.push('fa-bullseye');
            if (diffYou < diffCrowd) iconClasses.push('fa-trophy');
            if (guessData.first) iconClasses.push('fa-medal');

            // build and render
            const iconsHTML = iconClasses.map(c => `<i class="fa ${c}"></i>`).join(' ');
            yourGuessSpan.innerHTML = `${iconsHTML} ${guess} years${guessData.first ? ' (first to guess)' : ''}`;

            // remove any existing stamp classes
            yourGuessContainer.classList.remove('first-guess-stamp', 'primary-stamp', 'golden-stamp');
            // exact match → golden stamp
            if (diffYou === 0) {
                yourGuessContainer.classList.add('golden-stamp');
            }
            // better than crowd → primary-color stamp
            else if (diffYou < diffCrowd) {
                yourGuessContainer.classList.add('primary-stamp');
            }
            // first-to-guess (fallback) → default black stamp
            else if (guessData.first) {
                yourGuessContainer.classList.add('first-guess-stamp');
            }

        } else {
            // hide if no guess
            yourGuessContainer.style.display = 'none';
        }
    }
</script>

<script>
    if (!window.__eventsEmbedListener) {
        window.__eventsEmbedListener = 1;
        window.addEventListener('message', function (e) {
            var d = e.data;
            if (d && d.type === 'events-embed-height') {
                var f = document.getElementById('events-frame');
                if (f) f.style.height = d.h + 'px';
            }
        })
    }

    (function () {
        function sendThemeToFrame(f) {
            if (!f || !f.contentWindow) return;
            var cs = getComputedStyle(document.documentElement);
            var bs = getComputedStyle(document.body);
            var vars = ['--primary-color', '--secondary-color', '--card-bg', '--dark-text-color', '--light-text-color', '--body-bg'];
            var payload = { type: 'events-theme-vars', 'font-family': bs.getPropertyValue('font-family'), 'background-color': bs.getPropertyValue('background-color') };
            vars.forEach(function (v) { payload[v] = cs.getPropertyValue(v) });
            f.contentWindow.postMessage(payload, '*');
        }
        var frame = document.getElementById('events-frame');
        if (frame) {
            frame.addEventListener('load', function () { sendThemeToFrame(frame) });
        }
    })();
</script>