<style>
    .badge-section {
        display: flex;
        align-items: center; /* Vertically centers the badges */
        flex-wrap: wrap;
        gap: 0.3rem;
    }

    .badge-class {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        font-size: 1rem;
        font-weight: bold;
        color: #fff;
        margin-left: 0.3rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3); /* Clean drop shadow only */
        transition: transform 0.2s ease;
    }

    @keyframes shadowPulse {
        0% {
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.3);
        }

        50% {
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.6);
        }

        100% {
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.3);
        }
    }

    .badge-class:hover {
        transform: scale(1.2);
        animation: shadowPulse 1s ease-in-out 1 forwards;
    }

    .modal-badge-strip {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.25rem;
        margin: 0.5rem 0 1rem;
    }

        /* make the badges in the modal larger */
        .modal-badge-strip .badge-class {
            width: 70px;
            height: 70px;
            font-size: 2rem;
            margin: 0.4rem;
        }

        /* BADGE LABELS IN MODAL */
        .modal-badge-strip .modal-badge-item {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            margin: 0.4rem;
        }

        /* BADGE LABELS IN MODAL: full tooltip, wrapped and clamped */
        .modal-badge-strip .modal-badge-name {
            font-size: 0.75rem;
            margin-top: 0.2rem;
            color: var(--primary-color);
            text-align: center;
            width: 100px; /* fix width so it wraps */
            white-space: normal; /* allow wrapping */
            word-break: break-word; /* break long words */
            display: -webkit-box; /* for line‑clamp */
            -webkit-line-clamp: 3; /* show up to 3 lines */
            -webkit-box-orient: vertical; /* required for line‑clamp */
            overflow: hidden; /* hide anything past 3 lines */
        }

    /* only make the badge title bold */
    .modal-badge-name .modal-badge-title {
        display: block;
        font-weight: bold;
    }

    .modal-badge-name .modal-badge-detail {
        display: none;
    }
    /* reveal the detail line on hover (desktop) or when tapped (mobile) */
    .modal-badge-item:hover .modal-badge-detail,
    .modal-badge-item.expanded .modal-badge-detail {
        display: block;
    }

    /* on hover (desktop) or when .expanded is toggled (mobile), drop the clamp */
    .modal-badge-item:hover .modal-badge-name, .modal-badge-item.expanded .modal-badge-name {
        -webkit-line-clamp: unset;
        max-height: none;
        overflow: visible;
    }

    .portrait,
    .podium-portrait {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid var(--secondary-color);
        margin: 0.5rem 0; /* Reduce the vertical margin of the portrait */
        cursor: pointer;
        transition: transform 0.3s ease;
    }

        .portrait:hover,
        .podium-portrait:hover {
            transform: scale(1.1);
        }

    .leaderboard {
        display: flex;
        align-items: stretch;
        background-color: var(--card-bg);
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        flex-grow: 1;
    }

    .sidebar.partially-expanded {
        width: 80px;
    }

    .sidebar-toggle {
        background-color: var(--card-bg);
        border: 2px solid var(--primary-color);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.3s ease;
        margin-right: 1rem;
    }

        .sidebar-toggle.active {
            background-color: var(--primary-color);
            transform: scale(1); /* Keep the size consistent */
        }

            .sidebar-toggle.active i {
                color: var(--card-bg);
            }

        .sidebar-toggle:hover {
            background-color: var(--primary-color);
            transform: scale(1.05); /* Reduced scaling for subtle effect */
        }

        .sidebar-toggle i {
            color: var(--primary-color);
            font-size: 1.5rem;
            transition: color 0.3s ease;
        }

        .sidebar-toggle:hover i {
            color: var(--card-bg);
        }

    .sidebar-close {
        display: none; /* Hidden by default */
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--primary-color);
        cursor: pointer;
        position: absolute;
        top: 3px; /* Adjusted for better placement */
        right: 3px; /* Close to the edge */
        z-index: 10; /* Ensure it's visible above content */
        transition: background-color 0.3s ease, color 0.3s ease;
        width: 40px; /* Width of the button */
        height: 40px; /* Height of the button (equal to width) */
        border-radius: 50%; /* Makes it a perfect circle */
    }

    /* Show the close button only when the sidebar is expanded via the toggle button */
    .sidebar.expanded .sidebar-close {
        display: block;
    }

    /* Optional: Hover effect */
    .sidebar-close:hover {
        background-color: var(--primary-color); /* Add background to improve contrast */
        color: var(--card-bg); /* Adjust text/icon color for contrast */
        transform: scale(1.1); /* Slight scale for interactivity */
    }

    .sidebar {
        position: relative; /* To position the close button absolutely within the sidebar */
        width: 50px;
        padding: 0;
        background-color: var(--card-bg);
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        margin-right: 0.2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        transition: width 0.3s ease, padding 0.3s ease;
        overflow: hidden;
        flex-shrink: 0;
    }

        .sidebar:hover:not(.button-collapsed),
        .sidebar.expanded {
            width: auto;
            padding: 1rem;
            align-items: flex-start;
        }

        .sidebar .filter-section {
            display: none;
        }

        .sidebar:hover .filter-section,
        .sidebar.expanded .filter-section {
            display: block;
        }

        .sidebar .sidebar-title .sidebar-icon {
            display: inline-block;
            font-size: 2rem;
        }

        .sidebar .sidebar-title .sidebar-title-text {
            display: none;
            margin-left: 0.5rem;
            font-size: 2rem;
        }

        .sidebar:hover .sidebar-title .sidebar-title-text,
        .sidebar.expanded .sidebar-title .sidebar-title-text {
            display: inline-block;
        }

    .collapsed-title {
        display: block;
        writing-mode: vertical-rl;
        transform: rotate(180deg);
        text-align: center;
        font-size: 1.8rem;
        color: var(--primary-color);
        padding: 15px 0;
        letter-spacing: 1px;
        word-spacing: 10px;
        font-family: 'Orbitron', sans-serif;
        background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
        background-size: 200%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: none;
        border-radius: 5px; /* Softens edges */
    }

    .sidebar:hover .collapsed-title,
    .sidebar.expanded .collapsed-title {
        display: none;
    }

    .sidebar:hover .sidebar-title,
    .sidebar.expanded .sidebar-title {
        width: 100%; /* Full width only when sidebar is expanded */
    }

    .sidebar-title {
        margin: 0;
        padding: 1rem 0;
        text-align: center;
        font-size: 1.2rem;
        color: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: left;
        border-bottom: 2px solid var(--primary-color);
    }

    .content {
        flex-grow: 1;
        transition: margin-left 0.3s ease;
    }

    .sidebar:hover ~ .content,
    .sidebar.expanded ~ .content {
        margin-left: 200px;
    }

    .main-container {
        display: flex;
        align-items: flex-start;
    }

    table {
        flex-grow: 1;
        width: auto;
        border-collapse: separate;
        border-spacing: 0;
        align-self: flex-start; /* Add this line */
    }

    .leaderboard td {
        text-align: center;
    }

    .rank {
        font-weight: 700;
        font-size: 1.2rem;
        color: var(--primary-color);
    }

    .age-reduction {
        font-weight: 700;
        color: #4caf50;
        text-align: left;
    }

    .athlete-td {
        display: flex;
        align-items: center;
        text-align: left;
        gap: 0.5rem;
    }

    th {
        padding: 1rem 1rem;
        text-align: center;
        background-color: rgba(0, 188, 212, 0.1);
        color: var(--primary-color);
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.9rem;
        letter-spacing: 1px;
    }

    /* Adjust Rank column */
    .leaderboard table th:nth-child(1) {
        width: 15px;
    }

    /* Adjust Athlete column */
    .leaderboard table th:nth-child(2) {
        text-align: left;
    }

    tr:nth-child(even) {
        background-color: rgba(240, 244, 248, 0.5);
    }

    tr {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

        tr:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

    .media-contact {
        color: rgba(255, 64, 129, 0.7);
        text-decoration: none;
        transition: color 0.2s ease-in-out;
        font-size: 1.5rem;
        padding: 0.5rem;
        margin: 10px 0;
    }

        .media-contact:hover {
            color: var(--primary-color);
        }

        .media-contact i {
            font-size: 2rem;
            width: 2rem;
            height: 2rem;
            line-height: 2rem;
            display: inline-block;
            text-align: center;
            vertical-align: middle;
        }

    .athlete-name {
        color: var(--primary-color);
        text-decoration: underline;
        text-align: left;
        cursor: pointer;
        transition: color 0.2s ease-in-out;
        display: inline-block; /* Ensures padding is applied around the element */
        padding: 0.5rem 0.2rem 0.5rem 0.5rem; /* Increase the clickable area */
        white-space: pre-wrap;
    }

        .athlete-name:hover {
            color: var(--secondary-color);
            background-color: rgba(0, 0, 0, 0.05); /* Optional: Highlight the hitbox on hover */
            border-radius: 8px; /* Optional: Makes the hover effect look rounded */
            font-size: 1.1em;
        }

    .podium .athlete-name {
        font-size: 1.1rem;
        padding-bottom: 0.2rem; /* Looks better with decreased padding here. */
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 3;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 1% auto;
        padding: 20px;
        border: none;
        width: 80%;
        height: 88%;
        max-width: 900px;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
        max-height: 90vh;
        animation: fadeIn 0.5s ease-out;
    }

    .athlete-profile {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }

    #modalProfilePic {
        width: 70%;
        aspect-ratio: 1 / 1;
        height: auto;
        cursor: pointer;
        transition: transform 0.3s ease, border-color 0.3s ease;
        border-radius: 50%; /* Retain circular appearance if needed */
        object-fit: cover; /* Ensure it fits nicely */
    }

        #modalProfilePic:hover {
            transform: scale(1.05); /* Subtle enlargement */
        }

    .athlete-info {
        text-align: left;
        width: 100%;
        max-width: 600px;
        margin-bottom: 1rem;
    }

        .athlete-info p {
            margin: 0.3rem 0;
        }

    .athlete-links {
        display: flex;
        align-items: center;
        flex-direction: column;
        gap: 0.5rem;
    }

        .athlete-links a {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: var(--primary-color);
            transition: color 0.2s ease-in-out;
        }

            .athlete-links a:hover {
                color: var(--secondary-color);
            }

    .proofs-gallery {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
        justify-content: center;
        padding: 0;
    }

    .proof-item {
        width: 100%;
        height: auto;
        border-radius: 10px;
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.3s ease;
    }

        .proof-item:hover {
            transform: scale(1.05);
        }

        .proof-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    .enlarged-portrait {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.85); /* Darkened background */
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        cursor: pointer;
        opacity: 0; /* Start hidden */
        transform: scale(0.95); /* Slightly scaled down */
        transition: opacity 0.5s ease, transform 0.5s ease; /* Smoother transition */
    }

        .enlarged-portrait.show {
            opacity: 1; /* Fade in */
            transform: scale(1); /* Scale up smoothly */
            filter: blur(0); /* Clear any background blur effect */
        }

        .enlarged-portrait .close-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 1.8rem; /* Adjust as needed */
            color: rgba(255, 255, 255, 0.85);
            background-color: rgba(0, 0, 0, 0.6);
            width: 40px; /* Equal width */
            height: 40px; /* Equal height */
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%; /* Makes it circular */
            cursor: pointer;
            transition: color 0.3s, background-color 0.3s, transform 0.2s;
            padding: 0; /* Remove padding to prevent distortion */
        }

            .enlarged-portrait .close-btn:hover {
                color: var(--light-text-color);
                background-color: rgba(0, 0, 0, 0.9);
                transform: scale(1.1); /* Subtle hover effect */
            }

        .enlarged-portrait img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            cursor: default; /* Change to default cursor to indicate no action on click */
        }

    .podium {
        display: flex;
        justify-content: center;
        align-items: flex-end;
        margin-bottom: 2rem;
    }

    .podium-item {
        position: relative;
        text-align: center;
        padding: 1rem;
        background-color: var(--card-bg);
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        margin: 0 1rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        width: 200px;
        min-height: 230px;
        transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .podium-portrait {
        width: auto;
        height: 40%;
        aspect-ratio: 1 / 1;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid var(--secondary-color);
        margin: 1rem 0;
    }

    .podium-item:hover {
        transform: scale(1.02);
        transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }

    .podium-item.blurred {
        filter: blur(5px);
        pointer-events: none; /* Optional, prevents interaction with blurred items */
    }

    .podium-item.first {
        order: 2;
        height: 340px;
    }

    .podium-item.second {
        order: 1;
        height: 320px;
    }

    .podium-item.third {
        order: 3;
        height: 300px;
    }

    .podium-item-lower {
        position: absolute;
        bottom: 0;
        width: 100%;
        padding: 10px 0;
        border-radius: 0 0 15px 15px;
        display: flex;
        flex-direction: column;
        align-items: center;
        clip-path: polygon(0 30%, 100% 0, 100% 100%, 0% 100%);
        transition: clip-path 0.3s ease-in-out;
        pointer-events: auto; /* Enable click events */
        cursor: pointer; /* Indicate that it's clickable */
    }

        .podium-item-lower:hover {
            clip-path: polygon(0 0, 100% 0, 100% 100%, 0% 100%);
        }

    .podium-item.first .podium-item-lower {
        background-color: #FFF9C4;
    }

    .podium-item.second .podium-item-lower {
        background-color: #E0E0E0;
    }

    .podium-item.third .podium-item-lower {
        background-color: #D9C3A3;
    }

    .prize-money {
        font-weight: bold;
        font-size: 2rem;
        color: #4caf50;
        margin-top: 2px;
    }

    .btc-amount {
        margin-top: 1rem;
        font-weight: normal;
        font-size: 0.8rem;
        color: var(--dark-text-color);
    }

    .podium-rank {
        position: absolute;
        top: -6px;
        left: 10%;
        transform: translateX(-50%);
        background-color: white;
        padding: 2px;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 2rem;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .personal-link-icon {
        color: var(--primary-color);
        font-size: 1rem;
        text-decoration: none;
        transition: color 0.2s ease-in-out;
        margin-left: 0.2rem;
    }

        .personal-link-icon:first-of-type {
            margin-left: 0;
        }

        .personal-link-icon:hover {
            color: var(--secondary-color);
        }

    .search-wrapper {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 1rem;
    }

    .search-container {
        position: relative;
        max-width: 250px;
        width: 100%;
        margin-right: 0.5rem;
    }

    #athleteSearch {
        width: 100%;
        padding: 0.5rem 2.5rem 0.5rem 1rem;
        border: 2px solid var(--primary-color);
        border-radius: 25px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
        outline: none;
        box-sizing: border-box;
    }

        #athleteSearch:focus {
            border-color: var(--secondary-color);
        }

    .search-icon {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--primary-color);
        font-size: 1.2rem;
        pointer-events: none;
        z-index: 2;
    }

    .clear-icon {
        position: absolute;
        right: 3rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--primary-color);
        font-size: 1.2rem;
        cursor: pointer;
        z-index: 2;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }

        .clear-icon.visible {
            opacity: 1;
            visibility: visible;
        }

        .clear-icon:hover {
            color: var(--secondary-color);
        }

    .visually-hidden {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        border: 0;
    }

    .highlight {
        background-color: rgba(255, 255, 0, 0.5);
        color: #000;
    }

    #comingSoon {
        font-size: 0.5rem;
        font-weight: normal;
    }

    .leaderboard table tbody tr,
    .podium-item {
        transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .fade-out {
        opacity: 0;
        transition: opacity 0.4s ease;
    }

    .no-results {
        color: var(--primary-color);
        font-weight: bold;
        text-align: center;
        padding: 1rem;
        font-size: 1.2rem;
    }

    .filter-section {
        margin-bottom: 1.5rem;
    }

        .filter-section h3 {
            margin-bottom: 0.5rem;
            color: var(--secondary-color);
            font-size: 1.2rem;
        }

        .filter-section ul {
            list-style-type: none;
            padding: 0;
        }

        .filter-section li {
            margin-bottom: 0.5rem;
        }

        .filter-section label {
            display: flex;
            align-items: center;
            cursor: pointer;
            color: #555;
            transition: color 0.2s;
        }

        .filter-section input[type="checkbox"] {
            margin-right: 0.5rem;
            accent-color: var(--primary-color);
        }

        .filter-section label:hover {
            color: var(--primary-color);
        }

        .filter-section input[type="checkbox"]:checked + label {
            font-weight: bold;
            color: var(--secondary-color);
        }

    @media (max-width: 768px) {
        #detailsModal .badge-class {
            pointer-events: none;
            cursor: default;
        }

        .search-container {
            max-width: 100%;
            margin-top: 1rem;
        }

        #athleteSearch {
            padding: 0.5rem 2.5rem 0.5rem 1rem;
            font-size: 1rem;
        }

        .search-icon {
            right: 1rem;
        }

        .clear-icon {
            right: 3rem;
        }

        .search-wrapper {
            display: flex;
            align-items: center;
        }

        .sidebar-toggle {
            align-self: center;
            margin-top: 1rem;
            height: 40px;
        }

        /* Main Container and Sidebar */
        .main-container {
            flex-direction: column;
        }

        .sidebar {
            width: 100%;
            margin-right: 0;
            margin-bottom: 1rem;
            position: fixed;
            top: 0;
            left: 0;
            width: 70%;
            max-width: 300px;
            height: 100%;
            background-color: var(--card-bg);
            z-index: 999;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            overflow-y: auto;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }

            .sidebar.expanded {
                display: block;
                transform: translateX(0);
            }

        .content {
            margin-left: 0;
        }

        /* Podium Styling */
        .podium {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: flex-end;
            gap: 3rem;
            margin: 0;
            padding: 0;
            flex-wrap: wrap;
            width: 100%;
        }

            .podium .athlete-name {
                font-size: 1.5rem;
            }

        .podium-item {
            width: 100%;
        }

            /* Adjust heights for different placements */
            .podium-item.first {
                order: 1;
            }

            .podium-item.second {
                order: 2;
            }

            .podium-item.third {
                order: 3;
            }

        .podium-rank {
            left: 5%;
        }

        .leaderboard table {
            width: 100%;
            table-layout: fixed;
        }

            .leaderboard table td .badge-section {
                display: none;
            }

            .leaderboard table th {
                font-size: 0.6rem;
            }

            .leaderboard table td {
                font-size: 0.8rem;
            }

        .leaderboard .portrait {
            width: 40px;
            height: 40px;
        }
    }

    .league-link {
        color: var(--primary-color);
        text-decoration: underline;
        transition: color 0.2s ease;
    }

        .league-link:hover {
            color: var(--secondary-color);
        }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .fade-in-element {
        animation: fadeIn 0.6s ease-in-out;
    }

    @keyframes expandCircle {
        from {
            transform: scale(0.5);
            opacity: 0;
        }

        to {
            transform: scale(1);
            opacity: 1;
        }
    }

    #targetShootingVisualization {
        animation: expandCircle 1s ease-in-out;
    }

    .modal-link {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1.2rem;
        color: var(--primary-color);
        text-decoration: none;
        transition: color 0.3s ease;
    }

        .modal-link:hover {
            color: var(--secondary-color);
        }

        .modal-link i {
            font-size: 1.8rem;
            line-height: 1;
        }

    @keyframes pop {
        0% {
            transform: scale(0);
            opacity: 0;
        }

        100% {
            transform: scale(1);
            opacity: 1;
        }
    }

    /* when guessing, hide all modal-content children except the athlete-profile */
    .modal-content.guess-mode > :not(.athlete-profile) {
        display: none;
    }

    /* during guess mode, hide everything under athlete-profile except pic, name & slider */
    .modal-content.guess-mode .athlete-profile > *:not(#modalProfilePic):not(#guessAgeContainer) {
        display: none;
    }

    /* ✨ card container */
    .gma-card {
        width: min(420px, 90%);
        margin-inline: auto;
        background: var(--card-bg);
        border-radius: 1.25rem;
        padding: 2rem 2.25rem 2.5rem;
        text-align: center;
    }

    /* avatar with subtle hover zoom */
    .gma-avatar {
        margin: 0 0 1.25rem;
        display: inline-block;
        aspect-ratio: 1;
        width: 144px;
        border-radius: 50%;
        overflow: hidden;
        background: var(--card-bg);
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

        .gma-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform .25s cubic-bezier(.4,0,.2,1);
        }

        .gma-avatar:hover img {
            transform: scale(1.06);
        }

    /* headline & helper text */
    .gma-heading {
        font-size: 2rem;
        margin: 0 0 2.5rem;
        color: var(--dark-text-color);
        font-weight: 700;
    }

    /* make the guess‐container fill the modal’s width */
    #guessAgeContainer {
        width: 100%;
        box-sizing: border-box; /* include any padding in that 100% */
    }

    /* let the slider wrap fill all of that */
    .gma-slider-wrap {
        position: relative;
        width: 90%;
        max-width: none; /* override any upstream caps */
        margin: 2rem auto; /* 2rem top/bottom, auto left/right to center */
        padding-top: 3rem; /* space for bubble */
        align-self: stretch; /* <-- this forces it to span the full parent width */
    }

    /* slider track */
    #gmaRange {
        width: 100%;
        height: 3rem;
        appearance: none;
        background: linear-gradient( 90deg, var(--primary-color) 0%, var(--primary-color) var(--percent, 50%), #d1d5db var(--percent, 50%), #d1d5db 100% );
        border-radius: 999px;
        outline: none;
    }

        /* WebKit thumb */
        #gmaRange::-webkit-slider-thumb {
            appearance: none;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: var(--primary-color);
            border: 4px solid #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: transform .2s ease;
        }

        #gmaRange:active::-webkit-slider-thumb {
            transform: scale(1.15);
        }

        /* Firefox track and thumb */
        #gmaRange::-moz-range-track {
            background: linear-gradient( 90deg, var(--primary-color) 0%, var(--primary-color) var(--percent, 50%), #d1d5db var(--percent, 50%), #d1d5db 100% );
            height: .5rem;
            border-radius: 999px;
            border: none;
        }

        #gmaRange::-moz-range-thumb {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: var(--primary-color);
            border: 4px solid #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            transition: transform .2s ease;
        }

    #gmaBubble {
        position: absolute;
        bottom: calc(50% + 0.5rem);
        left: var(--percent, 50%);
        transform: translateX(-50%);
        background: #fff;
        color: var(--primary-color);
        font-size: 2.8rem;
        font-weight: 600;
        padding: 0.8rem 1.6rem;
        border: 2px solid var(--primary-color);
        border-radius: 2rem;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        pointer-events: none;
        white-space: nowrap;
        z-index: 10;
    }

        #gmaBubble::after {
            content: '';
            position: absolute;
            bottom: -10px;
            width: 20px;
            height: 20px;
            left: 50%;
            transform: translateX(-50%) rotate(45deg);
            background: #fff;
            border-left: 4px solid var(--primary-color);
            border-bottom: 4px solid var(--primary-color);
        }

    @keyframes bubblePulse {
        0%,100% {
            transform: translateX(-50%) scale(1);
        }

        50% {
            transform: translateX(-50%) scale(1.05);
        }
    }

    /* action buttons */
    .gma-actions {
        display: flex;
        justify-content: center;
        gap: 1rem;
    }

    .gma-btn {
        padding: 0.7rem 1.6rem;
        font-size: .95rem;
        border: none;
        border-radius: 999px;
        cursor: pointer;
        font-weight: 600;
        transition: background .25s cubic-bezier(.4,0,.2,1), color .25s cubic-bezier(.4,0,.2,1);
    }

    .gma-btn--primary {
        background: var(--primary-color);
        color: #fff;
    }

        .gma-btn--primary:hover {
            background: var(--secondary-color);
        }

    .gma-btn--ghost {
        background: transparent;
        color: var(--primary-color);
        border: 2px solid var(--primary-color);
    }

        .gma-btn--ghost:hover {
            background: var(--primary-color);
            color: #fff;
        }

    /* small screens - keep it tight */
    @media (max-width: 420px) {
        .gma-card {
            padding: 1.5rem 1.25rem;
        }

        .gma-avatar {
            width: 116px;
        }
    }

    /* fade-out and remove when done */
    .gma-card.gma-done {
        opacity: 0;
        height: 0;
        overflow: hidden;
        transition: opacity .3s ease, height .3s ease;
        pointer-events: none;
    }
</style>

<div class="main-container">

    <div class="content">
        <div class="podium">
            <!-- Podium items will be dynamically inserted here -->
        </div>

        <div class="search-wrapper">
            <div class="search-container" data-aos="fade" data-aos-duration="700" data-aos-delay="700">
                <label for="athleteSearch" class="visually-hidden">Search Athletes</label>
                <input type="text" id="athleteSearch" placeholder="Search Athlete..." aria-label="Search Athletes">
                <span class="search-icon"><i class="fa fa-search"></i></span>
                <span class="clear-icon" tabindex="0" role="button" aria-label="Clear Search">
                    <i class="fa fa-times"></i>
                </span>
            </div>
            <button class="sidebar-toggle" aria-label="Toggle Sidebar" title="Show Leagues" data-aos="fade" data-aos-duration="700" data-aos-delay="650">
                <i class="fa fa-sliders-h"></i>
            </button>
        </div>

        <div class="leaderboard">
            <div class="sidebar">
                <button class="sidebar-close" aria-label="Hide Leagues" title="Hide Leagues"><i class="fa fa-chevron-left" style="font-size: 12px;"></i></button>
                <h2 class="sidebar-title" data-aos="fade" data-aos-duration="700" data-aos-delay="200">
                    <span class="sidebar-icon"><i class="fa fa-trophy"></i></span>
                    <span class="sidebar-title-text">Leagues</span>
                </h2>
                <div class="collapsed-title" data-aos="fade" data-aos-duration="700" data-aos-delay="200">ULTIMATE LEAGUE</div>
                <div class="filter-section" data-aos="fade" data-aos-duration="700" data-aos-delay="200">
                    <h3>Divisions</h3>
                    <ul></ul> <!-- This will be populated dynamically -->
                </div>

                <div class="filter-section" id="generation-filter-section">
                    <h3>Generations</h3>
                    <ul></ul> <!-- This will be populated dynamically -->
                </div>
                <div class="filter-section" id="exclusive-filter-section">
                    <h3>Exclusive</h3>
                    <ul></ul> <!-- This will be populated dynamically -->
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Athlete</th>
                        <th>
                            Sponsor<br />
                            <a href="https://github.com/nopara73/LongevityWorldCup/issues/74" target="_blank" rel="noopener" style="color: #999; text-decoration: underline; cursor: pointer;"
                               onmouseover="this.style.color='var(--secondary-color)';"
                               onmouseout="this.style.color='#999';">
                                <span id="comingSoon">
                                    coming soon
                                </span>
                            </a>
                        </th>
                        <th>
                            <a href="https://github.com/nopara73/LongevityWorldCup/blob/master/LongevityWorldCup.Documentation/Ruleset.md#point-system" target="_blank" rel="noopener" style="color: var(--primary-color); text-decoration: underline; cursor: pointer;"
                               onmouseover="this.style.color='var(--secondary-color)';"
                               onmouseout="this.style.color='var(--primary-color)';">
                                Age Reduction
                            </a>
                        </th>
                        <th>Media Contact</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Table rows will be dynamically inserted here -->
                </tbody>
            </table>
        </div>

        <div id="detailsModal" class="modal">
            <div class="modal-content">
                <span id="closeAthleteDetailsModal" class="close">&times;</span>

                <div class="athlete-profile">
                    <img id="modalProfilePic"
                         src=""
                         alt="Athlete Profile Picture"
                         class="illustration"
                         loading="lazy" />
                    <h2 id="athleteName"></h2>

                    <!-- GUESS-MY-AGE  — prettified -->
                    <div id="guessAgeContainer">
                        <h3 class="gma-heading">Guess my age!</h3>

                        <div class="gma-slider-wrap">
                            <input type="range"
                                   min="0"
                                   max="120"
                                   value="30"
                                   id="gmaRange"
                                   aria-label="Guess athlete’s age — 0 to 120 years" />

                            <output for="gmaRange" id="gmaBubble">30</output>
                        </div>

                        <div class="gma-actions">
                            <button class="gma-btn gma-btn--primary">Submit</button>
                            <button class="gma-btn gma-btn--ghost">Skip</button>
                        </div>
                    </div>

                    <div id="modalBadgeStrip" class="modal-badge-strip"></div>
                    <p id="athleteBio"></p>
                    <div class="age-visualization" id="ageVisualization" style="margin-top: 2rem; text-align: center;">
                        <div id="targetShootingVisualization" style="width: 150px; height: 150px; margin: 0 auto;">
                            <!-- Visualization will be dynamically generated here -->
                        </div>
                    </div>
                    <div class="athlete-info">
                        <p><strong>Best Rank:</strong> <span id="athleteRank"></span></p>
                        <p><strong>Division:</strong> <span id="athleteDivision"></span></p>
                        <p><strong>Generation:</strong> <span id="athleteGeneration"></span></p>
                        <p><strong>Flag:</strong> <span id="athleteFlag"></span></p>
                        <p><strong>Chronological Age:</strong> <span id="chronologicalAge"></span> years</p>
                        <p><strong>Lowest PhenoAge:</strong> <span id="lowestPhenoAge"></span> years</p>
                        <p><strong> <span id="ageReductionAccelerationLabel">Age Reduction/Acceleration:</span></strong> <span id="ageReduction"></span> years</p>
                    </div>
                    <div class="athlete-links">
                        <a id="personalLink" href="#" target="_blank" rel="noopener" class="modal-link" aria-label="Visit the athlete's personal page">
                            <i class="fa fa-link"></i> Personal Page
                        </a>
                        <a id="mediaContact" href="#" target="_blank" rel="noopener" class="modal-link" aria-label="Contact the athlete">
                            <i class="fa fa-envelope"></i> Media Contact
                        </a>
                    </div>
                </div>

                <div class="biomarkers-section">
                    <h3>Biomarkers Over Time</h3>
                    <canvas id="biomarkerChart" style="width: 100%; height: 300px;"></canvas>
                </div>

                <div class="proofs-section">
                    <h3>Proofs</h3>
                    <div class="proofs-gallery" id="proofsGallery">
                        <!-- Proof images will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<template id="enlargedPortraitTemplate">
    <div class="enlarged-portrait">
        <img src="" alt="" loading="lazy">
        <span class="close-btn">&times;</span>
    </div>
</template>

<template id="leaderboardRowTemplate">
    <tr>
        <td data-label="Rank" class="rank-td">
            <span class="rank"></span>
        </td>
        <td data-label="Athlete" class="athlete-td">
            <img src="" alt="" class="portrait" loading="lazy">
            <span class="athlete-name" title="View stats"></span>
            <div class="badge-section"></div>
        </td>
        <td data-label="Sponsor" class="sponsor-td"></td>
        <td data-label="Age Reduction" class="age-reduction-td">
            <span class="age-reduction"></span>
        </td>
        <td data-label="Media Contact" class="media-contact-td"></td>
    </tr>
</template>

<script>
    let athleteResults = [];

    let includePodiumGlobal = true
    let maxAthletesGlobal = Infinity;

    function LoadLeaderboard(includePodium = true, maxAthletes = Infinity) {
        includePodiumGlobal = includePodium;
        maxAthletesGlobal = maxAthletes;

        fetch('/api/data/athletes')
            .then(response => response.json())
            .then(athletes => {
                // Array to store athletes with their lowest PhenoAge and age reduction
                var viewAllAthletesBtn = document.getElementById('viewAllAthletesBtn');
                if (viewAllAthletesBtn) {
                    document.getElementById('viewAllAthletesBtn').textContent = `VIEW ALL ATHLETES (${athletes.length})`;
                }
                athleteResults = athletes.map(athlete => {
                    // Calculate the chronological age from the athlete's DateOfBirth
                    const dob = new Date(
                        athlete.DateOfBirth.Year,
                        athlete.DateOfBirth.Month - 1, // Months are zero-indexed in JavaScript Date
                        athlete.DateOfBirth.Day
                    );
                    const chronologicalAge = window.PhenoAge.calculateAgeFromDOB(dob);

                    // Get birth year and generation
                    const birthYear = athlete.DateOfBirth.Year;
                    const generation = window.getGeneration(birthYear);

                    // Create an object to store the best biomarker values from all sets
                    let bestBiomarkers = {
                        AlbGL: null,          // Albumin (higher is better)
                        CreatUmolL: null,     // Creatinine (lower is better)
                        GluMmolL: null,       // Glucose (lower is better)
                        CrpMgL: null,         // CRP (lower is better)
                        Wbc1000cellsuL: null, // White blood cell count (lower is better)
                        LymPc: null,          // Lymphocytes (higher is better)
                        McvFL: null,          // Mean corpuscular volume (lower is better)
                        RdwPc: null,          // Red cell distribution width (lower is better)
                        AlpUL: null           // Alkaline phosphatase (lower is better)
                    };

                    // Iterate through each biomarker set to update the best values
                    athlete.Biomarkers.forEach(biomarkerSet => {
                        // Albumin: negative coefficient means higher is better
                        if (bestBiomarkers.AlbGL === null || biomarkerSet.AlbGL > bestBiomarkers.AlbGL) {
                            bestBiomarkers.AlbGL = biomarkerSet.AlbGL;
                        }
                        // Creatinine: positive coefficient means lower is better
                        if (bestBiomarkers.CreatUmolL === null || biomarkerSet.CreatUmolL < bestBiomarkers.CreatUmolL) {
                            bestBiomarkers.CreatUmolL = biomarkerSet.CreatUmolL;
                        }
                        // Glucose: positive coefficient means lower is better
                        if (bestBiomarkers.GluMmolL === null || biomarkerSet.GluMmolL < bestBiomarkers.GluMmolL) {
                            bestBiomarkers.GluMmolL = biomarkerSet.GluMmolL;
                        }
                        // CRP: positive coefficient means lower is better
                        if (bestBiomarkers.CrpMgL === null || biomarkerSet.CrpMgL < bestBiomarkers.CrpMgL) {
                            bestBiomarkers.CrpMgL = biomarkerSet.CrpMgL;
                        }
                        // White blood cell count: positive coefficient means lower is better
                        if (bestBiomarkers.Wbc1000cellsuL === null || biomarkerSet.Wbc1000cellsuL < bestBiomarkers.Wbc1000cellsuL) {
                            bestBiomarkers.Wbc1000cellsuL = biomarkerSet.Wbc1000cellsuL;
                        }
                        // Lymphocytes: negative coefficient means higher is better
                        if (bestBiomarkers.LymPc === null || biomarkerSet.LymPc > bestBiomarkers.LymPc) {
                            bestBiomarkers.LymPc = biomarkerSet.LymPc;
                        }
                        // Mean corpuscular volume: positive coefficient means lower is better
                        if (bestBiomarkers.McvFL === null || biomarkerSet.McvFL < bestBiomarkers.McvFL) {
                            bestBiomarkers.McvFL = biomarkerSet.McvFL;
                        }
                        // Red cell distribution width: positive coefficient means lower is better
                        if (bestBiomarkers.RdwPc === null || biomarkerSet.RdwPc < bestBiomarkers.RdwPc) {
                            bestBiomarkers.RdwPc = biomarkerSet.RdwPc;
                        }
                        // Alkaline phosphatase: positive coefficient means lower is better
                        if (bestBiomarkers.AlpUL === null || biomarkerSet.AlpUL < bestBiomarkers.AlpUL) {
                            bestBiomarkers.AlpUL = biomarkerSet.AlpUL;
                        }
                    });

                    let phenoAgeDifference = 0;
                    // Only proceed if there are submissions.
                    if (athlete.Biomarkers.length > 0) {
                        // Get the first and last biomarker submissions.
                        const firstSubmission = athlete.Biomarkers[0];
                        const lastSubmission = athlete.Biomarkers[athlete.Biomarkers.length - 1];

                        // Prepare the biomarker values for the first submission.
                        const firstSubmissionValues = [
                            chronologicalAge,
                            firstSubmission.AlbGL,
                            firstSubmission.CreatUmolL,
                            firstSubmission.GluMmolL,
                            Math.log(firstSubmission.CrpMgL / 10),
                            firstSubmission.Wbc1000cellsuL,
                            firstSubmission.LymPc,
                            firstSubmission.McvFL,
                            firstSubmission.RdwPc,
                            firstSubmission.AlpUL
                        ];

                        // Prepare the biomarker values for the last submission.
                        const lastSubmissionValues = [
                            chronologicalAge,
                            lastSubmission.AlbGL,
                            lastSubmission.CreatUmolL,
                            lastSubmission.GluMmolL,
                            Math.log(lastSubmission.CrpMgL / 10),
                            lastSubmission.Wbc1000cellsuL,
                            lastSubmission.LymPc,
                            lastSubmission.McvFL,
                            lastSubmission.RdwPc,
                            lastSubmission.AlpUL
                        ];

                        // Calculate the PhenoAges for the first and last submissions.
                        const firstPhenoAge = window.PhenoAge.calculatePhenoAge(firstSubmissionValues);
                        const lastPhenoAge = window.PhenoAge.calculatePhenoAge(lastSubmissionValues);

                        // Compute the difference between the last and first PhenoAges.
                        phenoAgeDifference = lastPhenoAge - firstPhenoAge;
                    }

                    const submissionCount = athlete.Biomarkers.length;

                    // Prepare the biomarker values array in the order required for the PhenoAge calculation
                    const bestBiomarkerValues = [
                        chronologicalAge,
                        bestBiomarkers.AlbGL,
                        bestBiomarkers.CreatUmolL,
                        bestBiomarkers.GluMmolL,
                        Math.log(bestBiomarkers.CrpMgL / 10), // Apply log transformation to CRP (converting mg/L to µg/L)
                        bestBiomarkers.Wbc1000cellsuL,
                        bestBiomarkers.LymPc,
                        bestBiomarkers.McvFL,
                        bestBiomarkers.RdwPc,
                        bestBiomarkers.AlpUL
                    ];

                    // Initialize a variable to keep track of the lowest PhenoAge for this athlete
                    let lowestPhenoAge = Infinity;
                    lowestPhenoAge = window.PhenoAge.calculatePhenoAge(bestBiomarkerValues);

                    // Calculate the age reduction
                    const ageReduction = lowestPhenoAge - chronologicalAge;

                    return {
                        name: athlete.Name,
                        mediaContact: athlete.MediaContact,
                        dateOfBirth: dob,
                        chronologicalAge: chronologicalAge,
                        lowestPhenoAge: lowestPhenoAge,
                        ageReduction: ageReduction,
                        bestBiomarkerValues: bestBiomarkerValues,
                        personalLink: athlete.PersonalLink,
                        profilePic: athlete.ProfilePic,
                        division: athlete.Division,
                        generation: generation,
                        exclusiveLeague: athlete.ExclusiveLeague,
                        submissionCount: submissionCount,
                        phenoAgeDifference: phenoAgeDifference
                    };
                });

                generateDivisionFilters(athleteResults);
                generateGenerationFilters(athleteResults);
                generateExclusiveFilters(athleteResults);

                // Sort the athletes by age reduction in ascending order
                athleteResults.sort(window.compareAthleteRank);

                // Assign ranks to each athlete based on the sorted order
                athleteResults.forEach((athlete, index) => { athlete.rank = index + 1; });

                // Initialize a 'ranks' object for each athlete to store ranks based on different criteria
                athleteResults.forEach(athlete => { athlete.ranks = {}; });

                // Assign ranks based on divisions
                const divisions = [...new Set(athleteResults.map(athlete => athlete.division))];
                divisions.forEach(division => {
                    const athletesInDivision = athleteResults.filter(athlete => athlete.division === division);
                    athletesInDivision.sort(window.compareAthleteRank);
                    athletesInDivision.forEach((athlete, index) => {
                        athlete.ranks[division] = index + 1;
                    });
                });

                // Assign ranks based on generations
                const generations = [...new Set(athleteResults.map(athlete => athlete.generation))];
                generations.forEach(generation => {
                    const athletesInGeneration = athleteResults.filter(athlete => athlete.generation === generation);
                    athletesInGeneration.sort(window.compareAthleteRank);
                    athletesInGeneration.forEach((athlete, index) => {
                        athlete.ranks[generation] = index + 1;
                    });
                });

                // Assign ranks based on combinations of division and generation
                divisions.forEach(division => {
                    generations.forEach(generation => {
                        const athletesInCombo = athleteResults.filter(
                            athlete => athlete.division === division && athlete.generation === generation
                        );
                        athletesInCombo.sort(window.compareAthleteRank);
                        athletesInCombo.forEach((athlete, index) => {
                            const key = `${generation}_${division}`;
                            athlete.ranks[key] = index + 1;
                        });
                    });
                });

                const podiumCount = includePodium ? 3 : 0;

                if (includePodium) {
                    // Fetch the total prize fund from the backend API and calculate prize money
                    fetch(`/api/bitcoin/total-received?address=${window.bitcoinDonationAddress}`)
                        .then(response => response.json())
                        .then(data => {
                            const totalReceivedSatoshis = data.totalReceivedSatoshis;
                            const totalReceivedBTC = totalReceivedSatoshis / 1e8;
                            const prizeFundBTC = totalReceivedBTC * 0.9; // 90% of total received

                            // Fetch current BTC to USD exchange rate
                            fetch(`/api/bitcoin/btcusd`)
                                .then(response => response.json())
                                .then(tickerData => {
                                    const btcToUsdRate = tickerData.btcToUsdRate;

                                    // Calculate prize moneys
                                    const firstPlaceBTC = prizeFundBTC * 0.6;
                                    const secondPlaceBTC = prizeFundBTC * 0.25;
                                    const thirdPlaceBTC = prizeFundBTC * 0.15;

                                    const firstPlaceUSD = firstPlaceBTC * btcToUsdRate;
                                    const secondPlaceUSD = secondPlaceBTC * btcToUsdRate;
                                    const thirdPlaceUSD = thirdPlaceBTC * btcToUsdRate;

                                    const prizeMoney = {
                                        1: { btc: firstPlaceBTC.toFixed(8) + " BTC", amount: "$" + firstPlaceUSD.toFixed(2) },
                                        2: { btc: secondPlaceBTC.toFixed(8) + " BTC", amount: "$" + secondPlaceUSD.toFixed(2) },
                                        3: { btc: thirdPlaceBTC.toFixed(8) + " BTC", amount: "$" + thirdPlaceUSD.toFixed(2) }
                                    };
                                    // Get the top three athletes from athleteResults
                                    const topThree = athleteResults.slice(0, 3);

                                    // Select the podium container and clear existing items
                                    const podium = document.querySelector('.podium');
                                    podium.innerHTML = ''; // Clear any existing podium items

                                    // Loop through the top three athletes and create podium items
                                    topThree.forEach(athlete => {
                                        let rankClass, rankEmoji;

                                        switch (athlete.rank) {
                                            case 1:
                                                rankClass = 'first';
                                                rankEmoji = '<i class="fa-solid fa-crown" style="color: gold;"></i>';
                                                break;
                                            case 2:
                                                rankClass = 'second';
                                                rankEmoji = '<i class="fa-solid fa-medal" style="color: silver;"></i>';
                                                break;
                                            case 3:
                                                rankClass = 'third';
                                                rankEmoji = '<i class="fa-solid fa-award" style="color: #cd7f32;"></i>';
                                                break;
                                            default:
                                                return; // Only handle top three
                                        }

                                        // Create the podium-item div
                                        const podiumItem = document.createElement('div');
                                        podiumItem.classList.add('podium-item', rankClass);

                                        // Populate the inner HTML of podiumItem
                                        podiumItem.innerHTML = `
                                            <div class="podium-rank" title="${athlete.rank === 1 ? '1st Place' : athlete.rank === 2 ? '2nd Place' : '3rd Place'}">
                                                ${rankEmoji}
                                            </div>
                                            <img src="${athlete.profilePic}" alt="${athlete.name} portrait" class="podium-portrait" loading="lazy">
                                            <div>
                                                <span class="athlete-name" style="cursor: pointer;" title="View stats of ${athlete.name}">${athlete.name}</span>
                                                ${athlete.personalLink ? `<a href="${athlete.personalLink.startsWith('http') ? athlete.personalLink : 'https://' + athlete.personalLink}" target="_blank" rel="noopener"  class="personal-link-icon" aria-label="Visit athlete's personal page" title="Visit personal page of ${athlete.name}">
                                                <i class="fa fa-link"></i>
                                                </a>` : ''}
                                                ${renderMediaContact(athlete.mediaContact, true, athlete.name)}
                                            </div>
                                            <div><span class="age-reduction">${Math.abs(athlete.ageReduction.toFixed(1))} years</span> reduced</div>
                                            <div class="podium-item-lower">
                                                <div class="btc-amount">(${prizeMoney[athlete.rank].btc})</div>
                                                <div class="prize-money">${prizeMoney[athlete.rank].amount}</div>
                                            </div>
                                        `;

                                        // Append the podiumItem to the podium container
                                        podium.appendChild(podiumItem);

                                        // After appending the podium item
                                        podiumItem.setAttribute('data-division', athlete.division.toLowerCase());
                                        podiumItem.setAttribute('data-generation', athlete.generation.toLowerCase());
                                        podiumItem.setAttribute('data-athlete-name', athlete.name);
                                        podiumItem.setAttribute('data-aos', 'fade');
                                        podiumItem.setAttribute('data-aos-duration', '700');
                                        podiumItem.setAttribute('data-aos-delay', '50');

                                        subscribeLowerPodiumClick();
                                    });

                                    // Attach click event listeners to athlete names
                                    attachAthleteNameClickListeners();
                                    applyCamelCaseNewlines();

                                    addClickListenerToImages('.portrait, .podium-portrait, #modalProfilePic', function () {
                                        openEnlargedView(this);
                                    });
                                })
                                .catch(error => {
                                    console.error('Error fetching BTC exchange rate:', error);
                                });
                        })
                        .catch(error => {
                            console.error('Error fetching total prize fund:', error);
                        });
                } else {
                    // Hide the podium container if not included
                    const podium = document.querySelector('.podium');
                    if (podium) {
                        podium.style.display = 'none';
                    }
                }

                window.computeBadges(athleteResults);

                // Populate the table with athletes ranked >3
                const tableBody = document.querySelector('.leaderboard table tbody');
                const remainingAthletes = athleteResults;

                tableBody.innerHTML = ''; // Clear existing table rows
                remainingAthletes.forEach((athlete, index) => {
                    const template = document.getElementById('leaderboardRowTemplate');
                    const row = template.content.firstElementChild.cloneNode(true);

                    row.querySelector('.rank').textContent = athlete.rank;
                    const athleteCell = row.querySelector('.athlete-td');
                    const portraitImg = athleteCell.querySelector('img.portrait');
                    portraitImg.src = athlete.profilePic;
                    portraitImg.alt = `${athlete.name} portrait`;
                    const athleteNameSpan = athleteCell.querySelector('.athlete-name');
                    athleteNameSpan.textContent = athlete.name;
                    athleteNameSpan.title = `View stats of ${athlete.name}`;

                    window.setBadges(athlete, athleteCell);

                    const ageReductionSpan = row.querySelector('.age-reduction');
                    ageReductionSpan.textContent = (athlete.ageReduction > 0 ? '+' : '') + athlete.ageReduction.toFixed(1) + ' years';

                    const mediaContactCell = row.querySelector('.media-contact-td');
                    mediaContactCell.innerHTML = renderMediaContact(athlete.mediaContact, false, athlete.name);

                    row.setAttribute('data-division', athlete.division.toLowerCase().trim());
                    row.setAttribute('data-generation', athlete.generation.trim());
                    row.setAttribute('data-athlete-name', athlete.name);
                    row.setAttribute('data-aos', 'fade');
                    row.setAttribute('data-aos-duration', '700');
                    row.setAttribute('data-aos-delay', '50');

                    if (includePodium && athlete.rank <= podiumCount) {
                        row.style.display = 'none';
                        row.classList.add('podium-athlete');
                    }

                    if (index >= maxAthletes) {
                        row.style.display = 'none';
                        row.classList.add('extra-athlete');
                    }

                    attachAthleteNameClickListeners();
                    applyCamelCaseNewlines();
                    addClickListenerToImages('.portrait, .podium-portrait, #modalProfilePic', function () {
                        openEnlargedView(this);
                    });

                    tableBody.appendChild(row);
                });

                // At the end of the athlete fetch block in LoadLeaderboard, after athleteResults has been populated:
                const urlParams = new URLSearchParams(window.location.search);
                const athleteParam = new URLSearchParams(window.location.search).get('athlete') || '';
                if (athleteParam) {
                    const normalizedAthlete = window.slugifyName(athleteParam, false);
                    const athleteData = getAthleteData(normalizedAthlete);
                    if (athleteData) {
                        fetchFullAthleteData(normalizedAthlete, athleteData);
                    } else {
                        // Redirect to the .NET 404 endpoint
                        window.location.href = '/error/404';
                    }
                } else {
                    let searchOrFilterApplied = false; // Flag to check if filter was applied
                    const searchParam = new URLSearchParams(window.location.search).get('search') || '';
                    if (searchParam) {
                        var query = decodeURIComponent(searchParam);
                        const searchInput = document.getElementById('athleteSearch');
                        searchInput.value = query;
                        searchOrFilterApplied = true;
                    }

                    const filtersParam = new URLSearchParams(window.location.search).get('filters');
                    if (filtersParam) {
                        // Double-decode the parameter in case it was double encoded (e.g. baby%2520boomers becomes "baby boomers")
                        const decodedFilters = decodeURIComponent(decodeURIComponent(filtersParam));
                        const filtersList = decodedFilters.split(',');
                        filtersList.forEach(filterValue => {
                            const normalizedFilter = filterValue.trim().toLowerCase();
                            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                                if (checkbox.value.toLowerCase() === normalizedFilter) {
                                    checkbox.checked = true;
                                }
                            });
                        });
                        searchOrFilterApplied = true;
                    }

                    if (searchOrFilterApplied) {
                        debounceFilterAthletes();

                        // Even here scroll to the search when filter applied because the table kinda starts there conceptually
                        setTimeout(() => {
                            searchInput.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 1000);
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching athletes:', error);
            });
    };

    function subscribeLowerPodiumClick() {
        const targetElement = document.querySelector("#donation-section");
        if (!targetElement) {
            console.error("Donation section (#donation-section) not found.");
            return;
        }

        document.querySelectorAll('.podium-item-lower').forEach(moneyArea => {
            moneyArea.addEventListener('click', () => {
                targetElement.scrollIntoView({ behavior: 'smooth' });
            });
        });
    }

    // Usage
    addClickListenerToImages('.portrait, .podium-portrait, #modalProfilePic', function () {
        openEnlargedView(this);
    });

    // Function to attach click event listener to all athlete-name elements
    function attachAthleteNameClickListeners() {
        document.querySelectorAll('.athlete-name').forEach(athleteNameElement => {
            athleteNameElement.removeEventListener('click', handleAthleteNameClick); // Remove existing listeners to prevent duplicates
            athleteNameElement.addEventListener('click', handleAthleteNameClick);
        });
    }

    function openEnlargedView(imgElement) {
        // Retrieve and clone the template content
        const template = document.getElementById("enlargedPortraitTemplate");
        const clone = template.content.firstElementChild.cloneNode(true);

        // Set the image source and alt attributes based on the clicked image
        const img = clone.querySelector("img");
        img.src = imgElement.src;
        img.alt = imgElement.alt;

        // Append the cloned element to the document (it will be added where it fits in your DOM structure)
        document.body.appendChild(clone);
        document.body.classList.add('no-scroll');
        history.pushState({ modal: 'enlarged' }, "");

        // Trigger a transition to show the element
        setTimeout(() => clone.classList.add('show'), 10);

        // Add event listener for the close button
        clone.querySelector('.close-btn').addEventListener('click', () => {
            closeEnlargedView(clone);
        });

        // Add event listener to close the view when clicking outside the image
        clone.addEventListener('click', (e) => {
            if (e.target === clone) {
                closeEnlargedView(clone);
            }
        });
    }

    function closeEnlargedView(enlargedElem) {
        enlargedElem.classList.remove('show');
        setTimeout(() => {
            document.body.removeChild(enlargedElem);
            // If no modal is open, remove the no-scroll class
            if (modal.style.display !== "block") {
                document.body.classList.remove('no-scroll');
            }
        }, 300);
    }

    function renderMediaContact(contact, isPodium, athleteName) {
        const isEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(contact);
        const tooltipText = isEmail ? `Email ${athleteName}` : `Contact ${athleteName}`;
        if (isPodium) {
            return `${isEmail
                ? `<a href="mailto:${contact}" aria-label="Email ${contact}" class="personal-link-icon" style="margin-left: 0.2rem;" title="${tooltipText}">
                ${window.getIcon(contact)}
               </a>`
                : `<a href="${contact.startsWith('http') ? contact : 'https://' + contact}" target="_blank" rel="noopener" aria-label="Contact the athlete" class="personal-link-icon" style="margin-left: 0.2rem;" title="${tooltipText}">
                ${window.getIcon(contact)}
               </a>`
                }`;
        }
        return `${isEmail
            ? `<a href="mailto:${contact}" class="media-contact" aria-label="Email ${contact}" title="${tooltipText}">
            ${window.getIcon(contact)}
           </a>`
            : `<a href="${contact.startsWith('http') ? contact : 'https://' + contact}" target="_blank" rel="noopener" class="media-contact" aria-label="Contact the athlete" title="${tooltipText}">
            ${window.getIcon(contact)}
           </a>`
            }`;
    }

    const modal = document.getElementById("detailsModal");
    const closeBtn = document.getElementById("closeAthleteDetailsModal");
    const athleteDetails = document.getElementById("athleteDetails");
    let ageChart;

    closeBtn.onclick = function () {
        closeModal();
    };

    window.addEventListener('click', function (event) {
        if (event.target === modal) {
            closeModal();
        }
    });

    function closeModal() {
        modal.classList.add('fade-out');
        setTimeout(() => {
            modal.style.display = "none";
            modal.classList.remove('fade-out');
            document.body.classList.remove('no-scroll');

            // Clear the athlete parameter from the URL:
            history.replaceState({}, "", originalAthletelessURL);

            resetPageTitle();
        }, 400);
    }

    function debounceFilterAthletes() {
        toggleClearIcon();
        debouncedFilter();
    }

    function toggleClearIcon() {
        const searchInput = document.getElementById('athleteSearch');
        const clearIcon = document.querySelector('.clear-icon');

        if (searchInput.value.trim().length > 0) {
            clearIcon.classList.add('visible');
        } else {
            clearIcon.classList.remove('visible');
        }
    }

    function clearSearch() {
        const searchInput = document.getElementById('athleteSearch');
        const clearIcon = document.querySelector('.clear-icon');
        const podium = document.querySelector('.podium');

        searchInput.value = '';
        clearIcon.classList.remove('visible');
        window.removeAllHighlights();
        performFilter(); // Reapply filters without search terms

        // Ensure the podium is visible after clearing the search
        podium.style.display = 'flex';

        const url = new URL(window.location.href);
        url.searchParams.delete('search');
        history.replaceState({}, "", url.toString());
    }

    // Wrap the filter function with debounce
    const debouncedFilter = debounce(() => {
        performFilter();
    }, 400);

    function debounce(func, delay) {
        let debounceTimer;
        return function (...args) {
            const context = this;
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => func.apply(context, args), delay);
        };
    }

    function performFilter() {
        // Get selected divisions
        const selectedDivisions = Array.from(document.querySelectorAll('input[name="division"]:checked'))
            .map(checkbox => checkbox.value.toLowerCase());

        // Get selected generations
        const selectedGenerations = Array.from(document.querySelectorAll('input[name="generation"]:checked'))
            .map(checkbox => checkbox.value.toLowerCase());

        // Get selected exclusive leagues (e.g. "Prosperan")
        const selectedExclusiveLeagues = Array.from(document.querySelectorAll('input[name="exclusiveLeague"]:checked'))
            .map(checkbox => checkbox.value.toLowerCase());

        const query = window.normalizeString(document.getElementById('athleteSearch').value.trim().toLowerCase());
        const searchTerms = query.split(/\s+/).filter(term => term.length > 0);
        const uniqueSearchTerms = [...new Set(searchTerms)];

        const showAll = uniqueSearchTerms.length === 0;

        let filteredAthletes = [];

        let anyMatch = false;

        athleteResults.forEach(athlete => {
            const athleteNameNormalized = window.normalizeString(athlete.name);

            let matches = true;

            // Check division match
            if (selectedDivisions.length > 0) {
                matches = matches && selectedDivisions.includes(athlete.division.toLowerCase());
            }

            // Check generation match
            if (selectedGenerations.length > 0) {
                matches = matches && selectedGenerations.includes(athlete.generation.toLowerCase());
            }

            // Check exclusive league match
            if (selectedExclusiveLeagues.length > 0) {
                matches = matches && selectedExclusiveLeagues.includes((athlete.exclusiveLeague || "").toLowerCase());
            }

            // Check search terms
            if (matches && !showAll) {
                matches = uniqueSearchTerms.every(term => athleteNameNormalized.includes(term));
            }

            if (matches) {
                filteredAthletes.push(athlete);
            }
        });

        const unslicedFilteredAthletes = filteredAthletes;

        filteredAthletes = filteredAthletes.slice(0, maxAthletesGlobal);

        // Determine if filters are used
        const filtersUsed = selectedDivisions.length > 0 || selectedGenerations.length > 0 || selectedExclusiveLeagues.length > 0;
        const searchUsed = uniqueSearchTerms.length > 0;

        // If filters are used, reassign ranks starting from 1
        if (filtersUsed && !searchUsed) {
            filteredAthletes.forEach((athlete, index) => {
                athlete.filteredRank = index + 1;
            });
        } else {
            // Keep original ranks
            filteredAthletes.forEach(athlete => {
                athlete.filteredRank = athlete.rank;
            });
        }

        // First, hide all rows
        const tableRows = document.querySelectorAll('.leaderboard table tbody tr');
        tableRows.forEach(row => {
            row.style.display = 'none';
        });

        // Remove 'blurred' class from all podium items
        const podiumItems = document.querySelectorAll('.podium-item');
        podiumItems.forEach(item => {
            item.classList.remove('blurred');
        });

        let anyPodiumVisible = false;

        // Show the rows and podium items for the filtered athletes
        filteredAthletes.forEach(athlete => {
            const athleteName = athlete.name;
            const row = document.querySelector(`.leaderboard table tbody tr[data-athlete-name="${athleteName}"]`);
            if (row) {
                row.style.display = '';
                window.showWithDelay(row);

                // Update the rank cell
                const rankCell = row.querySelector('td[data-label="Rank"] .rank');
                if (rankCell) {
                    rankCell.textContent = athlete.filteredRank;
                }

            }
            const item = document.querySelector(`.podium-item[data-athlete-name="${athleteName}"]`);
            if (item) {
                item.style.display = '';
                anyPodiumVisible = true;
            }
        });

        // Remove existing highlights
        window.removeAllHighlights();

        // Highlight search terms
        document.querySelectorAll('.athlete-name').forEach(athleteNameElement => {
            const athleteNameText = athleteNameElement.textContent;
            const athleteNameNormalized = window.normalizeString(athleteNameText);

            // Check if the athlete is in filteredAthletes
            const athleteInFiltered = filteredAthletes.some(athlete => athlete.name === athleteNameText);
            if (athleteInFiltered) {
                window.highlightText(athleteNameElement, uniqueSearchTerms);
            }
        });

        // Update the counts in the filter sections
        updateFilterCounts(unslicedFilteredAthletes);

        // Add or remove 'blurred' class from podium items based on filtering
        podiumItems.forEach(item => {
            const athleteName = item.getAttribute('data-athlete-name');
            const athleteInFiltered = filteredAthletes.some(athlete => athlete.name === athleteName);
            if (athleteInFiltered) {
                // Remove 'blurred' class
                item.classList.remove('blurred');
            } else {
                // Add 'blurred' class
                item.classList.add('blurred');
            }
        });

        updateCollapsedTitle(selectedDivisions, selectedGenerations, selectedExclusiveLeagues);

        // Display "No Results Found" if Necessary
        displayNoResults(tableRows, podiumItems, query);

        // Hide podium athletes' rows if no filters/search are applied and includePodiumGlobal is true
        if (includePodiumGlobal && selectedDivisions.length === 0 && selectedGenerations.length === 0 && selectedExclusiveLeagues.length === 0 && uniqueSearchTerms.length === 0) {
            document.querySelectorAll('.leaderboard table tbody tr.podium-athlete').forEach(row => {
                row.style.display = 'none';
            });
        }

        if (typeof AOS !== 'undefined') {
            AOS.refresh();
            applyCamelCaseNewlines(); // Reapply the camelCase fix AFTER AOS refresh
        }

        const url = new URL(window.location.href);
        url.hash = ""; // <- this line removes #ABCD or any other fragment

        if (query === "") {
            url.searchParams.delete('search');
        } else {
            url.searchParams.set('search', encodeURIComponent(query));
        }

        const filters = [...selectedDivisions, ...selectedGenerations, ...selectedExclusiveLeagues];
        if (filters.length === 1 &&
            ([...url.searchParams].length === 0
                || ([...url.searchParams].length === 1 && url.searchParams.has('filters')))) {
            url.searchParams.delete('filters');
            const leagueSlug = window.slugifyName(filters[0], true);
            url.pathname = `/league/${leagueSlug}`;
        } else {
            url.pathname = originalLeaguelessURL.pathname;
            if (filters.length === 0) {
                url.searchParams.delete('filters');
            } else {
                const encodedFilters = filters.map(f => encodeURIComponent(f)).join(',');
                url.searchParams.set('filters', encodedFilters);
            }
        }

        history.replaceState({}, "", url.toString());
    }

    function updateCollapsedTitle(selectedDivisions, selectedGenerations, selectedExclusiveLeagues) {
        // Update the collapsed-title text based on selected filters
        let leagueText = '';

        // If an exclusive league is selected, override the league text.
        if (selectedExclusiveLeagues.length > 0) {
            // If multiple exclusive leagues are selected, join them with " AND "
            leagueText = selectedExclusiveLeagues.map(league => league.toUpperCase()).join(' AND ') + ' LEAGUE';
        } else {
            // Build generation part of the league text
            if (selectedGenerations.length === 1) {
                leagueText += selectedGenerations[0].toUpperCase();
            } else if (selectedGenerations.length === 2) {
                const [first, second] = selectedGenerations.map(gen => gen.toLowerCase()).sort();

                // Check for specific two-generation combinations
                if (first === "baby boomers" && second === "silent generation") {
                    leagueText += "HERITAGE";
                } else if (first === "baby boomers" && second === "gen x") {
                    leagueText += "SENIOR";
                } else if (first === "gen x" && second === "millennials") {
                    leagueText += "PRIME";
                } else if (first === "gen z" && second === "millennials") {
                    leagueText += "RISING";
                } else if (first === "gen alpha" && second === "gen z") {
                    leagueText += "NEXT-GEN";
                } else {
                    leagueText += selectedGenerations[0].toUpperCase() + ' AND ' + selectedGenerations[1].toUpperCase();
                }
            } else if (selectedGenerations.length === 3) {
                leagueText +=
                    selectedGenerations[0].toUpperCase() + ', ' +
                    selectedGenerations[1].toUpperCase() + ', AND ' +
                    selectedGenerations[2].toUpperCase();
            } else if (selectedGenerations.length === 4) {
                leagueText +=
                    selectedGenerations[0].toUpperCase() + ', ' +
                    selectedGenerations[1].toUpperCase() + ', ' +
                    selectedGenerations[2].toUpperCase() + ', AND ' +
                    selectedGenerations[3].toUpperCase();
            } else if (selectedGenerations.length === 5) {
                leagueText +=
                    selectedGenerations[0].toUpperCase() + ', ' +
                    selectedGenerations[1].toUpperCase() + ', ' +
                    selectedGenerations[2].toUpperCase() + ', ' +
                    selectedGenerations[3].toUpperCase() + ', AND ' +
                    selectedGenerations[4].toUpperCase();

                // Build division part of the league text
            }

            if (selectedDivisions.length === 1) {
                if (leagueText.length > 0) {
                    leagueText += ' ';
                }
                leagueText += selectedDivisions[0].toUpperCase();
            } else if (selectedDivisions.length === 2) {
                if (leagueText.length > 0) {
                    leagueText += ' ';
                }

                // Custom sorting order for divisions
                const order = { "men's": 1, "women's": 2, "open": 3 };
                const [first, second] = selectedDivisions
                    .map(div => div.toLowerCase())
                    .sort((a, b) => order[a] - order[b]);

                if (first === "men's" && second === "women's") {
                    leagueText += 'MIXED';
                } else if (first === "men's" && second === 'open') {
                    leagueText += "INCLUSIVE MEN'S";
                } else if (first === "women's" && second === 'open') {
                    leagueText += "INCLUSIVE WOMEN'S";
                }
            }

            // Default text if no filters are selected
            if (leagueText === '') {
                leagueText = 'ULTIMATE';
            }

            leagueText += " LEAGUE";
        }

        // Update the text content of the collapsed-title element
        const collapsedTitle = document.querySelector('.collapsed-title');
        if (collapsedTitle) {
            collapsedTitle.textContent = leagueText;

            // Force reflow by toggling opacity
            collapsedTitle.style.opacity = '0';
            requestAnimationFrame(() => {
                collapsedTitle.style.opacity = '1';
            });
        }
    }

    function updateFilterCounts(filteredAthletes) {
        // Update division counts
        const divisionCounts = {};
        filteredAthletes.forEach(athlete => {
            const division = athlete.division;
            divisionCounts[division] = (divisionCounts[division] || 0) + 1;
        });

        document.querySelectorAll('.filter-section label[data-division]').forEach(label => {
            const division = label.getAttribute('data-division');
            const count = divisionCounts[division] || 0;
            const countSpan = label.querySelector('.filter-count');
            if (countSpan) {
                countSpan.textContent = count;
            }
        });

        // Update generation counts
        const generationCounts = {};
        filteredAthletes.forEach(athlete => {
            const generation = athlete.generation;
            generationCounts[generation] = (generationCounts[generation] || 0) + 1;
        });

        document.querySelectorAll('.filter-section label[data-generation]').forEach(label => {
            const generation = label.getAttribute('data-generation');
            const count = generationCounts[generation] || 0;
            const countSpan = label.querySelector('.filter-count');
            if (countSpan) {
                countSpan.textContent = count;
            }
        });
    }

    function displayNoResults(tableRows, podiumItems, query) {
        // Remove existing no-results message if any
        const existingMessage = document.querySelector('.no-results');
        if (existingMessage) {
            existingMessage.remove();
        }

        // Check if any rows or podium items are visible
        const anyVisible = Array.from(tableRows).some(row => row.style.display !== 'none');

        if (!anyVisible) {
            if (query.trim() !== '') {
                const tableBody = document.querySelector('.leaderboard table tbody');
                const noResults = document.createElement('tr');
                noResults.classList.add('no-results');
                noResults.innerHTML = `<td colspan="6">No results found for "<strong>${window.escapeHTML(query)}</strong>".</td>`;
                tableBody.appendChild(noResults);
            }
            else {
                const tableBody = document.querySelector('.leaderboard table tbody');
                const noResults = document.createElement('tr');
                noResults.classList.add('no-results');
                noResults.innerHTML = `<td colspan="6">It looks like no athletes have joined this league yet.</td>`;
                tableBody.appendChild(noResults);
            }
        }
    }

    let isInitialClick = true; // Track if it’s the first click after focusing

    const searchInput = document.getElementById('athleteSearch');

    // Select all text on the first focus
    searchInput.addEventListener('focus', () => {
        isInitialClick = true;
    });

    // Select all text on the first click, then just place the cursor where clicked on the second click
    searchInput.addEventListener('click', (event) => {
        if (isInitialClick) {
            searchInput.select(); // Select all text
            isInitialClick = false;
        }
    });

    document.addEventListener('keydown', function (event) {
        const searchInput = document.getElementById('athleteSearch');
        if (event.key === 'Escape' && searchInput.value.trim().length > 0) {
            clearSearch();
            searchInput.blur(); // Optionally remove focus
        }
    });

    // Modify the input event listener
    document.getElementById('athleteSearch').addEventListener('input', function () {
        const query = this.value.trim();
        if (query === '') {
            clearSearch(); // Run only when input is cleared
        } else {
            debounceFilterAthletes(); // Run debounce function when input is not empty
        }
    });

    document.querySelector('.clear-icon').addEventListener('click', clearSearch);
    document.querySelector('.clear-icon').addEventListener('keypress', function (event) {
        if (event.key === 'Enter') clearSearch();
    });

    function generateDivisionFilters(athletes) {
        const filterSection = document.querySelector('.filter-section ul');
        filterSection.innerHTML = ''; // Clear existing filters if any

        // Count occurrences of each division
        const divisionCounts = athletes.reduce((acc, athlete) => {
            acc[athlete.division] = (acc[athlete.division] || 0) + 1;
            return acc;
        }, {});

        // Generate the filter items with icons and counts
        Object.keys(divisionCounts).forEach(division => {
            const count = divisionCounts[division];
            const icon = window.TryGetDivisionIcon(division);

            const li = document.createElement('li');
            li.innerHTML = `
        <label data-division="${division}">
            <input type="checkbox" name="division" value="${division}">
            ${icon} ${division.charAt(0).toUpperCase() + division.slice(1)} (<span class="filter-count">${count}</span>)
        </label>
    `;
            filterSection.appendChild(li);
            const input = li.querySelector('input[type="checkbox"]');
            input.addEventListener('change', function (event) {
                event.stopPropagation(); // Prevent this event from affecting the sidebar toggle
                performFilter();
            });
        });
    }

    function generateGenerationFilters(athletes) {
        const filterSection = document.querySelector('#generation-filter-section ul');
        filterSection.innerHTML = ''; // Clear existing filters if any

        // Count occurrences of each generation
        const generationCounts = athletes.reduce((acc, athlete) => {
            acc[athlete.generation] = (acc[athlete.generation] || 0) + 1;
            return acc;
        }, {});

        // Order generations from oldest to youngest
        const orderedGenerations = ["Silent Generation", "Baby Boomers", "Gen X", "Millennials", "Gen Z", "Gen Alpha"];

        orderedGenerations.forEach(generation => {
            const count = generationCounts[generation] || 0;
            if (count > 0) { // Only show generations with at least one athlete
                const icon = window.TryGetGenerationIcon(generation);

                const li = document.createElement('li');
                li.innerHTML = `
            <label data-generation="${generation}">
                <input type="checkbox" name="generation" value="${generation}">
                ${icon} ${generation} (<span class="filter-count">${count}</span>)
            </label>
        `;
                filterSection.appendChild(li);
                const input = li.querySelector('input[type="checkbox"]');
                input.addEventListener('change', function (event) {
                    event.stopPropagation(); // Prevent this event from affecting the sidebar toggle
                    performFilter();
                });
            }
        });
    }

    function generateExclusiveFilters(athletes) {
        const filterSection = document.querySelector('#exclusive-filter-section ul');
        filterSection.innerHTML = ''; // Clear existing filters if any

        const prosperanCount = athletes.reduce((count, athlete) => {
            return athlete.exclusiveLeague === "Prosperan" ? count + 1 : count;
        }, 0);

        if (prosperanCount > 0) {
            const li = document.createElement('li');
            li.innerHTML = `
            <label data-exclusive-league="Prosperan">
                <input type="checkbox" name="exclusiveLeague" value="Prosperan">
                🏝️ Prosperan (<span class="filter-count">${prosperanCount}</span>)
            </label>
        `;
            filterSection.appendChild(li);

            const input = li.querySelector('input[type="checkbox"]');
            input.addEventListener('change', function (event) {
                event.stopPropagation(); // Prevent this event from affecting the sidebar toggle
                performFilter();
            });
        }
    }

    function generateAgeVisualization(bioAge, chronoAge) {
        const visualizationContainer = document.getElementById('targetShootingVisualization');

        // Define the maximum age for scaling. Adjust if needed.
        const maxAge = 100;

        // Calculate percentages relative to maxAge
        const bioPercentage = Math.min((bioAge / maxAge) * 100, 100);
        const chronoPercentage = Math.min((chronoAge / maxAge) * 100, 100);

        let gradient;

        if (bioAge === chronoAge) {
            // Entire circle is blue
            gradient = `radial-gradient(circle, #3498db 100%, #3498db 100%)`;
        } else if (bioAge < chronoAge) {
            // Inner blue up to bioAge%, outer green up to chronoAge%, rest gray
            gradient = `radial-gradient(circle, #3498db ${bioPercentage}%, #2ecc71 ${chronoPercentage}%, #ccc 100%)`;
        } else { // bioAge > chronoAge
            // Inner blue up to chronoAge%, outer red up to bioAge%, rest gray
            gradient = `radial-gradient(circle, #3498db ${chronoPercentage}%, #e74c3c ${bioPercentage}%, #ccc 100%)`;
        }

        // Apply the gradient to the visualization container
        visualizationContainer.style.background = gradient;
        visualizationContainer.style.borderRadius = '50%';
        visualizationContainer.style.position = 'relative';
        visualizationContainer.style.border = '2px solid #ccc'; // Optional: Adds a border to the circle

        // Clear any existing content
        visualizationContainer.innerHTML = '';

        var difference = (bioAge - chronoAge).toFixed(1);
        var circleText = `${difference > 0 ? '+' : ''}${difference} yrs`;

        // Add labels based on the scenario
        visualizationContainer.innerHTML = `
            <span style="
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: var(--light-text-color);
                font-weight: bold;">
                ${circleText}
            </span>
        `;
    }

    function addFadeInEffectToElements() {
        document.querySelectorAll('.podium-item, .leaderboard table tbody tr').forEach(element => {
            element.classList.add('fade-in-element');
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        addFadeInEffectToElements();
    });

    function applyCamelCaseNewlines() {
        if (window.innerWidth < 480) { // Only apply on mobile
            document.querySelectorAll('.athlete-name').forEach(el => {
                const originalText = el.textContent;
                // Insert a <br> between a lowercase and an uppercase letter
                const formattedText = originalText.replace(/([a-z])([A-Z])/g, '$1<br>$2');
                el.innerHTML = formattedText;
            });
        }
    }

    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape' || event.key === 'Esc') {
            closeOpenComponents();
        }
    });
    function closeOpenComponents() {
        const enlargedImg = document.querySelector('.enlarged-portrait.show');
        if (enlargedImg) {
            // Close the enlarged portrait if it's open
            closeEnlargedView(enlargedImg);
        }
        else if (modal.style.display === "block") {
            // Close the details modal if it's open
            closeModal();
        }
    }

    function handleAthleteNameClick(event) {
        // Determine if it's a table row or podium item
        const athleteRow = getAthleteRow(event.target);
        if (!athleteRow) {
            console.error('Athlete row not found');
            return;
        }

        // Get athlete's name from data attribute
        const athleteNameText = athleteRow.getAttribute('data-athlete-name');

        // Find the athlete's data from athleteResults
        const athleteData = getAthleteData(athleteNameText);
        if (!athleteData) {
            console.error('Athlete data not found');
            return;
        }

        // Fetch the full athlete JSON data
        fetchFullAthleteData(athleteNameText, athleteData);
    }

    function getAthleteRow(element) {
        return element.closest('tr') || element.closest('.podium-item');
    }

    function getAthleteData(athleteNameText) {
        return athleteResults.find(athlete => window.slugifyName(athlete.name) === window.slugifyName(athleteNameText));
    }

    function getAthletelessURL() {
        const url = new URL(window.location.href.replace(/\/athlete\/[^/]+\/?$/, ''));
        url.searchParams.delete('athlete');
        return url;
    }

    function getLeaguelessURL() {
        const url = new URL(window.location.href.replace(/\/league\/[^/]+\/?$/, ''));
        return url;
    }

    let originalAthletelessURL = getAthletelessURL();
    let originalLeaguelessURL = getLeaguelessURL();

    function fetchFullAthleteData(athleteNameText, athleteData) {
        fetchWithTimeout('/api/data/athletes', {}, 10000) // 10-second timeout
            .then(response => response.json())
            .then(athletes => {
                const fullAthleteData = athletes.find(a => window.slugifyName(a.Name) === window.slugifyName(athleteNameText));
                if (!fullAthleteData) {
                    console.error('Full athlete data not found');
                    return;
                }

                const { ultimateRank, bestLeagueRank, bestLeagueName, bestLeagueType } = computeBestLeagueRank(athleteData);

                // Populate the modal with athlete data
                populateModal(fullAthleteData, athleteData, ultimateRank, bestLeagueRank, bestLeagueName, bestLeagueType);

                updatePageTitleForAthlete(fullAthleteData.Name, ultimateRank);

                // Generate age visualization
                const bioAge = athleteData.lowestPhenoAge;
                const chronoAge = athleteData.chronologicalAge;
                generateAgeVisualization(bioAge, chronoAge);

                // Generate biomarker chart
                generateBiomarkerChart(fullAthleteData);

                // Populate proofs gallery
                populateProofsGallery(fullAthleteData);

                // After populating the modal with athlete data but before showing it:
                originalAthletelessURL = getAthletelessURL();
                const athleteSlug = window.slugifyName(athleteNameText, true);
                history.pushState({ modal: 'details', athlete: athleteSlug }, "", `/athlete/${athleteSlug}`);

                // Display the modal
                modal.style.display = "block";
                document.body.classList.add('no-scroll'); // Disable scrolling when modal opens
                document.querySelector('.modal-content').classList.add('guess-mode');

            })
            .catch(error => {
                console.error('Error fetching full athlete data:', error);
            });
    }

    function computeBestLeagueRank(athleteData) {
        // Arrays of divisions and generations for reference
        const divisions = [...new Set(athleteResults.map(athlete => athlete.division))];
        const generations = [...new Set(athleteResults.map(athlete => athlete.generation))];

        let bestLeagueRank = Infinity;
        let bestLeagueName = '';
        let bestLeagueType = '';

        for (const [league, rank] of Object.entries(athleteData.ranks)) {
            if (rank < bestLeagueRank) {
                bestLeagueRank = rank;
                bestLeagueName = league;

                // Determine league type
                if (divisions.includes(league)) {
                    bestLeagueType = 'division';
                } else if (generations.includes(league)) {
                    bestLeagueType = 'generation';
                } else if (league.includes('_')) {
                    bestLeagueType = 'combination';
                } else {
                    bestLeagueType = 'other';
                }
            }
        }
        const ultimateRank = athleteData.rank;

        return { ultimateRank, bestLeagueRank, bestLeagueName, bestLeagueType };
    }

    function populateModal(fullAthleteData, athleteData, ultimateRank, bestLeagueRank, bestLeagueName, bestLeagueType) {
        document.getElementById('athleteName').textContent = `${fullAthleteData.Name}${window.getRankText(ultimateRank)}`;
        const profilePic = document.getElementById('modalProfilePic');
        profilePic.src = fullAthleteData.ProfilePic;
        profilePic.alt = `${fullAthleteData.Name} Profile Picture`;
        profilePic.loading = 'lazy';

        document.getElementById('athleteBio').textContent = fullAthleteData.Why;

        let rankText = `#${ultimateRank} in the <a href="/leaderboard/leaderboard.html" class="league-link">Ultimate League</a>`;
        if (bestLeagueRank !== ultimateRank) {
            const leagueLabel = bestLeagueName.replace('_', ' ');
            if (bestLeagueType === 'division' || bestLeagueType === 'generation') {
                const slug = window.slugifyName(bestLeagueName, true);
                rankText = `#${bestLeagueRank} in the <a href="/league/${slug}" class="league-link">${leagueLabel} League</a>`;
            } else if (bestLeagueType === 'combination') {
                const filters = bestLeagueName.split('_').map(f => encodeURIComponent(f)).join('%2C');
                rankText = `#${bestLeagueRank} in the <a href="/?filters=${filters}" class="league-link">${leagueLabel} League</a>`;
            } else {
                rankText = `#${bestLeagueRank} in the ${leagueLabel} League`;
            }
        }

        document.getElementById('athleteRank').innerHTML = rankText;
        document.getElementById('athleteDivision').innerHTML = `<a href="/league/${window.slugifyName(athleteData.division, true)}" class="league-link">${athleteData.division}</a>${window.getRankText(athleteData.ranks[athleteData.division])}`;
        document.getElementById('athleteGeneration').innerHTML = `<a href="/league/${window.slugifyName(athleteData.generation, true)}" class="league-link">${athleteData.generation}</a>${window.getRankText(athleteData.ranks[athleteData.generation])}`;
        document.getElementById('athleteFlag').textContent = fullAthleteData.Flag;
        document.getElementById('chronologicalAge').textContent = athleteData.chronologicalAge.toFixed(1);
        document.getElementById('lowestPhenoAge').textContent = athleteData.lowestPhenoAge.toFixed(1);
        document.getElementById('ageReductionAccelerationLabel').textContent = athleteData.ageReduction < 0 ? "Age Reduction:" : "Age Acceleration:";
        document.getElementById('ageReduction').textContent = (athleteData.ageReduction >= 0 ? "+" : "") + athleteData.ageReduction.toFixed(1);

        // Personal Link
        const personalLinkElement = document.getElementById('personalLink');
        if (athleteData.personalLink) {
            personalLinkElement.href = athleteData.personalLink.startsWith('http') ? athleteData.personalLink : 'https://' + athleteData.personalLink;
            personalLinkElement.style.display = 'flex';
            personalLinkElement.title = `Visit personal page of ${athleteData.name}`;
        } else {
            personalLinkElement.style.display = 'none';
        }

        // Media Contact
        const mediaContactElement = document.getElementById('mediaContact');
        if (athleteData.mediaContact) {
            const isEmail = athleteData.mediaContact.includes('@');
            mediaContactElement.href = isEmail ? `mailto:${athleteData.mediaContact}` : (athleteData.mediaContact.startsWith('http') ? athleteData.mediaContact : 'https://' + athleteData.mediaContact);
            mediaContactElement.innerHTML = `${window.getIcon(athleteData.mediaContact)} Media Contact`;
            mediaContactElement.style.display = 'flex';
            mediaContactElement.title = isEmail ? `Email ${athleteData.name}` : `Contact ${athleteData.name}`;
        } else {
            mediaContactElement.style.display = 'none';
        }

        // — Add badge strip into the modal —
        const modalBadgeSection = document.getElementById('modalBadgeStrip');
        modalBadgeSection.innerHTML = '';
        // Clone athleteData but disable personalLink for modal badges
        const athleteForBadges = { ...athleteData, personalLink: null };
        window.setBadges(athleteForBadges, {
            querySelector: () => modalBadgeSection
        });
        Array.from(modalBadgeSection.children).forEach((badge, i) => {
            badge.style.animation = `pop .55s ease-out both ${i * 0.2}s`;
            badge.addEventListener('animationend', function handler() {
                // Clear the animation so CSS hover-transform can take over
                badge.style.animation = '';
                badge.removeEventListener('animationend', handler);
            });
        });

        // wrap each badge in a column with its name
        const badges = Array.from(modalBadgeSection.children);
        modalBadgeSection.innerHTML = '';
        badges.forEach(badge => {
            const fullTitle = badge.getAttribute('title') || '';
            const colonIndex = fullTitle.indexOf(':');
            let titlePart = fullTitle;
            let detailPart = '';
            if (colonIndex !== -1) {
                titlePart = fullTitle.slice(0, colonIndex);       // before the colon
                detailPart = fullTitle.slice(colonIndex + 1).trim(); // after the colon
            }

            const wrapper = document.createElement('div');
            wrapper.classList.add('modal-badge-item');
            wrapper.appendChild(badge);

            const label = document.createElement('div');
            label.classList.add('modal-badge-name');
            if (detailPart) {
                label.innerHTML =
                    `<span class="modal-badge-title">${titlePart}</span>` +
                    `<span class="modal-badge-detail">${detailPart}</span>`;
            } else {
                label.innerHTML = `<span class="modal-badge-title">${titlePart}</span>`;
            }
            wrapper.appendChild(label);

            // enable click/tap to expand full text
            wrapper.addEventListener('click', () => {
                wrapper.classList.toggle('expanded');
            });
            modalBadgeSection.appendChild(wrapper);
        });

    }

    function generateBiomarkerChart(fullAthleteData) {
        const biomarkerChartCtx = document.getElementById('biomarkerChart').getContext('2d');
        const biomarkerData = fullAthleteData.Biomarkers.sort((a, b) => new Date(a.Date) - new Date(b.Date));
        const dob = new Date(
            fullAthleteData.DateOfBirth.Year,
            fullAthleteData.DateOfBirth.Month - 1,
            fullAthleteData.DateOfBirth.Day
        );

        const labels = biomarkerData.map(entry => entry.Date);
        const phenoAges = [];
        const biomarkersRaw = initializeBiomarkersRaw();

        biomarkerData.forEach(entry => {
            const entryDate = new Date(entry.Date);
            const chronoAgeAtEntry = window.calculateAgeAtDate(dob, entryDate);

            collectBiomarkerValues(entry, biomarkersRaw);
            const biomarkerValues = prepareBiomarkerValues(entry, chronoAgeAtEntry);

            const phenoAge = window.PhenoAge.calculatePhenoAge(biomarkerValues);
            phenoAges.push(phenoAge.toFixed(1));
        });

        const biomarkersZScores = calculateBiomarkerZScores(biomarkersRaw);
        const datasets = prepareBiomarkerDatasets(labels, phenoAges, biomarkersRaw, biomarkersZScores);

        if (window.biomarkerChartInstance) {
            window.biomarkerChartInstance.destroy();
        }

        window.biomarkerChartInstance = new Chart(biomarkerChartCtx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: getBiomarkerChartOptions()
        });
    }

    function initializeBiomarkersRaw() {
        return {
            'Albumin (g/L)': [],
            'Creatinine (µmol/L)': [],
            'Glucose (mmol/L)': [],
            'CRP (mg/L)': [],
            'Lymphocytes (%)': [],
            'MCV (fL)': [],
            'RDW (%)': [],
            'ALP (U/L)': [],
            'WBC (10^3 cells/µL)': []
        };
    }

    function collectBiomarkerValues(entry, biomarkersRaw) {
        function pushOrInherit(key, newValue) {
            // Retrieve the last known value if available
            const lastValue = biomarkersRaw[key].length > 0 ? biomarkersRaw[key][biomarkersRaw[key].length - 1] : undefined;
            // Use newValue if provided; otherwise, inherit lastValue
            const valueToUse = newValue != null ? newValue : lastValue;
            // Update the persistent storage
            biomarkersRaw[key].push(valueToUse);
            // Return the value used so we can update the entry
            return valueToUse;
        }
        entry.AlbGL = pushOrInherit('Albumin (g/L)', entry.AlbGL);
        entry.CreatUmolL = pushOrInherit('Creatinine (µmol/L)', entry.CreatUmolL);
        entry.GluMmolL = pushOrInherit('Glucose (mmol/L)', entry.GluMmolL);
        entry.CrpMgL = pushOrInherit('CRP (mg/L)', entry.CrpMgL);
        entry.LymPc = pushOrInherit('Lymphocytes (%)', entry.LymPc);
        entry.McvFL = pushOrInherit('MCV (fL)', entry.McvFL);
        entry.RdwPc = pushOrInherit('RDW (%)', entry.RdwPc);
        entry.AlpUL = pushOrInherit('ALP (U/L)', entry.AlpUL);
        entry.Wbc1000cellsuL = pushOrInherit('WBC (10^3 cells/µL)', entry.Wbc1000cellsuL);
    }

    function prepareBiomarkerValues(entry, chronoAgeAtEntry) {
        return [
            chronoAgeAtEntry,
            entry.AlbGL,
            entry.CreatUmolL,
            entry.GluMmolL,
            Math.log(entry.CrpMgL / 10),
            entry.Wbc1000cellsuL,
            entry.LymPc,
            entry.McvFL,
            entry.RdwPc,
            entry.AlpUL
        ];
    }

    function calculateBiomarkerZScores(biomarkersRaw) {
        const biomarkersZScores = {};
        for (const [key, values] of Object.entries(biomarkersRaw)) {
            const mean = values.reduce((sum, val) => sum + val, 0) / values.length;
            const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
            const stdDev = Math.sqrt(variance);

            biomarkersZScores[key] = stdDev === 0
                ? values.map(() => 0)
                : values.map(val => ((val - mean) / stdDev).toFixed(2));
        }
        return biomarkersZScores;
    }

    function prepareBiomarkerDatasets(labels, phenoAges, biomarkersRaw, biomarkersZScores) {
        const datasets = [
            {
                label: 'PhenoAge',
                data: phenoAges,
                borderColor: 'rgba(0, 0, 255, 1)',
                backgroundColor: 'rgba(0, 0, 255, 0.1)',
                fill: false,
                tension: 0.1,
                borderWidth: 3,
                yAxisID: 'y1'
            }
        ];

        const biomarkerColors = {
            'Albumin (g/L)': 'rgba(0, 128, 255, 1)',
            'Creatinine (µmol/L)': 'rgba(128, 0, 128, 1)',
            'Glucose (mmol/L)': 'rgba(255, 165, 0, 1)',
            'CRP (mg/L)': 'rgba(255, 69, 0, 1)',
            'Lymphocytes (%)': 'rgba(0, 100, 0, 1)',
            'MCV (fL)': 'rgba(70, 130, 180, 1)',
            'RDW (%)': 'rgba(220, 20, 60, 1)',
            'ALP (U/L)': 'rgba(218, 165, 32, 1)',
            'WBC (10^3 cells/µL)': 'rgba(34, 139, 34, 1)'
        };

        for (const [key, zScores] of Object.entries(biomarkersZScores)) {
            const actualValues = biomarkersRaw[key];
            const dataPoints = zScores.map((zScore, index) => ({
                x: labels[index],
                y: zScore,
                actualValue: actualValues[index]
            }));

            // Retrieve saved visibility state from localStorage
            let savedState = localStorage.getItem('biomarkerVisibilityState');
            let isHidden = true; // default value

            if (savedState) {
                const state = JSON.parse(savedState);
                // Use the saved state if it exists for this biomarker key
                if (state.hasOwnProperty(key)) {
                    isHidden = state[key];
                }
            }

            datasets.push({
                label: key,
                data: dataPoints,
                borderColor: biomarkerColors[key],
                backgroundColor: 'rgba(0, 0, 0, 0)',
                fill: false,
                tension: 0.1,
                yAxisID: 'y2',
                hidden: isHidden
            });
        }
        return datasets;
    }

    function getBiomarkerChartOptions() {
        return {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false
            },
            stacked: false,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            const label = context.dataset.label || '';
                            const yValue = context.parsed.y;
                            const actualValue = context.raw.actualValue;
                            const formattedValue = actualValue !== undefined && !isNaN(actualValue)
                                ? (actualValue % 1 !== 0 ? actualValue.toFixed(2) : actualValue.toString())
                                : 'N/A';

                            return label === 'PhenoAge' ? `${label}: ${yValue}` : `${label}: ${formattedValue}`;
                        }
                    }
                },
                legend: {
                    labels: {
                        font: {
                            size: window.innerWidth < 768 ? 10 : 12 // Adjust font size for mobile
                        }
                    },
                    onHover: function (event) {
                        event.native.target.style.cursor = 'pointer';
                    },
                    onLeave: function (event) {
                        event.native.target.style.cursor = 'default';
                    },
                    onClick: function (e, legendItem, legend) {
                        // Execute the default onClick handler
                        Chart.defaults.plugins.legend.onClick.call(this, e, legendItem, legend);
                        // Get the chart instance and dataset metadata
                        const ci = legend.chart;
                        const index = legendItem.datasetIndex;
                        const meta = ci.getDatasetMeta(index);

                        // Store the biomarker's new visibility status
                        // Retrieve the stored state; if none exists, start with an empty object
                        let state = localStorage.getItem('biomarkerVisibilityState');
                        state = state ? JSON.parse(state) : {};

                        // Update the state with the new key-value pair
                        state[meta.label] = meta.hidden;

                        // Save it back to localStorage as a JSON string
                        localStorage.setItem('biomarkerVisibilityState', JSON.stringify(state));
                    }
                }
            },
            scales: {
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Age (years)',
                        font: {
                            size: window.innerWidth < 768 ? 10 : 14 // Adjust font size for mobile
                        }
                    },
                    grid: {
                        drawOnChartArea: true
                    }
                },
                y2: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Biomarkers (Z-scores)',
                        font: {
                            size: window.innerWidth < 768 ? 10 : 14
                        }
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Date',
                        font: {
                            size: window.innerWidth < 768 ? 10 : 14
                        }
                    }
                }
            }
        };
    }

    function populateProofsGallery(fullAthleteData) {
        const proofsGallery = document.getElementById('proofsGallery');
        proofsGallery.innerHTML = '';

        fullAthleteData.Proofs.forEach(proofUrl => {
            const proofItem = document.createElement('div');
            proofItem.classList.add('proof-item');
            proofItem.innerHTML = `<img src="${proofUrl}" alt="Proof Image" loading="lazy">`;
            proofsGallery.appendChild(proofItem);

            proofItem.querySelector('img').addEventListener('click', function () {
                openEnlargedView(this);
            });
        });
    }

    // Ensure modal history cleanup
    window.addEventListener('popstate', function (event) {
        closeOpenComponents();
    });

    const sidebar = document.querySelector('.sidebar');
    const sidebarToggle = document.querySelector('.sidebar-toggle');
    const sidebarClose = document.querySelector('.sidebar-close');

    sidebarToggle.addEventListener('click', () => {
        toggleSidebar();
    });

    sidebarToggle.addEventListener('mouseenter', () => {
        if (sidebar.classList.contains('expanded')) return;
        sidebar.classList.add('partially-expanded');
    });

    sidebarToggle.addEventListener('mouseleave', () => {
        sidebar.classList.remove('partially-expanded');
    });

    sidebarClose.addEventListener('click', () => {
        closeSidebar();
    });

    function toggleSidebar() {
        if (sidebar.classList.contains('expanded')) {
            closeSidebar();
        }
        else {
            openSidebar();
        }
    }

    function openSidebar() {
        sidebar.classList.remove('partially-expanded');
        sidebar.classList.remove('collapsed');

        if (!sidebar.classList.contains('expanded')) {
            sidebar.classList.add('expanded');
        }
        if (!sidebarToggle.classList.contains('active')) {
            sidebarToggle.classList.add('active')
        }

        sidebarToggle.title = "Hide Leagues";
        sidebarToggle.setAttribute('aria-label', 'Hide Sidebar');

        // Scroll to the leaderboard table
        document.querySelector('.search-wrapper .sidebar-toggle').scrollIntoView({
            behavior: 'smooth',
            block: 'start',
        });
    }

    function closeSidebar() {
        sidebar.classList.remove('expanded');
        sidebarToggle.classList.remove('active');
        sidebar.classList.remove('partially-expanded');
        if (!sidebar.classList.contains('button-collapsed')) {
            sidebar.classList.add('button-collapsed');
        }
        sidebarToggle.title = "Show Leagues";
        sidebarToggle.setAttribute('aria-label', 'Show Sidebar');

        setTimeout(() => {
            sidebar.classList.remove('button-collapsed');
        }, 50);
    }

    // Sidebar swipe gesture
    let startX = 0;
    let endX = 0;
    let startY = 0;
    let endY = 0;
    const SWIPE_THRESHOLD = 50; // Minimum distance to qualify as a swipe
    const TAP_THRESHOLD = 10; // Allowable movement for taps

    document.addEventListener('touchstart', (e) => {
        if (modal.style.display === "block") return;

        startX = e.changedTouches[0].clientX;
        startY = e.changedTouches[0].clientY;
    }, false);

    document.addEventListener('touchend', (e) => {
        if (modal.style.display === "block") return;

        endX = e.changedTouches[0].clientX;
        endY = e.changedTouches[0].clientY;

        const deltaX = endX - startX; // Horizontal movement
        const deltaY = endY - startY; // Vertical movement

        // Check if it's a tap (small movement)
        if (Math.abs(deltaX) < TAP_THRESHOLD && Math.abs(deltaY) < TAP_THRESHOLD) {
            return; // Do nothing, treat as a tap
        }

        // Check for swipe
        if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > SWIPE_THRESHOLD) {
            if (deltaX > 0) {
                // Swiped from left to right => open sidebar
                openSidebar();
            } else {
                // Swiped from right to left => close sidebar
                closeSidebar();
            }
        }
    }, false);

    // Updates the document title for the selected athlete.
    function updatePageTitleForAthlete(athleteName, athleteRank) {
        document.title = `${athleteName} (#${athleteRank}) - Longevity World Cup`;
    }

    // Resets the document title to the default when no athlete is selected.
    const originalDocumentTitle = document.title;
    function resetPageTitle() {
        document.title = originalDocumentTitle;
    }

    function addClickListenerToImages(selector, callback) {
        document.querySelectorAll(selector).forEach(img => {
            if (!img.dataset.listenerAdded) {
                img.addEventListener('click', callback);
                img.dataset.listenerAdded = true; // Mark this element as having a listener added
            }
        });
    }

    /* === Guess-My-Age bindings for the new widget === */
    const gmaRange = document.getElementById('gmaRange');
    const gmaBubble = document.getElementById('gmaBubble');
    const gmaCard = document.querySelector('.gma-card');

    function syncRange() {
        const val = +gmaRange.value;
        const pct = (val / gmaRange.max) * 100;
        gmaRange.style.setProperty('--percent', `${pct}%`);
        gmaBubble.textContent = val;
        const clampedPct = Math.min(Math.max(pct, 5), 95);
        gmaBubble.style.left = `${clampedPct}%`;
    }
    gmaRange.addEventListener('input', syncRange);
    syncRange();   // initialise bubble

    // optional: collapse the card after a guess
    gmaCard.querySelector('.gma-btn--primary').addEventListener('click', hideCard);
    gmaCard.querySelector('.gma-btn--ghost').addEventListener('click', hideCard);
    function hideCard() {
        gmaCard.classList.add('gma-done');          /* fade-out / hide via CSS if desired */
        document.querySelector('.modal-content')
            .classList.remove('guess-mode');    /* reveal the rest of the modal */
    }
</script>