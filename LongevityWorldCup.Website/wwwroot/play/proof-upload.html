<!DOCTYPE html>
<html lang="en">
<head>
    <title>Longevity World Cup - Proof Upload</title>
    <!--HEAD-->
    <style>
        /* Hide the join-game button in the header */
        .join-game {
            display: none;
        }

        #proofImageContainer {
            width: 90%;
            max-width: 600px;
            margin: 1rem auto 0;
            text-align: center;
        }

            #proofImageContainer div {
                position: relative;
                display: inline-block;
                margin: 0.5rem;
            }

            #proofImageContainer img {
                max-width: 200px;
                border: 2px solid var(--dark-text-color);
                border-radius: 8px;
            }

            #proofImageContainer button {
                position: absolute;
                top: 5px;
                right: 5px;
                background-color: rgba(255, 0, 0, 0.7);
                color: var(--light-text-color);
                border: none;
                border-radius: 3px;
                cursor: pointer;
            }
    </style>
</head>
<body>
    <!--HEADER-->
    <main>
        <h1 id="character-title" data-aos="fade" data-aos-duration="700" data-aos-delay="250">Athlete selection</h1>
        <div style="text-align: center;" data-aos="fade" data-aos-duration="700" data-aos-delay="300">
            <picture>
                <source srcset="../assets/content-images/proof.webp" type="image/webp">
                <source srcset="../assets/content-images/proof.jpg" type="image/jpeg">
                <img src="../assets/content-images/proof.jpg" alt="Illustration of uploading lab proof documents" class="illustration" loading="lazy">
            </picture>
        </div>
        <p id="mainProofInstructions" data-aos="fade" data-aos-duration="700" data-aos-delay="350" style="text-align:center"></p>
        <p id="subProofInstructions" class="smaller-text" data-aos="fade" data-aos-duration="700" data-aos-delay="400" style="text-align:center"></p>

        <div class="options-container" data-aos="fade" data-aos-duration="700" data-aos-delay="450">
            <input type="file" id="proofPicInput" accept="image/*,application/pdf" style="display: none;" multiple>
            <button type="button" id="uploadProofButton" class="option-button grey green">
                Upload proofs
            </button>
        </div>

        <fieldset id="proofImageContainer" style="text-align: center; margin-top: 1rem;"></fieldset>

        <div id="biomarker-checklist" style="width: 90%; max-width: 600px; margin: 1rem auto 0; "></div>

        <div class="options-container" data-aos="fade" data-aos-duration="700" data-aos-delay="450">
            <button id="submitButton" type="submit" class="option-button green"></button>
            <button class="option-button back-button" onclick="window.goBackOrHome()">
                <i class="fas fa-arrow-left"></i>&nbsp;Back
            </button>
        </div>
    </main>
    <!--FOOTER-->
    <script>
        const athlete = JSON.parse(sessionStorage.getItem('selectedAthlete'));
        let proofPics = [];
        const PENDING_PAYMENT_OFFER_KEY = 'pendingPaymentOffer';
        const PENDING_PAYMENT_INVOICE_KEY = 'pendingPaymentInvoice';
        const PENDING_PAYMENT_INVOICE_STORAGE_KEY = 'pendingPaymentInvoicePersistent';
        setSubmitButtonLabel();

        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(() => {
                const viewTarget = document.querySelector('h1');
                viewTarget.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 500);

            document.getElementById('character-title').textContent = athlete.Name;

            const mainProofInstructions = document.getElementById('mainProofInstructions');
            if (mainProofInstructions) {
                mainProofInstructions.innerHTML = window.getMainProofInstructionsInnerHTML();
            }

            const subProofInstructions = document.getElementById('subProofInstructions');
            if (subProofInstructions) {
                subProofInstructions.innerHTML = window.getSubProofInstructionsInnerHTML();
            }

            var submitButton = document.getElementById('submitButton');
            const uploadProofButton = document.getElementById('uploadProofButton');
            const proofPicInput = document.getElementById('proofPicInput');
            const proofImageContainer = document.getElementById('proofImageContainer');
            const biomarkerChecklistContainer = document.getElementById('biomarker-checklist');

            // Proof Tracker: biomarkers present in sessionStorage, ordered by bortz-age UI
            const checklistItems = window.getProofChecklistLabelsFromSession && window.getProofChecklistLabelsFromSession() || [];
            window.setupProofUploadHTML(submitButton, uploadProofButton, proofPicInput, proofImageContainer, proofPics, biomarkerChecklistContainer, checklistItems);

            submitButton.addEventListener('click', function () {
                if (!athlete || !athlete.Name) {
                    customAlert('No athlete selected. Please return and choose your athlete.');
                    return;
                }

                const biomarkerData = JSON.parse(sessionStorage.getItem('biomarkerData'));
                if (!biomarkerData || !biomarkerData.Biomarkers || !biomarkerData.Biomarkers.length) {
                    customAlert('Biomarker data is missing. Please fill out the biomarker form first.');
                    return;
                }

                const applicantData = {
                    name: athlete.Name,
                    accountEmail: sessionStorage.getItem('contactEmail') || null,
                    chronoPhenoDifference: sessionStorage.getItem('chronoPhenoDifference') || null,
                    chronoBortzDifference: sessionStorage.getItem('chronoBortzDifference') || null,
                    biomarkers: biomarkerData.Biomarkers,
                    proofPics: proofPics,
                    paymentOffer: (() => {
                        try {
                            return JSON.parse(sessionStorage.getItem(PENDING_PAYMENT_OFFER_KEY) || 'null');
                        } catch (_) {
                            return null;
                        }
                    })()
                };

                const submitButton = document.getElementById('submitButton');
                const uploadProofButton = document.getElementById('uploadProofButton');
                submitButton.disabled = true;
                uploadProofButton.disabled = true;
                submitButton.textContent = 'Submitting...';
                showLoading();

                fetchWithTimeout('/api/application/application', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(applicantData)
                }, 21000)
                    .then(response => {
                        hideLoading();
                        if (response.ok) {
                            response.json().catch(() => ({})).then(submitResult => {
                                const nextStepMessage =
                                    submitResult && submitResult.paymentRequired && submitResult.checkoutLink
                                        ? 'You\'ll be redirected to the payment page'
                                        : 'Your results were received';
                                customAlert(nextStepMessage).then(() => {
                                    proofPics = [];
                                    sessionStorage.removeItem(PENDING_PAYMENT_OFFER_KEY);
                                    if (submitResult && submitResult.paymentRequired && submitResult.checkoutLink) {
                                        if (submitResult.invoiceId) {
                                            const pendingInvoiceInfo = JSON.stringify({
                                                invoiceId: submitResult.invoiceId,
                                                applicantName: athlete.Name || null,
                                                accountEmail: applicantData.accountEmail || null
                                            });
                                            sessionStorage.setItem(PENDING_PAYMENT_INVOICE_KEY, pendingInvoiceInfo);
                                            localStorage.setItem(PENDING_PAYMENT_INVOICE_STORAGE_KEY, pendingInvoiceInfo);
                                        }
                                        window.location.href = submitResult.checkoutLink;
                                        return;
                                    }

                                    sessionStorage.removeItem(PENDING_PAYMENT_INVOICE_KEY);
                                    localStorage.removeItem(PENDING_PAYMENT_INVOICE_STORAGE_KEY);
                                    sessionStorage.setItem("came-from", "proof-upload");
                                    window.location.href = '/review';
                                });
                            });
                        } else {
                            response.text().then(badResponse => {
                                customAlert(`Failed to submit results. Please try again later.\n\n${badResponse}`).then(() => {
                                    submitButton.disabled = false;
                                    uploadProofButton.disabled = false;
                                    setSubmitButtonLabel();
                                });
                            });
                        }
                    })
                    .catch(error => {
                        hideLoading();
                        customAlert(`An error occurred:\n\n${error}`).then(() => {
                            submitButton.disabled = false;
                            uploadProofButton.disabled = false;
                            setSubmitButtonLabel();
                        });
                    });
            });
        });

        function setSubmitButtonLabel() {
            const submitButton = document.getElementById('submitButton');
            submitButton.innerHTML = 'Submit new results&nbsp;<i class="fa fa-rocket"></i>';
            submitButton.setAttribute('type', 'submit');
        }
    </script>
</body>
</html>