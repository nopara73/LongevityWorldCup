<!DOCTYPE html>
<html lang="en">
<head>
    <title>Longevity World Cup - Application Review</title>
    <!--HEAD-->
    <style>
        /* Hide the join-game button in the header */
        .join-game {
            display: none;
        }
    </style>
</head>
<body>
    <!--HEADER-->
    <main>
        <h1 id="appReviewTitle" data-aos="fade" data-aos-duration="700" data-aos-delay="200">
            <span id="appReviewText">Application review</span> <i class="fas fa-rocket"></i>
        </h1>
        <!-- Create distinct URLs or manually defined versions for each scenario -->
        <div style="text-align: center;" data-aos="fade" data-aos-duration="700" data-aos-delay="250">
            <picture>
                <source srcset="../assets/content-images/bean-waiting.webp" type="image/webp">
                <source srcset="../assets/content-images/bean-waiting.png" type="image/png">
                <img src="../assets/content-images/bean-waiting.png" alt="Waiting" class="illustration" loading="lazy">
            </picture>
        </div>
        <p data-aos="fade" data-aos-duration="700" data-aos-delay="300" style="text-align:center">
            We're reviewing <span id="whatAreWeReviewing">your application</span>, which may take a day or two. Afterwards we'll contact you at <span id="contactEmailPlaceholder" style="color: #4CAF50; font-weight: bold; text-decoration: underline;">
                [insert contact email address here]
            </span>
        </p>
        <p data-aos="fade" data-aos-duration="700" data-aos-delay="350" style="text-align:center">
            <span class="smaller-text">
                Questions, concerns, or signs of aging? Let us know at <a href="mailto:longevityworldcup@gmail.com">longevityworldcup@gmail.com</a>
            </span>
        </p>
        <p data-aos="fade" data-aos-duration="700" data-aos-delay="400" style="text-align:center">
            <span class="smaller-text">
                Want to hang out with other longevity athletes? Join the <span style="color: #4CAF50; font-weight: bold;">#longevity-world-cup</span> room on the <a href="https://join.slack.com/t/tumblebit/shared_invite/zt-2wzmjg6tg-PRup8nbL7GxViJzofNoBFQ">TumbleBit Slack</a>!
            </span>
        </p>
        <div class="options-container" data-aos="fade" data-aos-duration="700" data-aos-delay="400">
            <button class="option-button back-button" onclick="window.location.href='/'">
                <i class="fas fa-home"></i>&nbsp;Home
            </button>
        </div>
    </main>
    <!--FOOTER-->

    <script>
        const isNewResultsUploaded = sessionStorage.getItem("came-from") === "proof-upload";
        const isEditRequest = sessionStorage.getItem("came-from") === "edit-profile";
        const PENDING_PAYMENT_INVOICE_KEY = "pendingPaymentInvoice";
        const PENDING_PAYMENT_INVOICE_STORAGE_KEY = "pendingPaymentInvoicePersistent";
        sessionStorage.removeItem("came-from");

        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(() => {
                const viewTarget = document.querySelector('h1');
                viewTarget.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 500);

            if (isNewResultsUploaded) {
                document.getElementById("appReviewText").textContent = "Test review";
                document.getElementById("whatAreWeReviewing").textContent = "your new test results";
            }
            else if (isEditRequest) {
                document.getElementById("appReviewText").textContent = "Edit review";
                document.getElementById("whatAreWeReviewing").textContent = "your edit request";
            }

            maybeNotifyPaidInvoice();
        });

        // Retrieve the contact email
        const contactEmail =
            sessionStorage.getItem('contactEmail')
            || localStorage.getItem('contactEmail')
            || (() => {
                try {
                    const pending = JSON.parse(
                        sessionStorage.getItem(PENDING_PAYMENT_INVOICE_KEY)
                        || localStorage.getItem(PENDING_PAYMENT_INVOICE_STORAGE_KEY)
                        || "null"
                    );
                    return pending && pending.accountEmail ? pending.accountEmail : null;
                } catch (_) {
                    return null;
                }
            })();
        if (contactEmail) {
            // Insert it into the placeholder
            document.getElementById('contactEmailPlaceholder').textContent = contactEmail;
        } else {
            // If no email is found, use a default message
            document.getElementById('contactEmailPlaceholder').textContent = 'the email address you provided with your application';
        }

        // mark that theyâ€™ve submitted an application
        localStorage.setItem('hasApplication', 'true');

        function maybeNotifyPaidInvoice() {
            let pending;
            try {
                pending = JSON.parse(
                    sessionStorage.getItem(PENDING_PAYMENT_INVOICE_KEY)
                    || localStorage.getItem(PENDING_PAYMENT_INVOICE_STORAGE_KEY)
                    || "null"
                );
            } catch (_) {
                pending = null;
            }

            if (!pending || !pending.invoiceId) return;

            fetchWithTimeout('/api/application/payment-status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    invoiceId: pending.invoiceId,
                    applicantName: pending.applicantName || null,
                    accountEmail: pending.accountEmail || null
                })
            }, 12000)
                .then(response => response.ok ? response.json() : null)
                .then(result => {
                    if (!result) return;
                    // If we confirmed paid + notified (or already notified), we can stop checking.
                    if (result.isPaid && (result.notificationSent || result.alreadyNotified)) {
                        sessionStorage.removeItem(PENDING_PAYMENT_INVOICE_KEY);
                        localStorage.removeItem(PENDING_PAYMENT_INVOICE_STORAGE_KEY);
                    }
                })
                .catch(() => {
                    // Silent failure: review page should still work even if payment check fails.
                });
        }
    </script>
</body>
</html>