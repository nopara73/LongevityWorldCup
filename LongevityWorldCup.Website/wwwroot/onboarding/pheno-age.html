<!DOCTYPE html>
<html lang="en">
<head>
    <!--HEAD-->
    <link rel="stylesheet" href="/css/bioageform.css">
    <style>
        /* Hide the join-game button in the header */
        .join-game {
            display: none;
        }

        .option-button.already-have {
            background-color: #4CAF50; /* Green */
        }

            .option-button.already-have:hover {
                background-color: #388E3C; /* Darker Green */
            }

        /* Visually Hidden Class for Accessibility */
        .visually-hidden {
            position: absolute !important;
            height: 1px;
            width: 1px;
            overflow: hidden;
            clip: rect(1px, 1px, 1px, 1px);
            white-space: nowrap;
        }

        /* Error Highlighting */
        .errorNaN {
            border: 2px solid red;
        }

        .privacy-note {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.5rem;
        }

        /* Initial state: hidden and rotated to the left */
        #continueButton {
            opacity: 0;
            transform-origin: left;
            transform: rotate(-90deg);
            transition: opacity 0.6s ease, transform 0.6s ease;
        }

            /* Final state: fully visible and upright */
            #continueButton.show {
                opacity: 1;
                transform: rotate(0);
            }

        .input-group {
            display: flex;
            align-items: center;
            margin-top: 0.5rem;
        }

            .input-group input {
                flex: 1;
            }

            .input-group select {
                margin-left: 0.5rem;
                padding: 0.5rem;
                border: 1px solid #ccc;
                border-radius: 4px;
                width: auto;
                min-width: var(--unit-select-min-width, auto); /* Placeholder variable for dynamic width */
            }
    </style>
</head>
<body>
    <!--HEADER-->
    <main>
        <!--MAIN-PROGRESS-BAR-->
        <h2>Your Chronological vs Biological Age🧬</h2>
        <p>Calculate your biological age, known as <a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC5940111/pdf/aging-10-101414.pdf" target="_blank">PhenoAge</a>:</p>
        <form id="phenoAgeForm" class="bioageform">
            <!-- Date of Birth Fields -->
            <fieldset>
                <legend>Date of Birth:</legend>
                <label for="dob-year">Year <span style="font-weight: normal;">(required)</span></label>
                <select id="dob-year" name="dob-year" required aria-required="true" onchange="calculateResultIfResultAlreadyCalculated()">
                    <option value="" disabled selected>Select Year</option>
                    <!-- Generate year options dynamically here -->
                </select>

                <label for="dob-month">Month <span style="font-weight: normal;">(optional)</span></label>
                <select id="dob-month" name="dob-month" onchange="calculateResultIfResultAlreadyCalculated()">
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12" selected>December</option>
                </select>

                <label for="dob-day">Day <span style="font-weight: normal;">(optional)</span></label>
                <select id="dob-day" name="dob-day" onchange="calculateResultIfResultAlreadyCalculated()">
                    <option value="" disabled selected>Select Day</option>
                </select>

                <p class="privacy-note">Your privacy matters. Consider leaving your birthday at December 31 at the cost of making you appear younger and giving you a slight disadvantage in the competition.</p>
            </fieldset>

            <!-- Biomarker Fieldset -->
            <fieldset>
                <legend>Biomarkers:</legend>

                <!-- Albumin -->
                <label for="albumin">Albumin</label>
                <div class="input-group">
                    <input type="number" id="albumin" name="albumin" step="0.1" required aria-required="true" onchange="calculateResultIfResultAlreadyCalculated()">
                    <label for="albuminUnit" class="visually-hidden">Select unit for Albumin</label>
                    <select id="albuminUnit" name="albuminUnit" aria-label="Albumin unit" onchange="calculateResultIfResultAlreadyCalculated()">
                        <option value="1">g/L</option>
                        <option value="0.1">g/dL</option>
                        <option value="0.1">mg/dL</option>
                        <option value="0.1">g%</option>
                        <!-- lbumin's molar mass can vary slightly depending on its source and exact composition, usually given as approximately 66,500 g/mol but sometimes noted as 66,430 g/mol or 66,563 g/mol in specific contexts. If we calculate using 66,430 g/mol as the molar mass, then it's: 15.0466µmol/L-->
                        <option value="15.0466">µmol/L</option>
                    </select>
                </div>

                <!-- Creatinine -->
                <label for="creatinine">Creatinine</label>
                <div class="input-group">
                    <input type="number" id="creatinine" name="creatinine" step="0.1" required aria-required="true" onchange="calculateResultIfResultAlreadyCalculated()">
                    <label for="creatinineUnit" class="visually-hidden">Select unit for Creatinine</label>
                    <select id="creatinineUnit" name="creatinineUnit" aria-label="Creatinine unit" onchange="calculateResultIfResultAlreadyCalculated()">
                        <option value="1">µmol/L</option>
                        <option value="0.0113">mg/dL</option>
                        <option value="0.00113">mg/L</option>
                    </select>
                </div>

                <!-- Glucose -->
                <label for="glucose">Glucose</label>
                <div class="input-group">
                    <input type="number" id="glucose" name="glucose" step="0.1" required aria-required="true" onchange="calculateResultIfResultAlreadyCalculated()">
                    <label for="glucoseUnit" class="visually-hidden">Select unit for Glucose</label>
                    <select id="glucoseUnit" name="glucoseUnit" aria-label="Glucose unit" onchange="calculateResultIfResultAlreadyCalculated()">
                        <option value="1">mmol/L</option>
                        <option value="18.016">mg/dL</option>
                        <option value="0.18016">mg%</option>
                    </select>
                </div>

                <!-- C-Reactive Protein -->
                <label for="crp">C-Reactive Protein</label>
                <div class="input-group">
                    <input type="number" id="crp" name="crp" step="0.1" required aria-required="true" onchange="calculateResultIfResultAlreadyCalculated()">
                    <label for="crpUnit" class="visually-hidden">Select unit for C-Reactive Protein</label>
                    <select id="crpUnit" name="crpUnit" aria-label="CRP unit" onchange="calculateResultIfResultAlreadyCalculated()">
                        <option value="10">mg/L</option>
                        <option value="1">mg/dL</option>
                        <option value="10000">mg/mL</option>
                        <option value="86.96">nmol/L</option>
                    </select>
                </div>

                <!-- Lymphocyte Percentage -->
                <label for="lymphocyte">Lymphocytes</label>
                <div class="input-group">
                    <input type="number" id="lymphocyte" name="lymphocyte" step="0.1" required aria-required="true" onchange="calculateResultIfResultAlreadyCalculated()">
                    <label for="lymphocyteUnit" class="visually-hidden">Select unit for Lymphocytes</label>
                    <select id="lymphocyteUnit" name="lymphocyteUnit" aria-label="Lymphocyte unit" onchange="calculateResultIfResultAlreadyCalculated()">
                        <option value="1">%</option>
                        <option value="1">1000 cells/μL</option>
                        <option value="1">10⁹ cells/L</option>
                    </select>
                </div>

                <!-- Mean Corpuscular Volume -->
                <label for="mcv">Mean Corpuscular Volume</label>
                <div class="input-group">
                    <input type="number" id="mcv" name="mcv" step="0.1" required aria-required="true" onchange="calculateResultIfResultAlreadyCalculated()">
                    <label for="mcvUnit" class="visually-hidden">Select unit for MCV</label>
                    <select id="mcvUnit" name="mcvUnit" aria-label="MCV unit" onchange="calculateResultIfResultAlreadyCalculated()">
                        <option value="1">fL</option>
                    </select>
                </div>

                <!-- Red Cell Distribution Width -->
                <label for="rcdw">Red Cell Distribution Width</label>
                <div class="input-group">
                    <input type="number" id="rcdw" name="rcdw" step="0.1" required aria-required="true" onchange="calculateResultIfResultAlreadyCalculated()">
                    <label for="rcdwUnit" class="visually-hidden">Select unit for RDW</label>
                    <select id="rcdwUnit" name="rcdwUnit" aria-label="RDW unit" onchange="calculateResultIfResultAlreadyCalculated()">
                        <option value="1">%</option>
                    </select>
                </div>

                <!-- Alkaline Phosphatase -->
                <label for="ap">Alkaline Phosphatase</label>
                <div class="input-group">
                    <input type="number" id="ap" name="ap" required aria-required="true" onchange="calculateResultIfResultAlreadyCalculated()">
                    <label for="apUnit" class="visually-hidden">Select unit for Alkaline Phosphatase</label>
                    <select id="apUnit" name="apUnit" aria-label="ALP unit" onchange="calculateResultIfResultAlreadyCalculated()">
                        <option value="1">U/L</option>
                        <option value="0.01667">μkat/L</option>
                    </select>
                </div>

                <!-- White Blood Cell Count -->
                <label for="wbc">White Blood Cell Count</label>
                <div class="input-group">
                    <input type="number" id="wbc" name="wbc" step="0.1" required aria-required="true" onchange="calculateResultIfResultAlreadyCalculated()">
                    <label for="wbcUnit" class="visually-hidden">Select unit for White Blood Cell Count</label>
                    <select id="wbcUnit" name="wbcUnit" aria-label="WBC unit" onchange="calculateResultIfResultAlreadyCalculated()">
                        <option value="1">1000 cells/μL</option>
                        <option value="1">10⁹ cells/L</option>
                        <option value="1000">cells/μL</option>
                        <option value="1000">cells/mm³</option>
                    </select>
                </div>
            </fieldset>

            <!-- Calculate Button -->
            <button type="submit" class="option-button" aria-label="Calculate your biological age" style="margin-top: 1.5rem; max-width: 350px;">
                <i class="fas fa-heartbeat"></i>&nbsp;Calculate My Biological Age
            </button>
        </form>

        <div id="phenoAgeResult" class="bioageform"></div>

        <div class="options-container">
            <button id="continueButton" class="option-button already-have" onclick="window.location.href='onboarding/convergence.html'">
                Next&nbsp;<i class="fas fa-arrow-right"></i>
            </button>

            <button class="option-button back-button" onclick="window.location.href='/'">
                <i class="fas fa-home"></i>&nbsp;Back to Homepage
            </button>
        </div>
    </main>
    <!--FOOTER-->
    <!-- JavaScript -->
    <script src="/js/pheno-age.js"></script> <!-- Link to your external script -->
    <script>
        updateMainProgress(2);

        // Event listener for form submission
        document.getElementById('phenoAgeForm').addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent form submission
            calculateResult(); // Calculate the result
        });

        let isResultCalculated = false;
        function calculateResultIfResultAlreadyCalculated() {
            if (isResultCalculated) {
                calculateResult();
            }
        }

        let isFirstTimeAnimation = true; // Flag to control the first-time animation
        function calculateResult() {
            const coefficients = window.PhenoAge.biomarkers.map(marker => marker.coeff);
            const markerValues = [];

            // Get age from separate Date of Birth inputs
            const yearInput = document.getElementById('dob-year').value;
            const monthInput = document.getElementById('dob-month').value;
            const dayInput = document.getElementById('dob-day').value;

            const year = yearInput ? parseInt(yearInput) : null;
            const month = monthInput ? parseInt(monthInput) - 1 : 11; // Convert to 0-based index
            const day = dayInput ? parseInt(dayInput) : 31; // Default to last day

            if (!year) {
                alert("Please select a year.");
                return;
            }

            const dobValue = new Date(year, month, day);  // Month is 0-based (0 = Jan), Day is 1-based (1 = 1st day, 0 = last day of previous month)
            const chronologicalAge = window.PhenoAge.calculateAgeFromDOB(dobValue);

            if (chronologicalAge < 0) {
                alert("Date of birth cannot be in the future.");
                return;
            }

            // Add age as the first marker value
            markerValues.push(chronologicalAge);

            // Get biomarker values
            for (let i = 1; i < window.PhenoAge.biomarkers.length; i++) {
                const biomarker = window.PhenoAge.biomarkers[i];
                const valueElement = document.getElementById(biomarker.id);
                const unitElement = document.getElementById(biomarker.id + 'Unit');
                const rawValue = window.PhenoAge.parseInput(valueElement.value);
                const unitConversion = parseFloat(unitElement.value);
                const unitText = unitElement.options[unitElement.selectedIndex].text;

                // Check for invalid input
                if (isNaN(rawValue)) {
                    alert(`Please enter a valid value for ${biomarker.name}.`);
                    document.getElementById('continueButton').classList.remove('show');
                    return;
                }

                // Apply unit conversion
                let adjustedValue = rawValue / unitConversion;

                // Special handling for CRP
                if (biomarker.id === 'crp') {
                    adjustedValue = Math.log(adjustedValue);
                }

                // Special handling for lymphocytes
                if (biomarker.id === 'lymphocyte' && unitText !== '%') {
                    const wbcValueElement = document.getElementById('wbc');
                    const wbcUnitElement = document.getElementById('wbcUnit');
                    const wbcRawValue = window.PhenoAge.parseInput(wbcValueElement.value);
                    const wbcUnitConversion = parseFloat(wbcUnitElement.value);

                    if (isNaN(wbcRawValue)) {
                        alert("Please provide White Blood Cell Count to calculate Lymphocyte percentage.");
                        document.getElementById('continueButton').classList.remove('show');
                        return;
                    }

                    const wbcAdjustedValue = wbcRawValue / wbcUnitConversion;
                    adjustedValue = (adjustedValue / wbcAdjustedValue) * 100;
                }

                markerValues.push(adjustedValue);
            }

            // Calculate PhenoAge using the helper function
            const phenoAge = window.PhenoAge.calculatePhenoAge(markerValues, coefficients);

            // Display the result
            const resultElement = document.getElementById('phenoAgeResult');

            // Scroll to the result section after displaying the result
            resultElement.scrollIntoView({ behavior: 'smooth' });

            // Initial setup for styling
            resultElement.style.maxWidth = '580px';  // Set max width to match the form
            resultElement.style.padding = '1.5rem';

            resultElement.style.backgroundColor = '#F0F4F8'; // Match the page background
            resultElement.style.color = '#333';              // Standard dark gray
            resultElement.style.border = '1px solid #00BCD4'; // Cyan border matching the button
            resultElement.style.boxShadow = '0 0 10px rgba(0, 188, 212, 0.15)'; // Faint cyan shadow for emphasis

            resultElement.style.borderRadius = '8px';
            resultElement.style.fontSize = '1.5rem';
            resultElement.style.opacity = 0;
            resultElement.style.transition = 'opacity 1s';

            // Setting up the animated counter effect
            let displayAge = 0;
            resultElement.innerHTML = `
                                                                                                                                                                                                                                                                                                                    <div style="font-size: 1rem; color: #2c3e50; text-align: center;">Your biological age is:</div>
                                                                                                                                                                                                                                                                                                                    <div style="font-size: 2.5rem; color: #4CAF50; font-weight: bold; text-align: center;"><span id="animatedAge">0</span></div>
                                                                                                                                                                                                                                                                                                                    <div id="yearsText" style="font-size: 1rem; color: #2c3e50; text-align: center;">years</div>
                                                                                                                                                                                                                                                                                                            `;

            if (isFirstTimeAnimation) {
                // Set the flag to false after the first run
                isFirstTimeAnimation = false;

                setTimeout(() => {
                    resultElement.style.opacity = 1; // Fade-in effect
                    const ageCounter = setInterval(() => {
                        displayAge += 1;
                        document.getElementById('animatedAge').innerText = displayAge.toFixed(0);
                        if (displayAge >= phenoAge) {
                            clearInterval(ageCounter);
                            document.getElementById('animatedAge').innerText = phenoAge.toFixed(1); // Set final age value

                            if (phenoAge < chronologicalAge) {
                                // Add the celebratory emoji to the "years" line
                                document.getElementById('yearsText').innerHTML = `years 🚀`;
                            }

                            // Show the Next button
                            document.getElementById('continueButton').classList.add('show');
                        }
                    }, 30);
                }, 100);
            } else {
                setTimeout(() => {
                    resultElement.style.opacity = 1; // Fade-in effect
                    // Direct update without animation
                    document.getElementById('animatedAge').innerText = phenoAge.toFixed(1);
                    document.getElementById('yearsText').innerHTML = phenoAge < chronologicalAge ? `years 🚀` : `years`;

                    document.getElementById('continueButton').classList.add('show');
                }, 100);
            }

            isResultCalculated = true;
        }

        document.addEventListener('DOMContentLoaded', function () {
            const unitSelects = document.querySelectorAll('.input-group select');
            let maxWidth = 0;

            unitSelects.forEach(select => {
                // Temporarily add the select to the body to calculate its full width
                const tempDiv = document.createElement('div');
                tempDiv.style.position = 'absolute';
                tempDiv.style.visibility = 'hidden';
                tempDiv.appendChild(select.cloneNode(true));
                document.body.appendChild(tempDiv);

                // Update maxWidth if this select's width is larger
                maxWidth = Math.max(maxWidth, tempDiv.clientWidth + 20);
                document.body.removeChild(tempDiv);
            });

            // Set the maxWidth as the min-width for each unit select
            unitSelects.forEach(select => {
                select.style.minWidth = `${maxWidth}px`;
            });

            const yearSelect = document.getElementById('dob-year');
            const currentYear = new Date().getFullYear();

            for (let year = currentYear; year >= 1908; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }

            updateDays(); // Added line

            // Check if the URL has the query parameter "fake=1"
            const urlParams = new URLSearchParams(window.location.search);
            const isFake = urlParams.get('fake') === '1';
            if (isFake) {
                fillFakeData();
            }
        });

        function fillFakeData() {
            // Set fake Date of Birth
            document.getElementById('dob-year').value = 1966;
            document.getElementById('dob-month').value = 7;
            document.getElementById('dob-day').value = 12;

            // Set fake values for all input fields
            document.getElementById('albumin').value = 45; // g/L
            document.getElementById('albuminUnit').value = 1; // g/L

            document.getElementById('creatinine').value = 80; // µmol/L
            document.getElementById('creatinineUnit').value = 1; // µmol/L

            document.getElementById('glucose').value = 4.5; // mmol/L
            document.getElementById('glucoseUnit').value = 1; // mmol/L

            document.getElementById('crp').value = 1.8; // mg/L
            document.getElementById('crpUnit').value = 10; // mg/L

            document.getElementById('lymphocyte').value = 39; // %
            document.getElementById('lymphocyteUnit').value = 1; // %

            document.getElementById('mcv').value = 85; // fL
            document.getElementById('mcvUnit').value = 1; // fL

            document.getElementById('rcdw').value = 11; // %
            document.getElementById('rcdwUnit').value = 1; // %

            document.getElementById('ap').value = 12; // U/L
            document.getElementById('apUnit').value = 1; // U/L

            document.getElementById('wbc').value = 6; // 1000 cells/μL
            document.getElementById('wbcUnit').value = 1; // 1000 cells/μL
        }

        function updateDays() {
            const year = parseInt(document.getElementById('dob-year').value);
            const month = parseInt(document.getElementById('dob-month').value);
            const daySelect = document.getElementById('dob-day');

            // Clear existing options
            daySelect.innerHTML = '<option value="" disabled selected>Select Day</option>';

            if (month) {
                const monthIndex = month - 1; // Adjust to 0-based index
                const tempYear = year || 2001; // Use selected year or default
                const lastDay = new Date(tempYear, month, 0).getDate(); // Month is 0-based (0 = Jan), Day is 1-based (1 = 1st day, 0 = last day of previous month)
                for (let day = 1; day <= lastDay; day++) {
                    const option = document.createElement('option');
                    option.value = day;
                    option.textContent = day;
                    daySelect.appendChild(option);
                }
                daySelect.value = lastDay;
            } else {
                // Default to 31 days
                for (let day = 1; day <= 31; day++) {
                    const option = document.createElement('option');
                    option.value = day;
                    option.textContent = day;
                    daySelect.appendChild(option);
                }
                daySelect.value = 31;
            }
        }

        document.getElementById('dob-year').addEventListener('change', updateDays);
        document.getElementById('dob-month').addEventListener('change', updateDays);
    </script>
</body>
</html>