<!DOCTYPE html>
<html lang="en">
<head>
    <title>Longevity World Cup - Pheno Age</title>
    <!--HEAD-->
    <link rel="preload" href="/css/bioageform.css" as="style">
    <link rel="stylesheet" href="/css/bioageform.css">
    <style>
        /* Match join-game biological age intro styling; align width with .bioageform */
        .lab-reassurance {
            margin: 1.5rem auto 0;
            max-width: 600px;
            padding: 1rem 1.25rem;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            background: #f8f9fa;
            font-size: 0.95rem;
            text-align: center;
        }

        /* Hide the join-game button in the header */
        .join-game {
            display: none;
        }

        /* Visually Hidden Class for Accessibility */
        .visually-hidden {
            position: absolute !important;
            height: 1px;
            width: 1px;
            overflow: hidden;
            clip: rect(1px, 1px, 1px, 1px);
            white-space: nowrap;
        }

        /* Error Highlighting */
        .errorNaN {
            border: 2px solid red;
        }

        .privacy-note {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.5rem;
        }

        /* Initial state: hidden and rotated to the left */
        #continueButton {
            opacity: 0;
            transform-origin: left;
            transform: rotate(-90deg);
            overflow: hidden;
            transition: opacity 0.6s ease, transform 0.6s ease;
            pointer-events: none; /* Prevents the button from capturing mouse events */
        }

            /* Final state: fully visible and upright */
            #continueButton.show {
                opacity: 1;
                transform: rotate(0);
                pointer-events: auto; /* Restores mouse events when visible */
            }

        .input-group {
            display: flex;
            align-items: center;
            margin-top: 0.5rem;
        }

            .input-group input {
                flex: 1;
            }

            .input-group select {
                margin-left: 0.5rem;
                padding: 0.5rem;
                border: 1px solid #ccc;
                border-radius: 4px;
                width: auto;
                min-width: var(--unit-select-min-width, auto); /* Placeholder variable for dynamic width */
            }

            .input-group.lwc-date-flex input[type="date"] {
                flex: 1;
                padding: 0.5rem;
                min-height: 40px; /* visually matches your other controls */
                box-sizing: border-box;
            }

        /* Give all selects proper right padding and a consistent arrow */
        .bioageform select,
        #dobFieldset select {
            padding-right: 2.25rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>");
            background-repeat: no-repeat;
            background-position: right 0.6rem center;
            background-size: 12px 12px;
        }

        #phenoAgeResult {
            max-width: 580px;
            padding: 1.5rem;
            color: var(--dark-text-color);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.15);
            border-radius: 8px;
            font-size: 1.5rem;
            opacity: 0;
            transition: opacity 1s;
            position: relative;
            overflow: hidden;
        }

        /* When result is not shown, collapse it so the Back button sits near the form on step 1 */
        #phenoAgeResult:not(.show) {
            height: 0;
            min-height: 0;
            padding: 0;
            margin: 0;
            overflow: hidden;
            border: none;
            box-shadow: none;
        }

        #phenoAgeResult.show {
            opacity: 1;
        }

        /* Elegant animated background gradient */
        #phenoAgeResult::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200%;
            height: 200%;
            transform: translate(-50%, -50%);
            background: radial-gradient(circle at 30% 30%, rgba(0, 188, 212, 0.08) 0%, rgba(76, 175, 80, 0.04) 40%, transparent 70%);
            animation: bioAgeBgPulse 12s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes bioAgeBgPulse {
            0%, 100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.4;
            }
            50% {
                transform: translate(calc(-50% + 5%), calc(-50% + 5%)) scale(1.1);
                opacity: 0.7;
            }
        }

        #validAgeInput {
            position: relative;
            z-index: 1;
        }

        /* Label text styling */
        #validAgeInput > div:first-child {
            font-size: 0.875rem;
            color: #64748b;
            text-align: center;
            margin-bottom: 1.5rem;
            opacity: 0;
            transform: translateY(15px);
            transition: opacity 0.7s cubic-bezier(0.16, 1, 0.3, 1) 0.3s, transform 0.7s cubic-bezier(0.16, 1, 0.3, 1) 0.3s;
            font-weight: 600;
            letter-spacing: 1.2px;
            text-transform: uppercase;
        }

        #phenoAgeResult.show #validAgeInput > div:first-child {
            opacity: 1;
            transform: translateY(0);
        }

        /* Main age number container */
        .bio-age-number-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 2rem 0;
            width: 100%;
            min-height: 140px;
            padding: 1rem 0;
        }

        #animatedAge {
            font-size: 6.5rem;
            font-weight: 800;
            text-align: center;
            display: block;
            color: #00bcd4;
            background: linear-gradient(135deg, #00bcd4 0%, #4CAF50 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: none;
            line-height: 1;
            letter-spacing: -3px;
            opacity: 0;
            transform: scale(0.4) translateY(30px);
            transition: opacity 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.4s, transform 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.4s;
            position: relative;
            z-index: 1;
            font-family: 'Roboto', sans-serif;
        }

        #phenoAgeResult.show #animatedAge {
            opacity: 1;
            transform: scale(1) translateY(0);
        }

        /* Subtle glow effect for the number */
        #animatedAge::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 140%;
            height: 140%;
            background: radial-gradient(circle, rgba(0, 188, 212, 0.15) 0%, rgba(76, 175, 80, 0.1) 50%, transparent 75%);
            border-radius: 50%;
            z-index: -1;
            opacity: 0;
            animation: bioAgeGlow 3s ease-in-out infinite;
            filter: blur(20px);
        }

        @keyframes bioAgeGlow {
            0%, 100% {
                opacity: 0.3;
                transform: translate(-50%, -50%) scale(0.9);
            }
            50% {
                opacity: 0.6;
                transform: translate(-50%, -50%) scale(1.1);
            }
        }

        /* Pulse animation when counting */
        #animatedAge.counting {
            animation: bioAgePulse 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes bioAgePulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.03);
            }
            100% {
                transform: scale(1);
            }
        }

        /* Final reveal animation */
        #animatedAge.final-reveal {
            animation: bioAgeFinalReveal 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes bioAgeFinalReveal {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.12);
            }
            100% {
                transform: scale(1);
            }
        }

        /* Color variations based on performance */
        #animatedAge.age-excellent {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        #animatedAge.age-excellent::after {
            background: radial-gradient(circle, rgba(46, 204, 113, 0.2) 0%, rgba(39, 174, 96, 0.1) 50%, transparent 75%);
        }

        #animatedAge.age-good {
            background: linear-gradient(135deg, #00bcd4 0%, #4CAF50 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        #animatedAge.age-average {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        #animatedAge.age-average::after {
            background: radial-gradient(circle, rgba(255, 152, 0, 0.15) 0%, rgba(245, 124, 0, 0.1) 50%, transparent 75%);
        }

        /* Years text styling */
        #yearsText {
            font-size: 1.25rem;
            color: #64748b;
            text-align: center;
            margin-top: 1rem;
            opacity: 0;
            transform: translateY(15px);
            transition: opacity 0.7s cubic-bezier(0.16, 1, 0.3, 1) 0.5s, transform 0.7s cubic-bezier(0.16, 1, 0.3, 1) 0.5s;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        #phenoAgeResult.show #yearsText {
            opacity: 1;
            transform: translateY(0);
        }

        /* Responsive design */
        @media (max-width: 768px) {
            #phenoAgeResult {
                padding: 2rem 1.5rem;
                margin: 1.5rem auto;
            }

            .bio-age-number-container {
                min-height: 120px;
                margin: 1.5rem 0;
            }

            #animatedAge {
                font-size: 5rem;
                letter-spacing: -2px;
            }

            #validAgeInput > div:first-child {
                font-size: 0.8rem;
                margin-bottom: 1.25rem;
            }

            #yearsText {
                font-size: 1.1rem;
                margin-top: 0.75rem;
            }
        }

        @media (max-width: 480px) {
            #phenoAgeResult {
                padding: 2.5rem 1.5rem;
                margin: 1.5rem auto;
                border-radius: 18px;
            }

            .bio-age-number-container {
                min-height: 100px;
                margin: 1.25rem 0;
            }

            #animatedAge {
                font-size: 4rem;
                letter-spacing: -1.5px;
            }

            #validAgeInput > div:first-child {
                font-size: 0.75rem;
                letter-spacing: 0.8px;
            }

            #yearsText {
                font-size: 1rem;
            }
        }

        /* Respect reduced motion preference */
        @media (prefers-reduced-motion: reduce) {
            #phenoAgeResult,
            #animatedAge,
            #validAgeInput > div:first-child,
            #yearsText {
                animation: none !important;
                transition: opacity 0.3s ease !important;
            }

            #phenoAgeResult::before {
                animation: none !important;
            }

            #animatedAge::after {
                animation: none !important;
            }
        }

        .crp-container {
            margin-bottom: 1rem;
        }

        .label-toggle-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

            .label-toggle-group label {
                font-size: 1rem;
                color: #333;
            }

        .negative-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem; /* This sets a small gap between the toggle and the text */
        }

        .toggle-label {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 20px;
            margin-right: 0rem;
        }

            .toggle-label input {
                opacity: 0;
                width: 0;
                height: 0;
            }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 20px;
        }

            .slider:before {
                position: absolute;
                content: "";
                height: 14px;
                width: 14px;
                left: 3px;
                bottom: 3px;
                background-color: white;
                transition: 0.4s;
                border-radius: 50%;
            }

        .toggle-label input:checked + .slider {
            background-color: #f4a6a6; /* Pale red */
        }

            .toggle-label input:checked + .slider:before {
                transform: translateX(16px);
            }

        .bioageform-toggle-text {
            font-size: 0.9rem;
        }

        /* Mini-card container */
        .biomarker-card {
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
            transition: box-shadow 0.2s ease;
        }

            .biomarker-card.active {
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }

        /* Header bar */
        .biomarker-card-header {
            background: #f7f7f7;
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

            .biomarker-card-header:hover {
                background: #ececec;
            }

        /* Toggle icon */
        .toggle-icon {
            font-weight: bold;
            font-size: 1.2rem;
            line-height: 1;
        }

        /* Hidden content by default */
        .biomarker-card-content {
            max-height: 0;
            overflow: hidden;
            padding: 0 1rem; /* keep horizontal padding */
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

            .biomarker-card-content > .input-group:first-of-type {
                margin-top: 0;
            }

        @media (max-width: 768px) {
            /* Must use important because back button styles applied later. Without important it doesn't overwrite it. */
            .back-button {
                margin-right: auto !important;
                margin-left: 0 !important; /* Resets left margin */
            }
        }

        /* --- LWC 2-step wizard --- */
        .lwc-steps-shell {
            position: relative;
            max-width: 780px;
            margin: 0 auto;
        }

        .lwc-step {
            display: none;
            opacity: 0;
            transform: translateX(24px);
            transition: opacity .35s ease, transform .35s ease;
        }

            .lwc-step.lwc-step--active {
                display: block;
            }

            .lwc-step.lwc-step--visible {
                opacity: 1;
                transform: translateX(0);
            }

        .lwc-wizard-nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 0.75rem 0 1.25rem 0;
            user-select: none;
        }

        .lwc-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid #bbb;
            background: transparent;
        }
        @media (hover: hover) and (pointer: fine) {
            .lwc-dot {
                cursor: pointer;
            }
        }

        .lwc-dot.lwc-dot--on {
            background: #4CAF50;
            border-color: #4CAF50;
            cursor: default;
            pointer-events: none;
        }


        .lwc-step-actions {
            display: flex;
            gap: .75rem;
            justify-content: center;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <!--HEADER-->
    <main>
        <div class="lwc-steps-shell" id="lwcStepsShell">
            <!--MAIN-PROGRESS-BAR-->
            <h1 id="mainPageTitleH2" data-aos="fade" data-aos-duration="700" data-aos-delay="250">
                This is <span style="color:#b22222">blood</span> sport
            </h1>
            <p id="mainInstructions" class="lab-reassurance" data-aos="fade" data-aos-duration="700" data-aos-delay="300">Calculate your <strong>biological age</strong>, known as <a href="https://github.com/nopara73/LongevityWorldCup/blob/master/LongevityWorldCup.Documentation/pheno-age.pdf" target="_blank" rel="noopener">Pheno Age</a>:</p>
            <form id="phenoAgeForm" class="bioageform" data-aos="fade" data-aos-duration="700" data-aos-delay="350">
                <div class="lwc-wizard-nav" aria-hidden="true">
                    <div class="lwc-dot lwc-dot--on" id="lwcDot1" role="button" tabindex="0" aria-label="Go to Step 1"></div>
                    <div class="lwc-dot" id="lwcDot2" role="button" tabindex="0" aria-label="Go to Step 2"></div>
                </div>
                <section id="lwc-step-1" class="lwc-step lwc-step--active lwc-step--visible" aria-labelledby="lwcStep1Title">

                    <!-- Date of Birth Fields -->
                    <fieldset id="dobFieldset">
                        <h2 id="lwcStep1Title" class="visually-hidden">Step 1: Your age & blood draw date</h2>

                        <legend>Date of birth:</legend>
                        <label for="dob-year">Year <span style="font-weight: normal;">(required)</span></label>
                        <select id="dob-year" name="dob-year" required aria-required="true" onchange="calculateResultIfResultAlreadyCalculated()">
                            <option value="" disabled selected>Select year</option>
                            <!-- Generate year options dynamically here -->
                        </select>

                        <label for="dob-month" id="dob-month-label">
                            Month <span style="font-weight: normal;">(optional)</span>
                        </label>
                        <select id="dob-month" name="dob-month" onchange="calculateResultIfResultAlreadyCalculated()">
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12" selected>December</option>
                        </select>

                        <label for="dob-day" id="dob-day-label">
                            Day <span style="font-weight: normal;">(optional)</span>
                        </label>
                        <select id="dob-day" name="dob-day" onchange="calculateResultIfResultAlreadyCalculated()">
                            <option value="" disabled selected>Select day</option>
                        </select>

                        <p class="privacy-note" id="privacyNote">Your privacy matters. Consider leaving your birthday at December 31 at the cost of making you appear younger and giving you a slight disadvantage in the competition.</p>
                    </fieldset>

                    <!-- Blood Draw Details -->
                    <fieldset>
                        <legend>Blood draw date:</legend>
                        <p class="privacy-note">When did you get your blood test done?</p>
                        <div class="input-group lwc-date-flex">
                            <input type="date" id="blood-draw-date" name="blood-draw-date" required aria-required="true" max="" onchange="calculateResultIfResultAlreadyCalculated()" inputmode="none" onkeydown="return false" onkeypress="return false" onkeyup="return false" onpaste="return false" ondrop="return false" autocomplete="off">
                        </div>
                    </fieldset>
                    <div class="lwc-step-actions">
                        <button type="button" id="lwcToStep2Btn" class="option-button green" aria-label="Continue to biomarkers">
                            Continue&nbsp;<i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </section>

                <section id="lwc-step-2" class="lwc-step" aria-labelledby="lwcStep2Title">
                    <h2 id="lwcStep2Title" class="visually-hidden">Step 2: Enter Biomarkers</h2>
                    <div class="lwc-step-actions" style="justify-content:flex-start">
                        <button type="button" id="lwcToStep1Btn" class="option-button back-button">
                            <i class="fas fa-arrow-left"></i>&nbsp;Back
                        </button>
                    </div>

                    <!-- Biomarkers grouped by domain (aligned with leaderboard Best Domain badges) -->
                    <fieldset>
                        <legend><i class="fas fa-virus category-icon" aria-hidden="true"></i>Immune</legend>
                        <div class="biomarker-card">
                            <div class="biomarker-card-header" aria-expanded="false">
                                White blood cell count (WBC)
                                <span class="toggle-icon">+</span>
                            </div>
                            <div class="biomarker-card-content">
                                <div class="input-group">
                                    <input type="number" id="wbc" name="wbc" step="any" required aria-required="true" inputmode="decimal" onchange="calculateResultIfResultAlreadyCalculated()">
                                    <label for="wbcUnit" class="visually-hidden">Select unit for white blood cell count</label>
                                    <select id="wbcUnit" name="wbcUnit" aria-label="WBC unit" onchange="calculateResultIfResultAlreadyCalculated()">
                                        <option value="1">1000 cells/ŒºL</option>
                                        <option value="1">10‚Åπ cells/L</option>
                                        <option value="1000">cells/ŒºL</option>
                                        <option value="1000">cells/mm¬≥</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="biomarker-card">
                            <div class="biomarker-card-header" aria-expanded="false">
                                Lymphocytes
                                <span class="toggle-icon">+</span>
                            </div>
                            <div class="biomarker-card-content">
                                <div class="input-group">
                                    <input type="number" id="lymphocyte" name="lymphocyte" step="any" required aria-required="true" inputmode="decimal" onchange="calculateResultIfResultAlreadyCalculated()">
                                    <label for="lymphocyteUnit" class="visually-hidden">Select unit for Lymphocytes</label>
                                    <select id="lymphocyteUnit" name="lymphocyteUnit" aria-label="Lymphocyte unit" onchange="calculateResultIfResultAlreadyCalculated()">
                                        <option value="1">%</option>
                                        <option value="1">1000 cells/ŒºL</option>
                                        <option value="1">10‚Åπ cells/L</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="biomarker-card">
                            <div class="biomarker-card-header" aria-expanded="false">
                                Mean corpuscular volume (MCV)
                                <span class="toggle-icon">+</span>
                            </div>
                            <div class="biomarker-card-content">
                                <div class="input-group">
                                    <input type="number" id="mcv" name="mcv" step="any" required aria-required="true" inputmode="decimal" onchange="calculateResultIfResultAlreadyCalculated()">
                                    <label for="mcvUnit" class="visually-hidden">Select unit for MCV</label>
                                    <select id="mcvUnit" name="mcvUnit" aria-label="MCV unit" onchange="calculateResultIfResultAlreadyCalculated()">
                                        <option value="1">fL</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="biomarker-card">
                            <div class="biomarker-card-header" aria-expanded="false">
                                Red cell distribution width (RDW, RDW-CV)
                                <span class="toggle-icon">+</span>
                            </div>
                            <div class="biomarker-card-content">
                                <div class="input-group">
                                    <input type="number" id="rcdw" name="rcdw" step="any" required aria-required="true" inputmode="decimal" onchange="calculateResultIfResultAlreadyCalculated()">
                                    <label for="rcdwUnit" class="visually-hidden">Select unit for RDW</label>
                                    <select id="rcdwUnit" name="rcdwUnit" aria-label="RDW unit" onchange="calculateResultIfResultAlreadyCalculated()">
                                        <option value="1">%</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <fieldset>
                        <legend><i class="fas fa-droplet category-icon" aria-hidden="true"></i>Liver</legend>
                        <div class="biomarker-card">
                            <div class="biomarker-card-header" aria-expanded="false">
                                Albumin
                                <span class="toggle-icon">+</span>
                            </div>
                            <div class="biomarker-card-content">
                                <div class="input-group">
                                    <input type="number" id="albumin" name="albumin" step="any" required aria-required="true" inputmode="decimal" onchange="calculateResultIfResultAlreadyCalculated()">
                                    <label for="albuminUnit" class="visually-hidden">Select unit for Albumin</label>
                                    <select id="albuminUnit" name="albuminUnit" aria-label="Albumin unit" onchange="calculateResultIfResultAlreadyCalculated()">
                                        <option value="1">g/L</option>
                                        <option value="0.1">g/dL</option>
                                        <option value="0.1">g%</option>
                                        <!-- Albumin's molar mass can vary slightly depending on its source and exact composition, usually given as approximately 66,500 g/mol but sometimes noted as 66,430 g/mol or 66,563 g/mol in specific contexts. If we calculate using 66,430 g/mol as the molar mass, then it's: 15.0466¬µmol/L -->
                                        <option value="15.0466">¬µmol/L</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="biomarker-card">
                            <div class="biomarker-card-header" aria-expanded="false">
                                Alkaline phosphatase (ALP)
                                <span class="toggle-icon">+</span>
                            </div>
                            <div class="biomarker-card-content">
                                <div class="input-group">
                                    <input type="number" id="ap" name="ap" step="any" required aria-required="true" inputmode="decimal" onchange="calculateResultIfResultAlreadyCalculated()">
                                    <label for="apUnit" class="visually-hidden">Select unit for alkaline phosphatase</label>
                                    <select id="apUnit" name="apUnit" aria-label="AP unit" onchange="calculateResultIfResultAlreadyCalculated()">
                                        <option value="1">U/L</option>
                                        <option value="0.01667">Œºkat/L</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <fieldset>
                        <legend><i class="fas fa-toilet category-icon" aria-hidden="true"></i>Kidney</legend>
                        <div class="biomarker-card">
                            <div class="biomarker-card-header" aria-expanded="false">
                                Creatinine
                                <span class="toggle-icon">+</span>
                            </div>
                            <div class="biomarker-card-content">
                                <div class="input-group">
                                    <input type="number" id="creatinine" name="creatinine" step="any" required aria-required="true" inputmode="decimal" onchange="calculateResultIfResultAlreadyCalculated()">
                                    <label for="creatinineUnit" class="visually-hidden">Select unit for Creatinine</label>
                                    <select id="creatinineUnit" name="creatinineUnit" aria-label="Creatinine unit" onchange="calculateResultIfResultAlreadyCalculated()">
                                        <option value="1">¬µmol/L</option>
                                        <option value="0.0113">mg/dL</option>
                                        <option value="0.00113">mg/L</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <fieldset>
                        <legend><i class="fas fa-fire category-icon" aria-hidden="true"></i>Metabolism</legend>
                        <div class="biomarker-card">
                            <div class="biomarker-card-header" aria-expanded="false">
                                Glucose
                                <span class="toggle-icon">+</span>
                            </div>
                            <div class="biomarker-card-content">
                                <div class="input-group">
                                    <input type="number" id="glucose" name="glucose" step="any" required aria-required="true" inputmode="decimal" onchange="calculateResultIfResultAlreadyCalculated()">
                                    <label for="glucoseUnit" class="visually-hidden">Select unit for Glucose</label>
                                    <select id="glucoseUnit" name="glucoseUnit" aria-label="Glucose unit" onchange="calculateResultIfResultAlreadyCalculated()">
                                        <option value="1">mmol/L</option>
                                        <option value="18.016">mg/dL</option>
                                        <option value="0.18016">mg%</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <fieldset>
                        <legend><i class="fas fa-temperature-three-quarters category-icon" aria-hidden="true"></i>Inflammation</legend>
                        <div class="biomarker-card">
                            <div class="biomarker-card-header" aria-expanded="false">
                                C-reactive protein (CRP)
                                <span class="toggle-icon">+</span>
                            </div>
                            <div class="biomarker-card-content">
                                <div class="crp-container">
                                    <div class="label-toggle-group">
                                        <span title="Check this box if your result is below your lab's 'the detection limit and this limit is unknown" class="bioageform-toggle-text">Set if negative:</span>
                                        <div title="Check this box if your result is below your lab's 'the detection limit and this limit is unknown" class="negative-toggle">
                                            <label for="crp-negative" class="toggle-label">
                                                <input type="checkbox" id="crp-negative" onchange="toggleCRPInput()">
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="input-group">
                                        <input type="number" id="crp" name="crp" step="any" required aria-required="true" inputmode="decimal" onchange="calculateResultIfResultAlreadyCalculated()">
                                        <label for="crpUnit" class="visually-hidden">Select unit for C-reactive protein</label>
                                        <select id="crpUnit" name="crpUnit" aria-label="CRP unit" onchange="calculateResultIfResultAlreadyCalculated()">
                                            <option value="10">mg/L</option>
                                            <option value="1">mg/dL</option>
                                            <option value="10000">mg/mL</option>
                                            <option value="86.96">nmol/L</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Calculate Button -->
                    <button type="submit" class="option-button grey" aria-label="Calculate your biological age" style="width: 100%; display: block; box-sizing: border-box; margin-top: 1rem;">
                        <i class="fas fa-heartbeat"></i>&nbsp;Calculate my biological&nbsp;age
                    </button>
                </section>
            </form>
        </div>
        <div id="phenoAgeResult" class="bioageform" data-aos="fade" data-aos-duration="700" data-aos-delay="400">
            <div id="validAgeInput">
                <div>Your biological age is:</div>
                <div class="bio-age-number-container">
                    <span id="animatedAge">0</span>
                </div>
                <div id="yearsText">years</div>
            </div>
            <div id="ensureCorrectInputSuggestion" style="display: none; font-size: 1rem; color: #8B0000; background-color: #FAD2D2; padding: 0.5rem; text-align: center; border-radius: 5px; margin-top: 10px;">
                The calculated result seems wrong. Double-check all your input values and units. If everything looks correct, drop everything and rush to a hospital NOW!!!
                <i class="fas fa-ambulance"></i> <i class="fas fa-hospital"></i> <i class="fas fa-clinic-medical"></i>
            </div>
        </div>

        <div class="options-container" data-aos="fade" data-aos-duration="700" data-aos-delay="450">
            <button type="button" id="continueButton" class="option-button green" onclick="proceedToNextPage()">
                Next&nbsp;<i class="fas fa-arrow-right"></i>
            </button>

            <button type="button" class="option-button back-button" onclick="window.goBackOrHome()">
                <i class="fas fa-arrow-left"></i>&nbsp;Back
            </button>
        </div>
    </main>
    <!--FOOTER-->
    <!-- JavaScript -->
    <script defer>
        history.replaceState({}, '', '/pheno-age' + (window.location.search || '') + (window.location.hash || ''));

        // Check if the URL has the query parameter "fake=1"
        const urlParams = new URLSearchParams(window.location.search);
        const isFake = urlParams.get('fake') === '1';
        const isUpdate = urlParams.get('update') === '1';
        const athlete = JSON.parse(sessionStorage.getItem('selectedAthlete'));
        const bloodDrawDateInput = document.getElementById('blood-draw-date');

        if (bloodDrawDateInput) {
            const todayLocal = new Date();
            todayLocal.setHours(0, 0, 0, 0);
            const y = todayLocal.getFullYear();
            const m = String(todayLocal.getMonth() + 1).padStart(2, '0');
            const d = String(todayLocal.getDate()).padStart(2, '0');
            const todayStr = `${y}-${m}-${d}`;
            bloodDrawDateInput.max = todayStr;
            bloodDrawDateInput.value = todayStr;

            // Open the native picker on focus/click (only when supported)
            const lwcOpenDatePickerGuarded = () => {
                if (typeof bloodDrawDateInput.showPicker === 'function' && !bloodDrawDateInput.disabled) {
                    try { bloodDrawDateInput.showPicker(); } catch (_) { /* ignore */ }
                }
            };
            bloodDrawDateInput.addEventListener('focus', lwcOpenDatePickerGuarded);
            bloodDrawDateInput.addEventListener('click', lwcOpenDatePickerGuarded);

            // Block manual edits (typing/paste/drop), but keep control mutable so showPicker works
            ['keypress', 'keydown', 'keyup', 'paste', 'drop'].forEach(evt =>
                bloodDrawDateInput.addEventListener(evt, e => e.preventDefault())
            );
            bloodDrawDateInput.addEventListener('beforeinput', e => {
                // Allow programmatic changes only
                if (!e.inputType || e.inputType !== 'insertReplacementText') e.preventDefault();
            });
        }

        //‚Äì‚Äì keep track of which fields the user actually edits (or clears)
        const touchedBiomarkers = new Set();
        ['wbc', 'lymphocyte', 'mcv', 'rcdw', 'albumin', 'ap', 'creatinine', 'glucose', 'crp']
            .forEach(id => {
                const el = document.getElementById(id);
                el.addEventListener('input', () => {
                    if (el.value.trim() === '') touchedBiomarkers.delete(id);
                    else touchedBiomarkers.add(id);

                    const card = el.closest('.biomarker-card');
                    const headerField = card.querySelector('.biomarker-card-header');
                    const iconField = headerField.querySelector('.toggle-icon');
                    if (el.value.trim() !== '') {
                        headerField.style.pointerEvents = 'none';
                        iconField.style.display = 'none';

                        expandFieldCard(card);
                    } else if (isUpdate) {
                        headerField.style.pointerEvents = '';
                        iconField.style.display = '';
                    }

                });
            });

        //‚Äì‚Äì seed from stored data
        const stored = JSON.parse(sessionStorage.getItem('biomarkerData'));
        if (stored?.Biomarkers?.[0]) {
            const latest = stored.Biomarkers[0];
            if (latest.Date && bloodDrawDateInput) {
                bloodDrawDateInput.value = latest.Date;
            }
            const propMap = {
                wbc: 'Wbc1000cellsuL',
                lymphocyte: 'LymPc',
                mcv: 'McvFL',
                rcdw: 'RdwPc',
                albumin: 'AlbGL',
                ap: 'AlpUL',
                creatinine: 'CreatUmolL',
                glucose: 'GluMmolL',
                crp: 'CrpMgL'
            };

            Object.entries(propMap).forEach(([id, prop]) => {
                if (latest[prop] != null && !isNaN(latest[prop])) {
                    touchedBiomarkers.add(id);
                }
            });
        }

        function getValidatedBloodDrawDate() {
            if (!bloodDrawDateInput) return null;

            const rawValue = bloodDrawDateInput.value;
            if (!rawValue) {
                customAlert('Please enter the date when your blood was drawn.');
                bloodDrawDateInput.focus();
                return null;
            }

            const selectedDate = new Date(`${rawValue}T00:00:00`);
            const maxDate = bloodDrawDateInput.max ? new Date(`${bloodDrawDateInput.max}T00:00:00`) : null;

            if (maxDate && selectedDate > maxDate) {
                customAlert('Blood draw date cannot be in the future.');
                bloodDrawDateInput.focus();
                return null;
            }

            return rawValue;
        }

        function updateCalculateButton() {
            const calculateButton = document.querySelector('form button[type="submit"]');
            const nextButton = document.getElementById('continueButton');

            if (nextButton.classList.contains('show')) {
                calculateButton.classList.remove('green'); // Reset style
            } else {
                calculateButton.classList.add('green'); // Apply matching style
            }
        }

        updateCalculateButton();

        let isResultCalculated = false;
        function calculateResultIfResultAlreadyCalculated() {
            if (isResultCalculated) {
                calculateResult();
            }
        }

        function correctCorrectableUnits() {
            // Albumin
            const albuminValue = parseFloat(document.getElementById('albumin').value);
            const albuminUnit = parseFloat(document.getElementById('albuminUnit').value);
            if (albuminUnit != 15.0466 && albuminValue > 300) {
                console.warn("Albumin is too high. Correcting the unit.");
                document.getElementById('albuminUnit').value = 15.0466;
            }
            else if (albuminUnit != 0.1 && albuminValue < 6) {
                console.warn("Albumin is too low. Correcting the unit.");
                document.getElementById('albuminUnit').value = 0.1;
            }
            else if (albuminUnit != 1 && albuminValue > 10 && albuminValue < 60) {
                console.warn("Albumin is too low. Correcting the unit.");
                document.getElementById('albuminUnit').value = 1;
            }

            // White Blood Cell Count (WBC)
            const wbcValue = parseFloat(document.getElementById('wbc').value);
            const wbcUnit = parseFloat(document.getElementById('wbcUnit').value);
            if (wbcUnit === 1 && wbcValue > 4000) {
                console.warn("WBC is too high. Correcting the unit.");
                document.getElementById('wbcUnit').value = 1000;
            }
            else if (wbcUnit === 1000 && wbcValue < 30) {
                console.warn("WBC is too low. Correcting the unit.");
                document.getElementById('wbcUnit').value = 1;
            }
        }

        let isFirstTimeAnimation = true; // Flag to control the first-time animation

        function calculateResult() {
            // In update mode, ensure at least one new biomarker was entered
            if (isUpdate) {
                if (touchedBiomarkers.size < 9) {
                    document.getElementById('continueButton').classList.remove('show');
                    customAlert('üò± Need to submit all 9 biomarkers!');
                    return;
                }
            }

            const bloodDrawDate = getValidatedBloodDrawDate();
            if (!bloodDrawDate) {
                document.getElementById('continueButton').classList.remove('show');
                updateCalculateButton();
                return;
            }

            const markerValues = [];

            // Get age from separate Date of Birth inputs
            const yearInput = document.getElementById('dob-year').value;
            const monthInput = document.getElementById('dob-month').value;
            const dayInput = document.getElementById('dob-day').value;

            const year = yearInput ? parseInt(yearInput) : null;
            const month = monthInput ? parseInt(monthInput) - 1 : 11; // Convert to 0-based index
            const day = dayInput ? parseInt(dayInput) : 31; // Default to last day

            if (!year) {
                customAlert("Please select a year.");
                return;
            }

            const dobValue = new Date(year, month, day);  // Month is 0-based (0 = Jan), Day is 1-based (1 = 1st day, 0 = last day of previous month)
            let chronologicalAgeAtTimeOfTest;
            try {
                chronologicalAgeAtTimeOfTest = window.calculateAgeAtDate(dobValue, new Date(`${bloodDrawDate}T00:00:00`));
                if (chronologicalAgeAtTimeOfTest < 0) {
                    throw new Error("Invalid date of birth: you cannot be born in the future.");
                }
            } catch (error) {
                customAlert(error.message);
                return;
            }

            // Add age as the first marker value
            markerValues.push(chronologicalAgeAtTimeOfTest);

            // Fill missing biomarker fields on update
            if (isUpdate) {
                const latestBiomarkerSet = athlete.Biomarkers.reduce((latest, current) => {
                    return new Date(current.Date) > new Date(latest.Date) ? current : latest;
                });
                const biomarkerDefaults = {
                    wbc: { val: latestBiomarkerSet.Wbc1000cellsuL, unit: '1' },
                    lymphocyte: { val: latestBiomarkerSet.LymPc, unit: '1' },
                    mcv: { val: latestBiomarkerSet.McvFL, unit: '1' },
                    rcdw: { val: latestBiomarkerSet.RdwPc, unit: '1' },
                    albumin: { val: latestBiomarkerSet.AlbGL, unit: '1' },
                    ap: { val: latestBiomarkerSet.AlpUL, unit: '1' },
                    creatinine: { val: latestBiomarkerSet.CreatUmolL, unit: '1' },
                    glucose: { val: latestBiomarkerSet.GluMmolL, unit: '1' },
                    crp: { val: latestBiomarkerSet.CrpMgL, unit: '10' }
                };

                Object.entries(biomarkerDefaults).forEach(([id, { val, unit }]) => {
                    const input = document.getElementById(id);
                    if (!input.value) {
                        input.value = val;
                        document.getElementById(id + 'Unit').value = unit;
                    }
                });
            }

            correctCorrectableUnits();

            // Get biomarker values
            for (let i = 1; i < window.PhenoAge.biomarkers.length; i++) {
                const biomarker = window.PhenoAge.biomarkers[i];
                const valueElement = document.getElementById(biomarker.id);
                const unitElement = document.getElementById(biomarker.id + 'Unit');
                const rawValue = window.PhenoAge.parseInput(valueElement.value);
                const unitConversion = parseFloat(unitElement.value);
                const unitText = unitElement.options[unitElement.selectedIndex].text;

                // Check for invalid input
                if (isNaN(rawValue)) {
                    expandFieldCard(biomarker.id);
                    customAlert(`Please enter a valid value for ${biomarker.name}.`).then(() => {
                        document.getElementById('continueButton').classList.remove('show');
                        updateCalculateButton();
                    });
                    return;
                }

                // Apply unit conversion
                let adjustedValue = rawValue / unitConversion;

                // Special handling for CRP: PhenoAge expects ln(CRP in mg/dL) per Levine Table 1. Stored canonical is mg/L; convert by dividing by 10.
                if (biomarker.id === 'crp') {
                    const crpMgL = (rawValue / unitConversion) * 10;
                    adjustedValue = Math.log(crpMgL / 10);
                }

                // Special handling for lymphocytes
                if (biomarker.id === 'lymphocyte' && unitText !== '%') {
                    const wbcValueElement = document.getElementById('wbc');
                    const wbcUnitElement = document.getElementById('wbcUnit');
                    const wbcRawValue = window.PhenoAge.parseInput(wbcValueElement.value);
                    const wbcUnitConversion = parseFloat(wbcUnitElement.value);

                    if (isNaN(wbcRawValue)) {
                        expandFieldCard('wbc');
                        expandFieldCard('lymphocyte');
                        customAlert("Please provide white blood cell count to calculate lymphocyte percentage.").then(() => {
                            document.getElementById('continueButton').classList.remove('show');
                            updateCalculateButton();
                        });
                        return;
                    }

                    const wbcAdjustedValue = wbcRawValue / wbcUnitConversion;
                    adjustedValue = (adjustedValue / wbcAdjustedValue) * 100;
                }

                markerValues.push(adjustedValue);
            }

            // Calculate PhenoAge using the helper function
            const phenoAge = window.PhenoAge.calculatePhenoAge(markerValues);

            // Display the result
            const resultElement = document.getElementById('phenoAgeResult');
            const ensureCorrectInputSuggestion = document.getElementById('ensureCorrectInputSuggestion');
            const validAgeInput = document.getElementById('validAgeInput');

            // Check if the result is not infinite
            if (!isFinite(phenoAge)) {
                resultElement.classList.add('show');
                ensureCorrectInputSuggestion.style.display = 'block';
                validAgeInput.style.display = 'none';
                return;
            }
            else {
                ensureCorrectInputSuggestion.style.display = 'none';
                validAgeInput.style.display = 'block';
            }

            // Setting up the animated counter effect
            const animatedAgeElement = document.getElementById('animatedAge');
            const yearsTextElement = document.getElementById('yearsText');
            let displayAge = 0;
            
            // Determine age category for color coding
            const ageDiff = phenoAge - chronologicalAgeAtTimeOfTest;
            const ageCategory = ageDiff < -2 ? 'age-excellent' : (ageDiff < 0 ? 'age-good' : 'age-average');
            
            if (isFirstTimeAnimation) {
                // Set the flag to false after the first run
                isFirstTimeAnimation = false;

                setTimeout(() => {
                    // Trigger the card reveal animation
                    resultElement.classList.add('show');
                    
                    // Calculate animation speed - smooth and not too fast
                    const animationDuration = Math.min(Math.max(phenoAge * 25, 800), 2500);
                    const stepCount = Math.ceil(phenoAge);
                    const stepInterval = Math.max(animationDuration / stepCount, 15);
                    const incrementPerStep = phenoAge / stepCount;
                    
                    let currentStep = 0;
                    const ageCounter = setInterval(() => {
                        currentStep++;
                        displayAge = Math.min(incrementPerStep * currentStep, phenoAge);
                        animatedAgeElement.innerText = displayAge.toFixed(1);
                        
                        // Subtle pulse effect during counting (only every few steps to avoid jank)
                        if (currentStep % 3 === 0) {
                            animatedAgeElement.classList.add('counting');
                            setTimeout(() => {
                                animatedAgeElement.classList.remove('counting');
                            }, 250);
                        }
                        
                        if (displayAge >= phenoAge) {
                            clearInterval(ageCounter);
                            
                            // Set final age value with decimal precision
                            animatedAgeElement.innerText = phenoAge.toFixed(1);
                            
                            // Remove any existing age category classes before adding the new one
                            animatedAgeElement.classList.remove('age-excellent', 'age-good', 'age-average');
                            
                            // Add color category and final reveal animation
                            animatedAgeElement.classList.add(ageCategory);
                            animatedAgeElement.classList.add('final-reveal');
                            
                            // Remove final reveal class after animation completes
                            setTimeout(() => {
                                animatedAgeElement.classList.remove('final-reveal');
                            }, 800);
                            
                            // Update years text with year reduction/increase and celebratory emoji if bio age is better
                            const yearsDelta = ageDiff < 0 ? `- ${Math.abs(ageDiff).toFixed(1)} ` : (ageDiff > 0 ? `+ ${ageDiff.toFixed(1)} ` : '');
                            yearsTextElement.innerHTML = yearsDelta + (ageDiff < 0 ? `years üöÄ` : `years`);

                            // Show the Next button after a brief delay
                            setTimeout(() => {
                                document.getElementById('continueButton').classList.add('show');
                                updateCalculateButton();
                            }, 500);
                        }
                    }, stepInterval);
                }, 150);
            } else {
                setTimeout(() => {
                    // Trigger the card reveal animation
                    resultElement.classList.add('show');
                    
                    // Direct update without animation
                    animatedAgeElement.innerText = phenoAge.toFixed(1);
                    
                    // Remove any existing age category classes before adding the new one
                    animatedAgeElement.classList.remove('age-excellent', 'age-good', 'age-average');
                    animatedAgeElement.classList.add(ageCategory);
                    
                    const yearsDelta = ageDiff < 0 ? `- ${Math.abs(ageDiff).toFixed(1)} ` : (ageDiff > 0 ? `+ ${ageDiff.toFixed(1)} ` : '');
                    yearsTextElement.innerHTML = yearsDelta + (ageDiff < 0 ? `years üöÄ` : `years`);

                    // Show the Next button
                    setTimeout(() => {
                        document.getElementById('continueButton').classList.add('show');
                        updateCalculateButton();
                    }, 400);
                }, 100);
            }

            isResultCalculated = true;
        }

        // Mapping language or country codes to unit preferences
        const unitPreferences = {
            US: {
                albuminUnit: '0.1',       // g/dL
                creatinineUnit: '0.0113', // mg/dL
                glucoseUnit: '18.016',    // mg/dL
                crpUnit: '10',             // mg/L
                lymphocyteUnit: '1',      // %
                mcvUnit: '1',             // fL
                rcdwUnit: '1',            // %
                apUnit: '1',              // U/L
                wbcUnit: '1'              // 1000 cells/ŒºL
            },
            GB: {
                albuminUnit: '1',         // g/L (SI unit, common in the UK)
                creatinineUnit: '1',      // ¬µmol/L
                glucoseUnit: '1',         // mmol/L
                crpUnit: '10',            // mg/L
                lymphocyteUnit: '1',      // %
                mcvUnit: '1',             // fL
                rcdwUnit: '1',            // %
                apUnit: '1',              // U/L
                wbcUnit: '1'              // 1000 cells/ŒºL
            },
            HU: {
                albuminUnit: '1',         // g/L
                creatinineUnit: '1',      // ¬µmol/L
                glucoseUnit: '1',         // mmol/L
                crpUnit: '10',            // mg/L
                lymphocyteUnit: '1',      // %
                mcvUnit: '1',             // fL
                rcdwUnit: '1',            // %
                apUnit: '1',              // U/L
                wbcUnit: '1'              // 1000 cells/ŒºL
            },
            AU: {
                albuminUnit: '1',         // g/L
                creatinineUnit: '1',      // ¬µmol/L
                glucoseUnit: '1',         // mmol/L
                crpUnit: '10',            // mg/L
                lymphocyteUnit: '1',      // %
                mcvUnit: '1',             // fL
                rcdwUnit: '1',            // %
                apUnit: '1',              // U/L
                wbcUnit: '1'              // 1000 cells/ŒºL
            },
            DE: {
                albuminUnit: '1',         // g/L
                creatinineUnit: '1',      // ¬µmol/L
                glucoseUnit: '1',         // mmol/L
                crpUnit: '10',            // mg/L
                lymphocyteUnit: '1',      // %
                mcvUnit: '1',             // fL
                rcdwUnit: '1',            // %
                apUnit: '1',              // U/L
                wbcUnit: '1'              // 1000 cells/ŒºL
            },
            FR: {
                albuminUnit: '1',         // g/L
                creatinineUnit: '1',      // ¬µmol/L
                glucoseUnit: '1',         // mmol/L
                crpUnit: '10',            // mg/L
                lymphocyteUnit: '1',      // %
                mcvUnit: '1',             // fL
                rcdwUnit: '1',            // %
                apUnit: '1',              // U/L
                wbcUnit: '1'              // 1000 cells/ŒºL
            },
            ES: {
                albuminUnit: '1',         // g/L
                creatinineUnit: '1',      // ¬µmol/L
                glucoseUnit: '1',         // mmol/L
                crpUnit: '10',            // mg/L
                lymphocyteUnit: '1',      // %
                mcvUnit: '1',             // fL
                rcdwUnit: '1',            // %
                apUnit: '1',              // U/L
                wbcUnit: '1'              // 1000 cells/ŒºL
            },
            BR: {
                albuminUnit: '1',         // g/L
                creatinineUnit: '1',      // ¬µmol/L
                glucoseUnit: '1',         // mmol/L
                crpUnit: '10',            // mg/L
                lymphocyteUnit: '1',      // %
                mcvUnit: '1',             // fL
                rcdwUnit: '1',            // %
                apUnit: '1',              // U/L
                wbcUnit: '1'              // 1000 cells/ŒºL
            },
            HN: {
                albuminUnit: '0.1',       // g/dL
                creatinineUnit: '0.0113', // mg/dL
                glucoseUnit: '18.016',    // mg/dL
                crpUnit: '10',            // mg/L
                lymphocyteUnit: '1',      // %
                mcvUnit: '1',             // fL
                rcdwUnit: '1',            // %
                apUnit: '1',              // U/L
                wbcUnit: '1'              // 1000 cells/ŒºL
            },
            SG: {
                albuminUnit: '1',         // g/L
                creatinineUnit: '1',      // ¬µmol/L
                glucoseUnit: '1',         // mmol/L
                crpUnit: '10',            // mg/L
                lymphocyteUnit: '1',      // %
                mcvUnit: '1',             // fL
                rcdwUnit: '1',            // %
                apUnit: '1',              // U/L
                wbcUnit: '1'              // 1000 cells/ŒºL
            },
            CZ: {
                albuminUnit: '1',         // g/L
                creatinineUnit: '1',      // ¬µmol/L
                glucoseUnit: '1',         // mmol/L
                crpUnit: '10',            // mg/L
                lymphocyteUnit: '1',      // %
                mcvUnit: '1',             // fL
                rcdwUnit: '1',            // %
                apUnit: '1',              // U/L
                wbcUnit: '1'              // 1000 cells/ŒºL
            },
            CA: {
                albuminUnit: '1',         // g/L
                creatinineUnit: '1',      // ¬µmol/L
                glucoseUnit: '1',         // mmol/L
                crpUnit: '10',            // mg/L
                lymphocyteUnit: '1',      // %
                mcvUnit: '1',             // fL
                rcdwUnit: '1',            // %
                apUnit: '1',              // U/L
                wbcUnit: '1'              // 1000 cells/ŒºL
            },
            default: {
                albuminUnit: '1',         // g/L
                creatinineUnit: '1',      // ¬µmol/L
                glucoseUnit: '1',         // mmol/L
                crpUnit: '10',            // mg/L
                lymphocyteUnit: '1',      // %
                mcvUnit: '1',             // fL
                rcdwUnit: '1',            // %
                apUnit: '1',              // U/L
                wbcUnit: '1'              // 1000 cells/ŒºL
            }
        };

        // --- LWC step state ---
        let lwcCurrentStep = 1;
        function lwcSetStep(step) {
            lwcCurrentStep = step;
            const s1 = document.getElementById('lwc-step-1');
            const s2 = document.getElementById('lwc-step-2');
            const d1 = document.getElementById('lwcDot1');
            const d2 = document.getElementById('lwcDot2');

            [s1, s2].forEach(s => {
                if (!s) return;
                s.classList.remove('lwc-step--active', 'lwc-step--visible');
                s.style.pointerEvents = 'none';
            });

            const active = step === 1 ? s1 : s2;
            if (active) {
                active.classList.add('lwc-step--active');
                // next tick to allow transition
                requestAnimationFrame(() => {
                    active.classList.add('lwc-step--visible');
                    active.style.pointerEvents = 'auto';

                    // ensure any pre-expanded biomarker cards get correct heights
                    // once the step is actually visible (covers fake=1 prefill case)
                    if (step === 2) {
                        recalcOpenBiomarkerHeightsLwc();
                        // run again on next tick to catch late layout/ fonts
                        setTimeout(recalcOpenBiomarkerHeightsLwc, 60);
                    }
                });
            }

            if (d1 && d2) {
                d1.classList.toggle('lwc-dot--on', step === 1);
                d2.classList.toggle('lwc-dot--on', step === 2);

                d1.setAttribute('aria-disabled', step === 1 ? 'true' : 'false');
                d2.setAttribute('aria-disabled', step === 2 ? 'true' : 'false');

                d1.tabIndex = step === 1 ? -1 : 0;
                d2.tabIndex = step === 2 ? -1 : 0;
            }


            // focus niceties
            if (step === 1) {
                const y = document.getElementById('dob-year');
                if (y) y.focus();
            } else {
                const firstOpen = document.querySelector('#lwc-step-2 .biomarker-card input, #lwc-step-2 input, #lwc-step-2 select');
                if (firstOpen) firstOpen.focus();
            }
        }


        function recalcOpenBiomarkerHeightsLwc() {
            document
                .querySelectorAll('.biomarker-card.active .biomarker-card-content')
                .forEach(content => {
                    // remove any inline maxHeight to measure natural size
                    content.style.maxHeight = 'none';
                    const full = content.scrollHeight;
                    // re-apply the correct height so transition rules remain intact
                    content.style.maxHeight = full + 'px';
                    // make sure vertical padding is present for visible cards
                    content.style.paddingTop = '0.75rem';
                    content.style.paddingBottom = '0.75rem';
                });
        }

        function lwcValidateStep1() {
            // validate DOB year + blood draw date (reuse existing validation)
            const yearVal = document.getElementById('dob-year').value;
            if (!yearVal) {
                customAlert('Please select your birth year.');
                return false;
            }
            const bd = getValidatedBloodDrawDate();
            if (!bd) return false;
            return true;
        }


        document.addEventListener('DOMContentLoaded', function () {
            // Step navigation buttons
            const toStep2Btn = document.getElementById('lwcToStep2Btn');
            const toStep1Btn = document.getElementById('lwcToStep1Btn');

            if (toStep2Btn) {
                toStep2Btn.addEventListener('click', () => {
                    if (!lwcValidateStep1()) return;
                    lwcSetStep(2);
                });
            }
            if (toStep1Btn) {
                toStep1Btn.addEventListener('click', () => {
                    try { sessionStorage.setItem('lwcStep', '1'); } catch (e) {}
                    lwcSetStep(1);
                });
            }

            // Make wizard dots clickable (desktop) and keyboard accessible
            const dot1 = document.getElementById('lwcDot1');
            const dot2 = document.getElementById('lwcDot2');

            function activateDot1() { lwcSetStep(1); }
            function activateDot2() { if (lwcValidateStep1()) lwcSetStep(2); }

            if (dot1) {
                dot1.addEventListener('click', activateDot1);
                dot1.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); activateDot1(); }
                });
            }
            if (dot2) {
                dot2.addEventListener('click', activateDot2);
                dot2.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); activateDot2(); }
                });
            }

            // Back in .options-container (result section) always navigates away via onclick goBackOrHome();
            // Step-2 Back (lwcToStep1Btn) goes to step 1 like the prev green dot.

            const unitSelects = document.querySelectorAll('.input-group select');
            let maxWidth = 0;

            unitSelects.forEach(select => {
                // Temporarily add the select to the body to calculate its full width
                const tempDiv = document.createElement('div');
                tempDiv.style.position = 'absolute';
                tempDiv.style.visibility = 'hidden';
                tempDiv.appendChild(select.cloneNode(true));
                document.body.appendChild(tempDiv);

                // Update maxWidth if this select's width is larger
                maxWidth = Math.max(maxWidth, tempDiv.clientWidth + 20);
                document.body.removeChild(tempDiv);
            });

            // Set the maxWidth as the min-width for each unit select
            unitSelects.forEach(select => {
                select.style.minWidth = `${maxWidth}px`;
            });

            const yearSelect = document.getElementById('dob-year');
            const currentYear = new Date().getFullYear();

            for (let year = currentYear; year >= 1908; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }

            updateDays(); // Added line

            // Apply preferences on page load
            applyLanguagePreferences();

            if (isFake) {
                fillFakeData();
            }

            if (isUpdate) {
                hideMainProgress();

                document.getElementById('mainPageTitleH2').innerHTML = athlete.Name;
                document.getElementById('mainInstructions').innerHTML = 'Submit your latest test results. All fields are required and must be from the same day.';

                // Fill out the date of birth because we'll need it for calculations, but hide it as well so the user doesn't wanna change that.
                document.getElementById('dob-year').value = athlete.DateOfBirth.Year;
                document.getElementById('dob-month').value = athlete.DateOfBirth.Month;
                document.getElementById('dob-day').value = athlete.DateOfBirth.Day;
                document.getElementById('dobFieldset').style.display = 'none';

                // Disable built-in HTML5 required checks in update mode
                document.getElementById('phenoAgeForm').setAttribute('novalidate', '');

                // Scroll the heading into view
                document.querySelector('h1').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            else {
                updateMainProgress(2);
            }

            // Initialize collapsability based on current values (handles programmatic fills)
            ['wbc', 'lymphocyte', 'mcv', 'rcdw', 'albumin', 'ap', 'creatinine', 'glucose', 'crp']
                .forEach(fieldId => {
                    document.getElementById(fieldId).dispatchEvent(new Event('input'));
                });
            // Also honor CRP-negative checkbox state
            document.getElementById('crp-negative').dispatchEvent(new Event('change'));

            if (isUpdate) {
                // any card that's .active right now came from code, not the user ‚Äî
                // so hide its toggle-icon
                document
                    .querySelectorAll('.biomarker-card.active .toggle-icon')
                    .forEach(icon => icon.style.display = 'none');
            }

            updateModeFormInitializerUnique();

            lwcSetStep(1);
        });

        function updateModeFormInitializerUnique() {
            if (!isUpdate) return;

            if (bloodDrawDateInput) {
                // In update mode, default the blood draw date to today instead of leaving it blank
                const todayLocal = new Date();
                todayLocal.setHours(0, 0, 0, 0);
                const y = todayLocal.getFullYear();
                const m = String(todayLocal.getMonth() + 1).padStart(2, '0');
                const d = String(todayLocal.getDate()).padStart(2, '0');
                bloodDrawDateInput.value = `${y}-${m}-${d}`;
            }


            const idMapUnique = {
                Wbc1000cellsuL: 'wbc',
                LymPc: 'lymphocyte',
                McvFL: 'mcv',
                RdwPc: 'rcdw',
                AlbGL: 'albumin',
                AlpUL: 'ap',
                CreatUmolL: 'creatinine',
                GluMmolL: 'glucose',
                CrpMgL: 'crp'
            };

            Object.values(idMapUnique).forEach(bioId => {
                document.getElementById(bioId).value = '';
            });

            // collapse every card
            document.querySelectorAll('.biomarker-card.active').forEach(card => {
                const hdr = card.querySelector('.biomarker-card-header');
                const icn = hdr.querySelector('.toggle-icon');
                const cnt = card.querySelector('.biomarker-card-content');
                card.classList.remove('active');
                hdr.setAttribute('aria-expanded', 'false');
                icn.style.display = '';
                cnt.style.maxHeight = '0';
                cnt.style.paddingTop = '0';
                cnt.style.paddingBottom = '0';
            });

            // cos this shitty function wiped it all
            if (isFake) {
                fillFakeData();
            }

            // refill only saved biomarkers
            const stored = JSON.parse(sessionStorage.getItem('biomarkerData'));
            const entry = stored?.Biomarkers?.[0];
            if (entry) {
                if (bloodDrawDateInput) {
                    bloodDrawDateInput.value = entry.Date || '';
                }
                Object.keys(entry).forEach(prop => {
                    const id = idMapUnique[prop];
                    if (id) {
                        document.getElementById(id).value = entry[prop];
                        expandFieldCard(id);
                    }
                });
                // hide toggle icons on expanded cards
                document.querySelectorAll('.biomarker-card.active .toggle-icon')
                    .forEach(i => i.style.display = 'none');
            }
        }

        window.addEventListener('pageshow', updateModeFormInitializerUnique);

        // Detect and apply preferences based on language
        function applyLanguagePreferences() {
            const language = navigator.language || 'default'; // e.g., 'en-US'
            const countryMatch = language.match(/[-_](\w{2})$/); // Extract country code)
            const countryCode = countryMatch ? countryMatch[1].toUpperCase() : '';

            const preferences = unitPreferences[countryCode] || unitPreferences.default;

            // Apply preferences to unit select elements
            for (const [unitId, unitValue] of Object.entries(preferences)) {
                const unitSelect = document.getElementById(unitId);
                if (unitSelect) {
                    unitSelect.value = unitValue;
                }
            }
        }

        function proceedToNextPage() {
            if (isUpdate && touchedBiomarkers.size === 0) {
                customAlert('üò± No new biomarker data entered! Cannot proceed!');
                return;
            }

            const yearInput = document.getElementById('dob-year').value;
            const monthInput = document.getElementById('dob-month').value;
            const dayInput = document.getElementById('dob-day').value;

            const bloodDrawDate = getValidatedBloodDrawDate();
            if (!bloodDrawDate) {
                return;
            }

            const year = yearInput ? parseInt(yearInput) : null;
            const month = monthInput ? parseInt(monthInput) - 1 : 11; // Convert to 0-based index
            const day = dayInput ? parseInt(dayInput) : 31; // Default to last day

            // Collect only biomarkers the user actually touched
            const entry = {
                Date: bloodDrawDate
            };
            // only assign if the user actually touched that field:
            if (touchedBiomarkers.has('wbc')) {
                entry.Wbc1000cellsuL = parseFloat((parseFloat(document.getElementById('wbc').value) / parseFloat(document.getElementById('wbcUnit').value)).toFixed(2));
            }
            if (touchedBiomarkers.has('lymphocyte')) {
                const lymphRawValue = parseFloat(document.getElementById('lymphocyte').value);
                const lymphUnitElement = document.getElementById('lymphocyteUnit');
                const lymphUnitText = lymphUnitElement.options[lymphUnitElement.selectedIndex].text;
                const isPercentageUnit = lymphUnitText === '%';
                
                let lymphValueToStore = lymphRawValue;
                
                if (!isPercentageUnit) {
                    const wbcValueElement = document.getElementById('wbc');
                    const wbcUnitElement = document.getElementById('wbcUnit');
                    const wbcRawValue = window.PhenoAge.parseInput(wbcValueElement.value);
                    const wbcUnitConversion = parseFloat(wbcUnitElement.value);
                    
                    if (!isNaN(wbcRawValue)) {
                        const wbcAdjustedValue = wbcRawValue / wbcUnitConversion;
                        const lymphAdjustedValue = lymphRawValue / parseFloat(lymphUnitElement.value);
                        lymphValueToStore = (lymphAdjustedValue / wbcAdjustedValue) * 100;
                    }
                }
                
                entry.LymPc = parseFloat(lymphValueToStore.toFixed(2));
            }
            if (touchedBiomarkers.has('mcv')) {
                entry.McvFL = parseFloat(document.getElementById('mcv').value);
            }
            if (touchedBiomarkers.has('rcdw')) {
                entry.RdwPc = parseFloat(document.getElementById('rcdw').value);
            }
            if (touchedBiomarkers.has('albumin')) {
                entry.AlbGL = parseFloat((parseFloat(document.getElementById('albumin').value)
                    / parseFloat(document.getElementById('albuminUnit').value)).toFixed(2));
            }
            if (touchedBiomarkers.has('ap')) {
                entry.AlpUL = parseFloat((parseFloat(document.getElementById('ap').value) / parseFloat(document.getElementById('apUnit').value)).toFixed(2));
            }
            if (touchedBiomarkers.has('creatinine')) {
                entry.CreatUmolL = parseFloat((parseFloat(document.getElementById('creatinine').value)
                    / parseFloat(document.getElementById('creatinineUnit').value)).toFixed(2));
            }
            if (touchedBiomarkers.has('glucose')) {
                entry.GluMmolL = parseFloat((parseFloat(document.getElementById('glucose').value)
                    / parseFloat(document.getElementById('glucoseUnit').value)).toFixed(2));
            }
            if (touchedBiomarkers.has('crp')) {
                entry.CrpMgL = parseFloat(((parseFloat(document.getElementById('crp').value)
                    / parseFloat(document.getElementById('crpUnit').value)) * 10).toFixed(2)); // Multiply by 10 because we assigned 10x multiplier for mg/L as the base unit
            }


            const biomarkerData = {
                DateOfBirth: {
                    Year: year,
                    Month: month + 1, // Adjust month to 1-based index
                    Day: day
                },
                Biomarkers: [entry]
            };

            // Store the data in sessionStorage
            const chronoAgeAtTimeOfTest = window.calculateAgeAtDate(new Date(year, month, day), new Date(`${bloodDrawDate}T00:00:00`));
            const phenoAge = parseFloat(document.getElementById('animatedAge').innerText);
            const chronoPhenoDifference = phenoAge - chronoAgeAtTimeOfTest;
            sessionStorage.setItem('chronoPhenoDifference', chronoPhenoDifference.toFixed(2));

            sessionStorage.setItem('biomarkerData', JSON.stringify(biomarkerData));

             if (isUpdate) {
                 window.location.href = '/play/proof-upload.html';
             } else {
                 window.location.href = '/onboarding/convergence.html';
             }
        }
        function fillFakeData() {
            // Aligned with bortz-age.html fake data: DOB and blood draw so age at test = 60
            document.getElementById('dob-year').value = 1966;
            document.getElementById('dob-month').value = 2;
            if (typeof updateDays === 'function') updateDays();
            document.getElementById('dob-day').value = 2;

            if (bloodDrawDateInput) {
                bloodDrawDateInput.value = '2026-02-02';
            }

            // Same fake biomarker set as bortz-age.html: WBC 6.54, lymphocyte 28.6%, mcv 92, rdw 13.4, albumin 45, ap 83, creatinine 72, glucose 5, crp 1.35
            document.getElementById('wbc').value = 6.54;
            document.getElementById('wbcUnit').value = 1;

            document.getElementById('lymphocyte').value = 28.6;
            document.getElementById('lymphocyteUnit').value = 1;

            document.getElementById('mcv').value = 92;
            document.getElementById('mcvUnit').value = 1;

            document.getElementById('rcdw').value = 13.4;
            document.getElementById('rcdwUnit').value = 1;

            document.getElementById('albumin').value = 45;
            document.getElementById('albuminUnit').value = 1;

            document.getElementById('ap').value = 83;
            document.getElementById('apUnit').value = 1;

            document.getElementById('creatinine').value = 72;
            document.getElementById('creatinineUnit').value = 1;

            document.getElementById('glucose').value = 5;
            document.getElementById('glucoseUnit').value = 1;

            document.getElementById('crp').value = 1.35;
            document.getElementById('crpUnit').value = 10;


            // mark all biomarkers as touched in fake mode and expand them
            ['wbc', 'lymphocyte', 'mcv', 'rcdw', 'albumin', 'ap', 'creatinine', 'glucose', 'crp']
                .forEach(id => {
                    touchedBiomarkers.add(id);
                    expandFieldCard(id);
                });

        }

        function updateDays() {
            const year = parseInt(document.getElementById('dob-year').value);
            const month = parseInt(document.getElementById('dob-month').value);
            const daySelect = document.getElementById('dob-day');

            // Clear existing options
            daySelect.innerHTML = '<option value="" disabled selected>Select day</option>';

            if (month) {
                const monthIndex = month - 1; // Adjust to 0-based index
                const tempYear = year || 2001; // Use selected year or default
                const lastDay = new Date(tempYear, month, 0).getDate(); // Month is 0-based (0 = Jan), Day is 1-based (1 = 1st day, 0 = last day of previous month)
                for (let day = 1; day <= lastDay; day++) {
                    const option = document.createElement('option');
                    option.value = day;
                    option.textContent = day;
                    daySelect.appendChild(option);
                }
                daySelect.value = lastDay;
            } else {
                // Default to 31 days
                for (let day = 1; day <= 31; day++) {
                    const option = document.createElement('option');
                    option.value = day;
                    option.textContent = day;
                    daySelect.appendChild(option);
                }
                daySelect.value = 31;
            }
        }

        document.getElementById('dob-year').addEventListener('change', updateDays);
        document.getElementById('dob-month').addEventListener('change', updateDays);

        function toggleCRPInput() {
            const crpInput = document.getElementById('crp');
            const crpUnit = document.getElementById('crpUnit');
            const crpNegativeCheckbox = document.getElementById('crp-negative');

            if (crpNegativeCheckbox.checked) {
                crpInput.value = 1; // Set value to 1
                crpUnit.value = 10; // Set unit to mg/L
                crpInput.disabled = true; // Disable input field
                crpUnit.disabled = true; // Disable unit selector
                touchedBiomarkers.add('crp');
            } else {
                crpInput.disabled = false; // Enable input field
                crpUnit.disabled = false; // Enable unit selector
            }

            calculateResultIfResultAlreadyCalculated();

            const card = document.getElementById('crp').closest('.biomarker-card');
            const crpHeaderField = card.querySelector('.biomarker-card-header');
            const crpIconField = crpHeaderField.querySelector('.toggle-icon');
            if (crpNegativeCheckbox.checked || document.getElementById('crp').value.trim() !== '') {
                crpHeaderField.style.pointerEvents = 'none';
                crpIconField.style.display = 'none';

                expandFieldCard(card);
            } else if (isUpdate) {
                crpHeaderField.style.pointerEvents = '';
                crpIconField.style.display = '';
            }
        }

        // Hide month/day & privacy note when age < 18
        function checkMinor() {
            const y = parseInt(document.getElementById('dob-year').value, 10);
            if (!y) return;
            const m = parseInt(document.getElementById('dob-month').value, 10) - 1;
            const dVal = document.getElementById('dob-day').value;
            const d = dVal ? parseInt(dVal, 10) : 31;

            const today = new Date();
            let age = today.getFullYear() - y;
            const mm = today.getMonth() - m;
            if (mm < 0 || (mm === 0 && today.getDate() < d)) age--;

            const hide = age < 18;
            if (hide) {
                document.getElementById('dob-month').value = '12';
                document.getElementById('dob-day').value = '31';
            }
            ['dob-month-label', 'dob-month', 'dob-day-label', 'dob-day', 'privacyNote']
                .forEach(id => {
                    const el = document.getElementById(id);
                    el.style.display = hide ? 'none' : '';
                });
        }

        // Re-run on any DOB change & on page load
        ['dob-year', 'dob-month', 'dob-day']
            .forEach(id => document.getElementById(id)
                .addEventListener('change', checkMinor)
            );
        document.addEventListener('DOMContentLoaded', checkMinor);

        // Wire up all biomarker‚Äêcard headers
        document.querySelectorAll('.biomarker-card-header').forEach(header => {
            header.addEventListener('click', function handler() {
                const card = header.parentNode;
                const content = card.querySelector('.biomarker-card-content');
                const icon = header.querySelector('.toggle-icon');

                if (!isUpdate) {
                    if (!card.classList.contains('active')) {
                        card.classList.add('active');
                        header.setAttribute('aria-expanded', 'true');

                        content.style.maxHeight = content.scrollHeight + 'px';
                        content.style.paddingTop = '0.75rem';
                        content.style.paddingBottom = '0.75rem';
                        header.style.pointerEvents = 'none';
                        header.style.cursor = 'default';
                        icon.style.display = 'none';
                    }
                    return;
                }

                // update mode: full toggle with icon swap
                const isActive = card.classList.toggle('active');
                header.setAttribute('aria-expanded', isActive);

                icon.textContent = isActive ? '‚àí' : '+';
                icon.style.display = '';
                if (isActive) {
                    content.style.maxHeight = content.scrollHeight + 'px';
                    content.style.paddingTop = '0.75rem';
                    content.style.paddingBottom = '0.75rem';
                } else {
                    content.style.maxHeight = '0';
                    content.style.paddingTop = '0';
                    content.style.paddingBottom = '0';
                }
            });
        });

        /**
         * Expands the biomarker card containing the given input field.
         *
         * @param {string|HTMLElement} field - The ID of the input field, or the field element itself.
         */
        function expandFieldCard(field) {
            // Get the input element
            const input = typeof field === 'string'
                ? document.getElementById(field)
                : field;
            if (!input) return;

            // Find its enclosing card
            const card = input.closest('.biomarker-card');
            if (!card) return;

            // If not already expanded, open it
            if (!card.classList.contains('active')) {
                const header = card.querySelector('.biomarker-card-header');

                card.classList.add('active');
                if (header) header.setAttribute('aria-expanded', 'true');

                // Animate the content area open
                const content = card.querySelector('.biomarker-card-content');
                content.style.maxHeight = content.scrollHeight + 'px';
                content.style.paddingTop = '0.75rem';
                content.style.paddingBottom = '0.75rem';

                // Handle the toggle icon and header behavior
                const icon = card.querySelector('.toggle-icon');

                if (!isUpdate) {
                    // In non-update mode: hide the icon and disable further clicks
                    if (icon) icon.style.display = 'none';
                    if (header) {
                        header.style.pointerEvents = 'none';
                        header.style.cursor = 'default';
                    }
                } else {
                    // In update mode: show a minus icon
                    if (icon) {
                        icon.textContent = '‚àí';
                        icon.style.display = '';

                        if (touchedBiomarkers.has(input.id)) {
                            icon.style.display = 'none';
                        }
                    }
                }
            }
        }

        // Let the browser show its validation bubbles, but expand the card first
        const form = document.getElementById('phenoAgeForm');

        form.addEventListener('invalid', e => {
            // invalid fires during the capture phase before the bubble appears
            expandFieldCard(e.target);
        }, true);

        // On submit, defer to browser validation; only when the form is fully valid do we preventDefault and run calculateResult()
        form.addEventListener('submit', function (e) {
            // prevent normal submit
            e.preventDefault();

            // if we're on Step 1, validate then advance ‚Äî no calculation yet
            if (lwcCurrentStep === 1) {
                if (lwcValidateStep1()) lwcSetStep(2);
                return;
            }

            // calculate
            calculateResult();

            // let browser show validation bubbles (invalid events expand cards)
            if (!this.reportValidity()) {
                return;
            }

            // all valid ‚Üí scroll the Calculate button into view
            const calculateButton = this.querySelector('button[type="submit"]');
            if (calculateButton) {
                calculateButton.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    </script>
</body>
</html>